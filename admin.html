<!-- thai-json-generator-final-v3.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thai Learning App - Exact JSON Structure Generator</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #60a5fa;
            --primary-dark: #1d4ed8;
            --bg: #ffffff;
            --text: #1a1a1a;
            --card: #f8fafc;
            --border: #e2e8f0;
            --success: #059669;
            --warning: #d97706;
            --error: #dc2626;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
        }

        .header small {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Row 1: Configuration and Languages side by side */
        .config-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .config-panel,
        .languages-panel {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            height: fit-content;
        }

        /* Row 2: Thai Input */
        .input-row {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        /* Row 3: Preview */
        .preview-row {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .data-type-selector {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .type-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .type-btn.active {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.1);
        }

        .type-btn .material-icons {
            font-size: 32px;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .language-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .lang-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
        }

        .lang-checkbox.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .lang-checkbox.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--bg);
        }

        .instruction-box {
            background: rgba(37, 99, 235, 0.05);
            border-left: 4px solid var(--primary);
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            font-size: 0.95rem;
        }

        .instruction-box kbd {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 0.9rem;
        }

        /* Extra large font for Thai input */
        #thaiInput {
            width: 100%;
            min-height: 200px;
            padding: 20px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: 'Noto Sans Thai', 'Courier New', monospace;
            font-size: 1.8rem;
            line-height: 2.2rem;
            background: var(--bg);
            color: var(--text);
            resize: vertical;
        }

        #thaiInput:focus {
            border-color: var(--primary);
            outline: none;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            padding: 10px;
            background: var(--bg);
            border-radius: 6px;
            font-size: 0.95rem;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            flex: 2;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            flex: 1;
        }

        .btn-outline:hover {
            background: var(--bg);
            border-color: var(--primary);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-copy {
            background: var(--primary-light);
            color: white;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .preview-tabs {
            display: flex;
            gap: 10px;
        }

        .preview-tab {
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            background: var(--bg);
        }

        .preview-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        #structureView {
            max-height: 500px;
            overflow-y: auto;
        }

        .word-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .word-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
        }

        .word-thai {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border);
        }

        .translation-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
        }

        .translation-row input {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg);
        }

        .sentence-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .sentence-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .sentence-thai {
            font-size: 1.2rem;
            color: var(--primary);
            font-weight: 500;
        }

        .word-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 8px;
        }

        .word-chip {
            padding: 8px 12px;
            background: rgba(37, 99, 235, 0.1);
            border-radius: 20px;
            font-size: 0.95rem;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
        }

        .word-chip .word {
            font-weight: 500;
        }

        .word-chip .translations {
            display: flex;
            gap: 5px;
            margin-top: 3px;
            font-size: 0.8rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .json-output-container {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 5px;
        }

        .json-content {
            color: #d4d4d4;
            font-family: 'Monaco', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .status-badge {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-complete {
            background: var(--success);
        }

        .status-pending {
            background: var(--warning);
        }

        .output-format-info {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(37, 99, 235, 0.05);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-buttons .btn {
            flex: 1;
        }

        .json-viewer {
            max-height: 500px;
            overflow-y: auto;
            background: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Monaco', monospace;
            font-size: 13px;
            color: #d4d4d4;
            white-space: pre-wrap;
        }

        .default-lang-badge {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üìù Thai JSON Generator - Exact Structure</h1>
            <p>Generates JSON matching your app's exact format | <strong>en</strong> and <strong>fa</strong> are default
                translations</p>
        </div>

        <!-- Row 1: Configuration and Languages side by side -->
        <div class="config-row">
            <!-- Configuration Panel -->
            <div class="config-panel">
                <h3>‚öôÔ∏è Configuration</h3>
                <div class="data-type-selector">
                    <div class="type-btn active" id="typeWord" onclick="setDataType('word')">
                        <span class="material-icons">grid_view</span>
                        <div>Word List</div>
                        <small>space between words</small>
                    </div>
                    <div class="type-btn" id="typeParagraph" onclick="setDataType('paragraph')">
                        <span class="material-icons">chat</span>
                        <div>Paragraph</div>
                        <small>return between sentences</small>
                    </div>
                </div>
            </div>

            <!-- Languages Panel -->
            <div class="languages-panel">
                <h3>üåê Target Languages <span class="default-lang-badge">en & fa always included</span></h3>
                <div class="language-grid" id="languageGrid"></div>
            </div>
        </div>

        <!-- Row 2: Thai Input -->
        <div class="input-row">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>üìù Enter Thai Text</h3>
                <span id="inputStats" style="font-size: 1.1rem; color: var(--text-secondary);">0 words, 0
                    sentences</span>
            </div>

            <div class="instruction-box" id="instructionBox">
                <span class="material-icons">info</span>
                <span id="instructionText"></span>
            </div>

            <textarea id="thaiInput" placeholder=""></textarea>

            <div class="stats-row">
                <span><span class="material-icons">abc</span> Words: <span id="wordCount">0</span></span>
                <span><span class="material-icons">sentence</span> Sentences: <span id="sentenceCount">0</span></span>
                <span><span class="material-icons">cleaning_services</span> Allowed: Thai, English, /, ., space,
                    return</span>
            </div>

            <div class="button-group">
                <button class="btn btn-outline" onclick="cleanText()">
                    <span class="material-icons">brush</span> Clean
                </button>
                <button class="btn btn-primary" onclick="generatePreview()">
                    <span class="material-icons">auto_awesome</span> Generate
                </button>
            </div>
        </div>

        <!-- Row 3: Preview -->
        <div class="preview-row">
            <div class="preview-header">
                <h3>üëÅÔ∏è Preview & Verify</h3>
                <div class="preview-tabs">
                    <div class="preview-tab active" onclick="switchPreview('structure')">Structure</div>
                    <div class="preview-tab" onclick="switchPreview('json')">JSON</div>
                </div>
            </div>

            <!-- Structure View -->
            <div id="structureView">
                <div id="previewContent" style="color: var(--text-secondary); text-align: center; padding: 40px;">
                    Click Generate to see preview
                </div>
            </div>

            <!-- JSON View -->
            <div id="jsonView" style="display: none;">
                <div class="output-format-info">
                    <span class="material-icons">info</span>
                    <span id="formatDisplay"></span>
                </div>
                <div id="jsonContent" class="json-viewer"></div>

                <!-- Action Buttons (appear after generate) -->
                <div id="actionSection" style="display: none;" class="action-buttons">
                    <button class="btn btn-success" onclick="downloadJSON()">
                        <span class="material-icons">download</span> Download
                    </button>
                    <button class="btn btn-copy" onclick="copyJSON()">
                        <span class="material-icons">content_copy</span> Copy
                    </button>
                </div>
            </div>

            <!-- Translation Status -->
            <div style="margin-top: 15px; display: flex; gap: 20px; justify-content: flex-end;" id="translationStatus">
                <span><span class="status-badge status-complete"></span> Translated</span>
                <span><span class="status-badge status-pending"></span> Pending</span>
            </div>
        </div>
    </div>

    <script>
        // ==================== TRANSLATION API ====================
        const TranslationAPI = {
            cache: JSON.parse(localStorage.getItem('translationCache') || '{}'),

            async translate(text, targetLang) {
                if (!text || text.trim() === '') return '';

                const cacheKey = `${text}_${targetLang}`;
                if (this.cache[cacheKey]) {
                    return this.cache[cacheKey];
                }

                try {
                    const response = await fetch(
                        `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=th|${targetLang}`
                    );
                    const data = await response.json();

                    if (data.responseStatus === 200) {
                        const translation = data.responseData.translatedText;
                        this.cache[cacheKey] = translation;
                        localStorage.setItem('translationCache', JSON.stringify(this.cache));
                        return translation;
                    }
                } catch (error) {
                    console.warn('Translation failed:', error);
                }

                return ''; // Return empty if translation fails
            }
        };

        // ==================== CLEANER ====================
        const Cleaner = {
            clean(text) {
                if (!text) return text;

                let cleaned = text;

                // Remove non-Thai characters except:
                // - English letters (for transliterations)
                // - spaces, newlines
                // - punctuation (.,!?:-'"())
                // - forward slash (/)
                cleaned = cleaned.replace(/[^\u0E00-\u0E7Fa-zA-Z\s\n.,!?:\-'"()\/]/g, '');

                // Fix common PDF artifacts
                cleaned = cleaned
                    .replace(/x/g, '')
                    .replace(/X/g, '')
                    .replace(/[Ô¨ÅÔ¨Ç]/g, match => match === 'Ô¨Å' ? 'fi' : 'fl')
                    .replace(/[‚Äò‚Äô¬¥`]/g, "'")
                    .replace(/[‚Äú‚Äù]/g, '"')
                    .replace(/\s*:\s*/g, ': ')
                    .replace(/[^\S\n]+/g, ' ') // Replace multiple spaces with single space (preserve newlines)
                    .replace(/\s+\./g, '.')
                    .replace(/\s+\,/g, ',')
                    .replace(/^\s+/gm, '')
                    .replace(/\s+$/gm, '');

                return cleaned;
            }
        };

        // ==================== APP STATE ====================
        const AppState = {
            dataType: 'word',
            // Default languages are en and fa - these are always included
            defaultLanguages: ['en', 'fa'],
            languages: [
                { code: 'en', name: 'English', flag: 'üá¨üáß', selected: true, isDefault: true },
                { code: 'fa', name: 'Farsi', flag: 'üáÆüá∑', selected: true, isDefault: true },
                { code: 'ar', name: 'Arabic', flag: 'üá∏üá¶', selected: false, isDefault: false },
                { code: 'zh', name: 'Chinese', flag: 'üá®üá≥', selected: false, isDefault: false },
                { code: 'ja', name: 'Japanese', flag: 'üáØüáµ', selected: false, isDefault: false },
                { code: 'km', name: 'Khmer', flag: 'üá∞üá≠', selected: false, isDefault: false },
                { code: 'bn', name: 'Banderi', flag: 'üáßüá©', selected: false, isDefault: false }
            ],
            words: [],
            sentences: [],
            wordTranslations: {},      // For word list mode
            sentenceTranslations: [],   // For paragraph mode
            wordLevelTranslations: {},  // For individual words in sentences
            generatedContent: null,
            generatedJSONString: ''
        };

        // ==================== INITIALIZATION ====================
        function init() {
            renderLanguageGrid();
            setDataType('word');

            // Set up textarea stats update
            const textarea = document.getElementById('thaiInput');
            textarea.addEventListener('input', updateStats);
        }

        function renderLanguageGrid() {
            const grid = document.getElementById('languageGrid');
            let html = '';

            AppState.languages.forEach(lang => {
                // Disable checkbox for default languages (en and fa)
                const disabled = lang.isDefault ? 'disabled' : '';
                const selected = lang.selected ? 'selected' : '';
                const disabledClass = lang.isDefault ? 'disabled' : '';

                html += `
                    <div class="lang-checkbox ${selected} ${disabledClass}" 
                         onclick="${!lang.isDefault ? `toggleLanguage('${lang.code}')` : ''}">
                        <input type="checkbox" 
                               ${lang.selected ? 'checked' : ''} 
                               ${disabled}
                               onchange="${!lang.isDefault ? `toggleLanguage('${lang.code}')` : ''}"
                               style="width: 16px; height: 16px;">
                        <span>${lang.flag} ${lang.name}</span>
                        ${lang.isDefault ? '<span class="default-lang-badge">default</span>' : ''}
                    </div>
                `;
            });

            grid.innerHTML = html;
        }

        function toggleLanguage(code) {
            const lang = AppState.languages.find(l => l.code === code);
            if (lang && !lang.isDefault) {
                lang.selected = !lang.selected;
                renderLanguageGrid();
            }
        }

        function setDataType(type) {
            AppState.dataType = type;
            document.getElementById('typeWord').classList.remove('active');
            document.getElementById('typeParagraph').classList.remove('active');
            document.getElementById(`type${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('active');

            // Update instruction text
            const instructionText = document.getElementById('instructionText');
            const textarea = document.getElementById('thaiInput');

            if (type === 'word') {
                instructionText.innerHTML = 'Separate words with <kbd>space</kbd>. Example: ‡∏Å‡∏¥‡∏ô ‡∏î‡∏∑‡πà‡∏° ‡∏î‡∏π ‡∏ü‡∏±‡∏á ‡∏ï‡∏∑‡πà‡∏ô';
                textarea.placeholder = "‡∏Å‡∏¥‡∏ô ‡∏î‡∏∑‡πà‡∏° ‡∏î‡∏π ‡∏ü‡∏±‡∏á ‡∏ï‡∏∑‡πà‡∏ô";
            } else {
                instructionText.innerHTML = 'Separate sentences with <kbd>Enter</kbd>. Words within sentences with <kbd>space</kbd>.';
                textarea.placeholder = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö\n‡∏ú‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏´‡πå‡∏ô\n‡∏Ñ‡∏∏‡∏ì‡∏™‡∏ö‡∏≤‡∏¢‡∏î‡∏µ‡πÑ‡∏´‡∏°";
            }

            updateFormatDisplay();
            updateStats();
        }

        function updateFormatDisplay() {
            const formatDiv = document.getElementById('formatDisplay');
            if (AppState.dataType === 'word') {
                formatDiv.innerHTML = `Output: Word objects with en and fa translations (plus any selected languages)`;
            } else {
                formatDiv.innerHTML = `Output: Sentence objects with "type", "source", "words" array, and "translations" object`;
            }
        }

        function updateStats() {
            const text = document.getElementById('thaiInput').value;

            if (AppState.dataType === 'word') {
                const words = text.split(/\s+/).filter(w => w.trim().length > 0);
                document.getElementById('wordCount').textContent = words.length;
                document.getElementById('sentenceCount').textContent = 'N/A';
                document.getElementById('inputStats').textContent = `${words.length} words`;
            } else {
                const sentences = text.split('\n').filter(s => s.trim().length > 0);
                const words = text.split(/\s+/).filter(w => w.trim().length > 0);
                document.getElementById('wordCount').textContent = words.length;
                document.getElementById('sentenceCount').textContent = sentences.length;
                document.getElementById('inputStats').textContent = `${words.length} words, ${sentences.length} sentences`;
            }
        }

        function cleanText() {
            const textarea = document.getElementById('thaiInput');
            textarea.value = Cleaner.clean(textarea.value);
            updateStats();
        }

        // ==================== GENERATE PREVIEW ====================
        async function generatePreview() {
            const text = document.getElementById('thaiInput').value;

            // Show loading
            document.getElementById('previewContent').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <span class="material-icons" style="font-size: 40px; animation: spin 1s infinite;">sync</span>
                    <p>Generating translations...</p>
                </div>
            `;

            if (AppState.dataType === 'word') {
                await generateWordPreview(text);
            } else {
                await generateParagraphPreview(text);
            }

            // Show action buttons
            document.getElementById('actionSection').style.display = 'flex';
        }

        // ==================== WORD LIST MODE ====================
        async function generateWordPreview(text) {
            // Words are separated by spaces
            const words = text.split(/\s+/).filter(w => w.trim().length > 0);
            const uniqueWords = [...new Set(words)];

            AppState.words = uniqueWords;
            AppState.wordTranslations = {};

            // Get selected languages (including defaults)
            const selectedLangs = AppState.languages.filter(l => l.selected);

            // Translate all words
            for (const word of uniqueWords) {
                AppState.wordTranslations[word] = {};
                for (const lang of selectedLangs) {
                    AppState.wordTranslations[word][lang.code] =
                        await TranslationAPI.translate(word, lang.code);
                }
            }

            // Render preview
            renderWordPreview(uniqueWords, selectedLangs);

            // Generate content
            generateWordContent(uniqueWords, selectedLangs);
        }

        function renderWordPreview(words, selectedLangs) {
            let html = '<div class="word-grid">';
            let translatedCount = 0;
            let totalCount = words.length;

            words.forEach(word => {
                const translations = AppState.wordTranslations[word] || {};
                let wordTranslated = 0;

                html += `<div class="word-card">`;
                html += `<div class="word-thai">${word}</div>`;

                selectedLangs.forEach(lang => {
                    const hasTranslation = translations[lang.code] ? true : false;
                    if (hasTranslation) wordTranslated++;

                    html += `
                        <div class="translation-row">
                            <span>${lang.flag}</span>
                            <input type="text" 
                                   value="${translations[lang.code] || ''}"
                                   placeholder="${lang.name}..."
                                   onchange="updateWordTranslation('${word}', '${lang.code}', this.value)"
                                   style="${!hasTranslation ? 'border-color: var(--warning);' : ''}">
                        </div>
                    `;
                });

                html += `</div>`;

                if (wordTranslated === selectedLangs.length) translatedCount++;
            });

            html += '</div>';
            document.getElementById('previewContent').innerHTML = html;

            // Update status
            updateTranslationStatus(translatedCount, totalCount);
        }

        function updateWordTranslation(word, langCode, value) {
            if (!AppState.wordTranslations[word]) {
                AppState.wordTranslations[word] = {};
            }
            AppState.wordTranslations[word][langCode] = value;

            // Update content
            generateWordContent(AppState.words, AppState.languages.filter(l => l.selected));
        }

        function generateWordContent(words, selectedLangs) {
            // Generate word objects with translations
            const content = words.map(word => {
                const translations = {};
                // Include all selected languages
                selectedLangs.forEach(lang => {
                    translations[lang.code] = AppState.wordTranslations[word]?.[lang.code] || '';
                });

                return {
                    word: word,
                    translations: translations
                };
            });

            AppState.generatedContent = content;

            // Convert to JSON string and remove outer brackets
            const jsonString = JSON.stringify(content, null, 2);
            AppState.generatedJSONString = jsonString.substring(1, jsonString.length - 1).trim();

            document.getElementById('jsonContent').textContent = AppState.generatedJSONString;
        }

        // ==================== PARAGRAPH MODE ====================
        async function generateParagraphPreview(text) {
            // Sentences are separated by newlines
            const sentences = text.split('\n').filter(s => s.trim().length > 0);

            AppState.sentences = sentences;
            AppState.sentenceTranslations = [];
            AppState.wordLevelTranslations = {};

            // Get selected languages (including defaults)
            const selectedLangs = AppState.languages.filter(l => l.selected);

            // First, collect all unique words across all sentences
            const allWords = new Set();
            sentences.forEach(sentence => {
                sentence.split(/\s+/).forEach(word => {
                    if (word.trim()) allWords.add(word.trim());
                });
            });

            // Translate all unique words (for word-level translations)
            for (const word of allWords) {
                AppState.wordLevelTranslations[word] = {};
                for (const lang of selectedLangs) {
                    AppState.wordLevelTranslations[word][lang.code] =
                        await TranslationAPI.translate(word, lang.code);
                }
            }

            // Then translate full sentences
            for (let i = 0; i < sentences.length; i++) {
                const sentence = sentences[i].trim();
                const sentenceTrans = {};

                for (const lang of selectedLangs) {
                    sentenceTrans[lang.code] = await TranslationAPI.translate(sentence, lang.code);
                }

                AppState.sentenceTranslations[i] = sentenceTrans;
            }

            // Render preview
            renderParagraphPreview(selectedLangs);

            // Generate content
            generateParagraphContent(selectedLangs);
        }

        function renderParagraphPreview(selectedLangs) {
            let html = '';
            let translatedCount = 0;
            let totalCount = AppState.sentences.length;

            AppState.sentences.forEach((sentence, sIndex) => {
                const words = sentence.split(/\s+/).filter(w => w.trim().length > 0);
                let sentenceTranslated = 0;

                html += `<div class="sentence-card">`;

                // Header with sentence number
                html += `<div class="sentence-header">`;
                html += `<span class="sentence-thai">${sentence}</span>`;
                html += `<span>S${sIndex + 1}</span>`;
                html += `</div>`;

                // Word breakdown with translations
                html += `<div class="word-chips">`;
                words.forEach(word => {
                    const wordTrans = AppState.wordLevelTranslations[word] || {};

                    html += `<span class="word-chip">`;
                    html += `<span class="word">${word}</span>`;
                    html += `<span class="translations">`;
                    selectedLangs.forEach(lang => {
                        if (wordTrans[lang.code]) {
                            html += `<span class="translation" title="${lang.name}">${lang.flag} ${wordTrans[lang.code]}</span>`;
                        }
                    });
                    html += `</span>`;
                    html += `</span>`;
                });
                html += `</div>`;

                // Sentence-level translations
                const sentenceTrans = AppState.sentenceTranslations[sIndex] || {};

                selectedLangs.forEach(lang => {
                    const hasTranslation = sentenceTrans[lang.code] ? true : false;
                    if (hasTranslation) sentenceTranslated++;

                    html += `
                        <div class="translation-row">
                            <span>${lang.flag}</span>
                            <input type="text" 
                                   value="${sentenceTrans[lang.code] || ''}"
                                   placeholder="Full sentence ${lang.name}..."
                                   onchange="updateSentenceTranslation(${sIndex}, '${lang.code}', this.value)"
                                   style="${!hasTranslation ? 'border-color: var(--warning);' : ''}">
                        </div>
                    `;
                });

                html += `</div>`;

                if (sentenceTranslated === selectedLangs.length) translatedCount++;
            });

            document.getElementById('previewContent').innerHTML = html;
            updateTranslationStatus(translatedCount, totalCount);
        }

        function updateSentenceTranslation(sIndex, langCode, value) {
            if (!AppState.sentenceTranslations[sIndex]) {
                AppState.sentenceTranslations[sIndex] = {};
            }
            AppState.sentenceTranslations[sIndex][langCode] = value;

            // Update content
            generateParagraphContent(AppState.languages.filter(l => l.selected));
        }

        function generateParagraphContent(selectedLangs) {
            // Generate sentence objects with the exact structure
            const elements = AppState.sentences.map((sentence, sIndex) => {
                const words = sentence.split(/\s+/).filter(w => w.trim().length > 0);

                // Create word objects with their translations
                const wordObjects = words.map(word => {
                    const wordTrans = AppState.wordLevelTranslations[word] || {};
                    const translations = {};

                    // Include all selected languages
                    selectedLangs.forEach(lang => {
                        translations[lang.code] = wordTrans[lang.code] || '';
                    });

                    return {
                        word: word,
                        translations: translations
                    };
                });

                // Create sentence-level translations
                const sentenceTrans = AppState.sentenceTranslations[sIndex] || {};
                const translations = {};

                // Include all selected languages
                selectedLangs.forEach(lang => {
                    translations[lang.code] = sentenceTrans[lang.code] || '';
                });

                return {
                    type: "sentence",
                    source: sentence,
                    words: wordObjects,
                    translations: translations
                };
            });

            AppState.generatedContent = elements;

            // Convert to JSON string and remove outer brackets
            const jsonString = JSON.stringify(elements, null, 2);
            AppState.generatedJSONString = jsonString.substring(1, jsonString.length - 1).trim();

            document.getElementById('jsonContent').textContent = AppState.generatedJSONString;
        }

        function updateTranslationStatus(translated, total) {
            const statusDiv = document.getElementById('translationStatus');
            statusDiv.innerHTML = `
                <span><span class="status-badge status-complete"></span> ${translated}/${total} Complete</span>
                <span><span class="status-badge status-pending"></span> ${total - translated} Pending</span>
            `;
        }

        // ==================== DOWNLOAD / COPY ====================
        function downloadJSON() {
            if (!AppState.generatedJSONString) {
                alert('Please click Generate first');
                return;
            }

            const blob = new Blob([AppState.generatedJSONString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;

            const type = AppState.dataType === 'word' ? 'words' : 'sentences';
            a.download = `thai_${type}_${Date.now()}.json`;

            a.click();
            URL.revokeObjectURL(url);
        }

        function copyJSON() {
            if (!AppState.generatedJSONString) {
                alert('Please click Generate first');
                return;
            }

            navigator.clipboard.writeText(AppState.generatedJSONString);

            // Show feedback
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="material-icons">check</span> Copied!';
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 2000);
        }

        // ==================== PREVIEW SWITCHING ====================
        function switchPreview(view) {
            const structureView = document.getElementById('structureView');
            const jsonView = document.getElementById('jsonView');
            const tabs = document.querySelectorAll('.preview-tab');

            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            if (view === 'structure') {
                structureView.style.display = 'block';
                jsonView.style.display = 'none';
            } else {
                structureView.style.display = 'none';
                jsonView.style.display = 'block';
            }
        }

        // Add CSS animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        // Initialize
        init();

        // Make functions global
        window.setDataType = setDataType;
        window.toggleLanguage = toggleLanguage;
        window.cleanText = cleanText;
        window.generatePreview = generatePreview;
        window.downloadJSON = downloadJSON;
        window.copyJSON = copyJSON;
        window.switchPreview = switchPreview;
        window.updateWordTranslation = updateWordTranslation;
        window.updateSentenceTranslation = updateSentenceTranslation;
    </script>
</body>

</html>