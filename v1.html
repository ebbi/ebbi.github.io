<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai&family=Chakra+Petch&display=swap"
        rel="stylesheet" />
    <title>‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô Thai</title>

    <style>
        /* === Base Styles for Inputs, Selects, Buttons === */
        .controls button,
        #bookSelectionControls select,
        #settingsInline select,
        .controls input[type="number"],
        #themeToggle {
            font-size: 1em;
            line-height: 1.5;
            padding: 0 0.5em;
            height: 2em;
            border-radius: 4px;
            border: 1px solid #ccc;
            background: #f0f0f0;
            color: #000;
            cursor: pointer;
            box-sizing: border-box;
            vertical-align: middle;
            transition: background 0.2s, color 0.2s, border-color 0.2s;
        }

        /* Number input text alignment */
        .controls input[type="number"] {
            text-align: center;
        }

        /* Checkbox styling */
        .controls label input[type="checkbox"],
        #quizControls label input[type="checkbox"] {
            width: 1em;
            height: 1em;
            margin: 0 0.2em 0 0;
            accent-color: #00247D;
            vertical-align: middle;
            cursor: pointer;
        }

        /* Hover states */
        .controls button:hover,
        .controls input[type="number"]:hover,
        .controls select:hover,
        #themeToggle:hover,
        #quizControls button:hover {
            background: #e0e0e0;
        }

        /* Dark theme adjustments */
        body[data-theme="dark"] .controls button,
        body[data-theme="dark"] .controls input[type="number"],
        body[data-theme="dark"] .controls select,
        body[data-theme="dark"] #themeToggle,
        body[data-theme="dark"] #quizControls button {
            background: #333;
            border: 1px solid #555;
            color: #eee;
        }

        body[data-theme="dark"] .controls button:hover,
        body[data-theme="dark"] .controls input[type="number"]:hover,
        body[data-theme="dark"] .controls select:hover,
        body[data-theme="dark"] #themeToggle:hover,
        body[data-theme="dark"] #quizControls button:hover {
            background: #444;
        }

        body[data-theme="dark"] .controls label input[type="checkbox"],
        body[data-theme="dark"] #quizControls label input[type="checkbox"] {
            accent-color: #66aaff;
        }

        /* Theme Toggle Button */
        #themeToggle {
            background: none;
            border: none;
            width: auto;
            min-width: 0;
            padding: 0 0.5em;
            font-size: 1em;
            line-height: 1.5;
        }

        /* Controls container alignment */
        .controls,
        #bookSelectionControls,
        #settingsInline {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5em;
        }

        /* Label alignment */
        .controls label,
        #settingsInline label {
            display: flex;
            align-items: center;
            gap: 0.3em;
            font-size: 0.9em;
        }

        /* Thai Font Styling */
        .thai-font.tahoma {
            font-family: Tahoma, sans-serif;
        }

        .thai-font.noto {
            font-family: 'Noto Sans Thai', sans-serif;
        }

        .thai-font.chakra {
            font-family: 'Chakra Petch', sans-serif;
        }

        /* Highlighting */
        span.thai-font.highlight-light,
        span:not(.thai-font).highlight-light {
            background: yellow;
            color: black;
        }

        span.thai-font.highlight-dark,
        span:not(.thai-font).highlight-dark {
            background: orange;
            color: black;
        }

        /* Base page styling */
        body {
            font-size: clamp(14px, 2.5vw, 18px);
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            transition: background 0.3s, color 0.3s;
        }

        body[data-theme="dark"] {
            background: #222;
            color: #eee;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #00247D;
            color: white;
            padding: 0.5em 1em;
        }

        main {
            padding: 1em;
        }

        section {
            margin-bottom: 1.5em;
            padding-bottom: 1em;
            border-bottom: 1px solid #ccc;
        }

        #paragraphDisplay {
            font-size: 1.2em;
            margin: 1em 0;
            white-space: pre-wrap;
            width: 100%;
            box-sizing: border-box;
        }

        #paragraphDisplay span {
            margin: 0 0.2em;
        }

        .word-pair {
            display: inline-block;
            vertical-align: top;
            margin: 0 0.2em 0.3em 0.2em;
        }

        .word-pair span[lang="th-TH"] {
            display: block;
            word-break: keep-all;
            overflow-wrap: break-word;
        }

        .word-pair span[lang="en-US"] {
            display: block;
            word-break: normal;
            overflow-wrap: normal;
            white-space: normal;
            margin-top: 0.1em;
        }

        /* Quiz styling */
        #quiz {
            margin-top: 1em;
        }

        .quiz-heading {
            font-weight: 600;
            margin-bottom: 0.5em;
        }

        .quiz-question {
            margin: 1em 0;
        }

        .quiz-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5em;
        }

        .quiz-option {
            border: 1px solid #ccc;
            padding: 0.3em 0.6em;
            cursor: pointer;
            border-radius: 5px;
            user-select: none;
        }

        .quiz-option.correct {
            background: var(--correct, #4caf50);
            color: white;
        }

        .quiz-option.incorrect {
            background: var(--incorrect, #f44336);
            color: white;
        }


        #quizControls {
            display: flex;
            gap: 1em;
            margin-top: 1em;
            align-items: center;
        }


        /* === Unified Button Styling for Paragraph + Quiz Controls === */
        #paragraphControls button,
        #quizControls button {
            font-size: 1rem;
            line-height: 1.5;
            padding: 0 0.5em;
            height: 2.2em;
            /* fixed consistent height */
            min-width: 1em;
            /* consistent width across all buttons */
            border-radius: 4px;
            border: 1px solid #ccc;
            background: #f0f0f0;
            color: #000;
            cursor: pointer;
            box-sizing: border-box;
            vertical-align: middle;
            transition: background 0.2s, color 0.2s, border-color 0.2s;
        }

        #paragraphControls button:hover,
        #quizControls button:hover {
            background: #e0e0e0;
        }

        body[data-theme="dark"] #paragraphControls button,
        body[data-theme="dark"] #quizControls button {
            background: #333;
            border: 1px solid #555;
            color: #eee;
        }

        body[data-theme="dark"] #paragraphControls button:hover,
        body[data-theme="dark"] #quizControls button:hover {
            background: #444;
        }
    </style>
</head>

<body data-theme="light">
    <header>
        <span lang="th">‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô</span>
        <span id="settingsInline">
            <button id="themeToggle" title="Toggle Day/Night">üåû</button>
            <label>Thai Font:
                <select id="thaiFont">
                    <option value="">Default</option>
                    <option value="Tahoma">Tahoma</option>
                    <option value="Noto Sans Thai">Noto Sans Thai</option>
                    <option value="Chakra Petch">Chakra Petch</option>
                </select>
            </label>
        </span>
    </header>

    <main></main>

    <script>
        /* --- Utilities --- */
        const saveSetting = (k, v) => localStorage.setItem(k, v);
        const loadSetting = (k, def = '') => localStorage.getItem(k) || def;
        const getSavedInt = (k, def = 0) => parseInt(loadSetting(k, def), 10);

        /* --- State --- */
        let books = [], book = null;
        let currentBook = 0, currentChapter = 0, currentParagraph = 0;
        let isPlaying = false, currentWordIndex = 0, utterance = null;
        let lastHighlightedIndex = null;
        let bookSelect, chapterSelect, paragraphSelect, paragraphDisplay, scoreDisplay;
        let thaiElements = [];

        /* --- Theme & Font --- */
        const themeToggle = document.getElementById('themeToggle');
        function setTheme(theme) {
            document.body.dataset.theme = theme;
            themeToggle.textContent = theme === 'light' ? 'üåû' : 'üåô';
            saveSetting('theme', theme);
        }
        themeToggle.addEventListener('click', () => setTheme(document.body.dataset.theme === 'light' ? 'dark' : 'light'));
        setTheme(loadSetting('theme', 'light'));

        const thaiFont = document.getElementById('thaiFont');
        function applyThaiFont() {
            const font = loadSetting('thaiFont', '');
            document.querySelectorAll('[lang="th-TH"]').forEach(el => {
                el.classList.add('thai-font');
                el.classList.remove('tahoma', 'noto', 'chakra');
                if (font === 'Tahoma') el.classList.add('tahoma');
                if (font === 'Noto Sans Thai') el.classList.add('noto');
                if (font === 'Chakra Petch') el.classList.add('chakra');
            });
        }
        thaiFont.addEventListener('change', () => { saveSetting('thaiFont', thaiFont.value); applyThaiFont(); });
        thaiFont.value = loadSetting('thaiFont', '');
        applyThaiFont();

        /* --- TTS --- */
        function speakTextQueued(text, lang, cb) {
            if (!text) return;
            speechSynthesis.cancel();
            utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;
            utterance.onend = cb;
            speechSynthesis.speak(utterance);
        }

        /* --- Paragraph Rendering --- */
        function getCurrentParagraph() { return book?.chapters?.[currentChapter]?.paragraphs?.[currentParagraph] || []; }

        function renderParagraph() {
            const para = getCurrentParagraph();
            paragraphDisplay.innerHTML = '';

            para.forEach((w, i) => {
                // Special newline-only object -> insert <br>
                if (w.th === "\n" && w.en === "\n") {
                    const br = document.createElement('br');
                    paragraphDisplay.appendChild(br);
                    return;
                }

                const pairDiv = document.createElement('div');
                pairDiv.className = 'word-pair';
                pairDiv.dataset.index = i;

                if (document.getElementById('showThai')?.checked) {
                    const thSpan = document.createElement('span');
                    thSpan.textContent = w.th;
                    thSpan.lang = 'th-TH';
                    thSpan.dataset.index = i;
                    thSpan.onclick = () => playWord(w.th, 'th-TH', thSpan);
                    pairDiv.appendChild(thSpan);
                }

                if (document.getElementById('showEnglish')?.checked) {
                    const enSpan = document.createElement('span');
                    enSpan.textContent = w.en;
                    enSpan.lang = 'en-US';
                    enSpan.dataset.index = i;
                    enSpan.onclick = () => playWord(w.en, 'en-US', enSpan);
                    pairDiv.appendChild(enSpan);
                }

                paragraphDisplay.appendChild(pairDiv);
            });

            applyThaiFont();
            buildQuizFromParagraph(para);
        }

        function playWord(text, lang, span, index) {
            if (!text || text === "\n") return;

            const themeClass = document.body.dataset.theme === 'dark'
                ? 'highlight-dark'
                : 'highlight-light';

            // Clear previous highlights, then highlight clicked word
            clearHighlights();
            if (span) span.classList.add(themeClass);

            // Cancel any current speech
            speechSynthesis.cancel();

            // Use speakWord with autoAdvance:false so highlight stays
            speakWord(text, lang, index, { autoAdvance: false }).then(() => {
                // Do NOT remove highlight automatically
            });
        }

        function clearHighlights() { document.querySelectorAll('#paragraphDisplay span').forEach(s => s.classList.remove('highlight-light', 'highlight-dark')); }

        function speakWord(text, lang, index, { autoAdvance = true } = {}) {
            return new Promise(resolve => {
                if (!text || text === "\n") {
                    resolve();
                    return;
                }

                const themeClass = document.body.dataset.theme === 'dark'
                    ? 'highlight-dark'
                    : 'highlight-light';

                const pairDiv = paragraphDisplay.querySelector(`.word-pair[data-index="${index}"]`);
                const span = pairDiv ? pairDiv.querySelector(`span[lang="${lang}"]`) : null;

                if (span) {
                    span.classList.add(themeClass);
                    lastHighlightedIndex = index;   // üîë remember last highlighted
                }

                const utter = new SpeechSynthesisUtterance(text);
                utter.lang = lang;
                utter.onend = () => {
                    // Only clear if auto-advancing AND still playing
                    if (autoAdvance && isPlaying && span) {
                        span.classList.remove('highlight-light', 'highlight-dark');
                    }
                    resolve();
                };
                speechSynthesis.speak(utter);
            });
        }

        /* --- Quiz --- */
        const Quiz = {
            data: [], currentQ: 0,
            buildFromParagraph(para) { this.data = para.map(w => ({ question: w.th, answer: w.en, attempted: false, correct: false })); this.currentQ = 0; this.render(); },
            render() {
                const qDiv = document.getElementById('quiz'); qDiv.innerHTML = '';
                let data = this.data;
                if (document.getElementById('incorrectOnly')?.checked) data = data.filter(q => q.attempted && !q.correct);
                if (!data.length) { qDiv.textContent = "No questions."; this.updateScore(); return; }
                const q = data[this.currentQ % data.length];
                const isThaiQ = document.getElementById('questionThai')?.checked;

                const heading = document.createElement('div'); heading.className = 'quiz-heading';
                heading.textContent = 'Quiz: Select the correct translation'; qDiv.appendChild(heading);

                const qEl = document.createElement('div');
                qEl.className = 'quiz-question quiz-option';
                qEl.textContent = isThaiQ ? q.question : q.answer;
                qEl.style.cursor = 'pointer';
                qEl.onclick = () => speakTextQueued(qEl.textContent, isThaiQ ? 'th-TH' : 'en-US');
                qDiv.appendChild(qEl);

                const optsDiv = document.createElement('div'); optsDiv.className = 'quiz-options';
                let opts = this.data.map(x => isThaiQ ? x.answer : x.question).filter(o => o !== (isThaiQ ? q.answer : q.question)).sort(() => Math.random() - 0.5).slice(0, 3);
                opts.push(isThaiQ ? q.answer : q.question); opts.sort(() => Math.random() - 0.5);

                opts.forEach(opt => {
                    const o = document.createElement('div'); o.className = 'quiz-option'; o.textContent = opt;
                    o.onclick = () => {
                        q.attempted = true;
                        const correct = isThaiQ ? q.answer : q.question;
                        if (opt === correct) o.classList.add('correct'), q.correct = true;
                        else o.classList.add('incorrect');
                        speakTextQueued(opt, isThaiQ ? 'en-US' : 'th-TH'); this.updateScore();
                    };
                    optsDiv.appendChild(o);
                });
                qDiv.appendChild(optsDiv);
                this.updateScore();
            },
            updateScore() {
                const attempted = this.data.filter(q => q.attempted).length;
                const correct = this.data.filter(q => q.correct).length;
                scoreDisplay.textContent = `Score: ${correct}/${attempted}`;
            }
        };
        function buildQuizFromParagraph(para) { Quiz.buildFromParagraph(para); }

        /* --- SPA Init --- */
        function initSPA() {
            const main = document.querySelector('main'); main.innerHTML = '';

            /* Book/Chapter/Paragraph Selection */
            const selSec = document.createElement('section'); selSec.id = 'bookSelectionControls';
            const bookLabel = document.createElement('label'); bookLabel.textContent = 'Book: ';
            const bookSelectEl = document.createElement('select'); bookSelectEl.id = 'bookSelect'; bookLabel.appendChild(bookSelectEl);
            const chapLabel = document.createElement('label'); chapLabel.textContent = 'Chapter: ';
            const chapSelectEl = document.createElement('select'); chapSelectEl.id = 'chapterSelect'; chapLabel.appendChild(chapSelectEl);
            const paraLabel = document.createElement('label'); paraLabel.textContent = 'Paragraph: ';
            const paraSelectEl = document.createElement('select'); paraSelectEl.id = 'paragraphSelect'; paraLabel.appendChild(paraSelectEl);
            selSec.append(bookLabel, chapLabel, paraLabel);
            main.appendChild(selSec);

            /* Paragraph Section */
            const paraSec = document.createElement('section'); paraSec.id = 'paragraphSec';
            const paraHeading = document.createElement('div'); paraHeading.className = 'quiz-heading';
            paraHeading.textContent = 'Use the player buttons or click a word to hear it';
            paraSec.appendChild(paraHeading);

            const displayDiv = document.createElement('div'); displayDiv.id = 'paragraphDisplay';
            paraSec.appendChild(displayDiv);

            const controlsDiv = document.createElement('div'); controlsDiv.className = 'controls'; controlsDiv.id = 'paragraphControls';
            const playBtn = document.createElement('button'); playBtn.id = 'playBtn'; playBtn.textContent = '‚ñ∂Ô∏è';
            const pauseBtn = document.createElement('button'); pauseBtn.id = 'pauseBtn'; pauseBtn.textContent = '‚è∏Ô∏è';
            const restartBtn = document.createElement('button'); restartBtn.id = 'restartBtn'; restartBtn.textContent = '‚èÆÔ∏è';

            const showThaiLbl = document.createElement('label');
            showThaiLbl.innerHTML = `<input type="checkbox" id="showThai" checked> Thai`;
            const showEnglishLbl = document.createElement('label');
            showEnglishLbl.innerHTML = `<input type="checkbox" id="showEnglish"> English`;

            const delayLbl = document.createElement('label'); delayLbl.textContent = 'Delay: ';
            const delayInput = document.createElement('input'); delayInput.type = 'number'; delayInput.id = 'playbackDelay';
            delayInput.value = loadSetting('playbackDelay', '0.5'); delayInput.min = 0.5; delayInput.max = 10; delayInput.step = 0.1; delayLbl.appendChild(delayInput);

            controlsDiv.append(playBtn, pauseBtn, restartBtn, showThaiLbl, showEnglishLbl, delayLbl);
            paraSec.appendChild(controlsDiv);
            main.appendChild(paraSec);

            /* Quiz Section */
            const quizSec = document.createElement('section'); quizSec.id = 'quizSec';
            quizSec.innerHTML = `
<div id="quiz"></div>
<div id="quizControls">
    <button id="prevQ">‚¨ÖÔ∏è</button>
    <button id="nextQ">‚û°Ô∏è</button>
    <button id="retryQuiz">üîÑ</button>
    <label><input type="checkbox" id="questionThai" checked> TH / EN</label>
    <label><input type="checkbox" id="incorrectOnly"> X Only</label>
    <div id="score">Score: 0/0</div>
</div>`;
            main.appendChild(quizSec);

            /* Bind globals */
            bookSelect = document.getElementById('bookSelect');
            chapterSelect = document.getElementById('chapterSelect');
            paragraphSelect = document.getElementById('paragraphSelect');
            paragraphDisplay = document.getElementById('paragraphDisplay');
            scoreDisplay = document.getElementById('score');

            delayInput.addEventListener('change', () => {
                let val = parseFloat(delayInput.value);
                if (isNaN(val)) val = 0.5;
                val = Math.min(Math.max(val, 0.5), 10);
                delayInput.value = val.toFixed(1);
                saveSetting('playbackDelay', delayInput.value);
            });
        }

        /* --- Book Loading --- */
        async function getBookList() { try { const res = await fetch('/assets/books/bookList.json'); return await res.json(); } catch (e) { console.error(e); return []; } }
        async function populateBooks() {
            const list = await getBookList(); bookSelect.innerHTML = ''; list.forEach(b => { const o = document.createElement('option'); o.value = b.bookFilename; o.textContent = b.bookTitle; bookSelect.appendChild(o); });
            const savedBook = loadSetting('currentBook', bookSelect.value); bookSelect.value = savedBook; await selectBook(savedBook);
        }
        async function selectBook(filename) { try { const res = await fetch(`/assets/books/${filename}`); book = await res.json(); saveSetting('currentBook', filename); populateChapters(); } catch (e) { console.error(e); } }
        function populateChapters() {
            chapterSelect.innerHTML = ''; book.chapters.forEach((c, i) => { const o = document.createElement('option'); o.value = i; o.textContent = c.chapterTitle; chapterSelect.appendChild(o); });
            currentChapter = Math.min(getSavedInt('currentChapter', 0), book.chapters.length - 1); chapterSelect.value = currentChapter; populateParagraphs();
        }
        function populateParagraphs() {
            paragraphSelect.innerHTML = ''; book.chapters[currentChapter].paragraphs.forEach((p, i) => { const o = document.createElement('option'); o.value = i; o.textContent = "Paragraph " + (i + 1); paragraphSelect.appendChild(o); });
            currentParagraph = Math.min(getSavedInt('currentParagraph', 0), book.chapters[currentChapter].paragraphs.length - 1); paragraphSelect.value = currentParagraph; loadParagraph();
        }
        function loadParagraph() { saveSetting('currentChapter', currentChapter); saveSetting('currentParagraph', currentParagraph); renderParagraph(); }

        /* --- Event Delegation --- */
        document.addEventListener('change', e => {
            switch (e.target.id) {
                case 'bookSelect': selectBook(e.target.value); break;
                case 'chapterSelect': currentChapter = +e.target.value; saveSetting('currentChapter', currentChapter); populateParagraphs(); break;
                case 'paragraphSelect': currentParagraph = +e.target.value; saveSetting('currentParagraph', currentParagraph); loadParagraph(); break;
                case 'showThai': case 'showEnglish': renderParagraph(); break;
                case 'questionThai': case 'incorrectOnly': Quiz.render(); break;
            }
        });
        document.addEventListener('click', e => {
            switch (e.target.id) {
                case 'playBtn': playParagraph(); break;
                case 'pauseBtn': pauseParagraph(); break;
                case 'restartBtn': restartParagraph(); break;
                case 'prevQ': Quiz.currentQ = Math.max(0, Quiz.currentQ - 1); Quiz.data.forEach(q => { q.attempted = false; q.correct = false; }); Quiz.render(); break;
                case 'nextQ': Quiz.currentQ++; Quiz.render(); break;
                case 'retryQuiz': Quiz.data.forEach(q => { q.attempted = false; q.correct = false; }); Quiz.render(); break;
            }
        });

        /* --- Playback Controls (play resumes from paused index) --- */
        function playParagraph() {
            // if already playing nothing to do
            if (isPlaying) return;

            const para = getCurrentParagraph();
            if (!para || para.length === 0) return;

            isPlaying = true;

            // Resume from currentWordIndex when in-range. Only reset to 0 if index is invalid/out-of-range.
            if (typeof currentWordIndex !== 'number' || currentWordIndex < 0 || currentWordIndex >= para.length) {
                currentWordIndex = 0;
            }

            speakNextWord();
        }
        function pauseParagraph() {
            isPlaying = false;
            speechSynthesis.cancel();

            // üîë Ensure last highlight stays visible
            if (lastHighlightedIndex !== null) {
                clearHighlights();
                const pairDiv = paragraphDisplay.querySelector(`.word-pair[data-index="${lastHighlightedIndex}"]`);
                if (pairDiv) {
                    const spans = pairDiv.querySelectorAll('span');
                    const themeClass = document.body.dataset.theme === 'dark'
                        ? 'highlight-dark'
                        : 'highlight-light';
                    spans.forEach(s => s.classList.add(themeClass));
                }
            }
        }
        function restartParagraph() { pauseParagraph(); clearHighlights(); currentWordIndex = 0; playParagraph(); }

        async function speakNextWord() {
            const para = getCurrentParagraph();
            if (!isPlaying || !para || currentWordIndex >= para.length) {
                isPlaying = false;
                return;
            }

            const w = para[currentWordIndex];
            if (!w) {
                currentWordIndex++;
                await speakNextWord();
                return;
            }

            if (w.th === "\n" && w.en === "\n") {
                currentWordIndex++;
                await speakNextWord();
                return;
            }

            const showThai = document.getElementById('showThai')?.checked;
            const showEnglish = document.getElementById('showEnglish')?.checked;

            // üîë Clear highlights only if we're still actively playing
            if (isPlaying) clearHighlights();

            let delaySec = parseFloat(document.getElementById('playbackDelay')?.value || loadSetting('playbackDelay', '0.5'));
            if (isNaN(delaySec)) delaySec = 0.5;
            const delay = Math.min(Math.max(delaySec, 0.5), 10) * 1000;

            if (showThai && w.th && w.th !== "\n") {
                await speakWord(w.th, 'th-TH', currentWordIndex, { autoAdvance: true });
            }

            if (showEnglish && w.en && w.en !== "\n") {
                await speakWord(w.en, 'en-US', currentWordIndex, { autoAdvance: true });
            }

            currentWordIndex++;
            setTimeout(() => { if (isPlaying) speakNextWord(); }, delay);
        }

        /* --- Init SPA --- */
        (async function () { initSPA(); await populateBooks(); })();
    </script>
</body>

</html>