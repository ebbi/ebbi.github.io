<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bhasa Language Learner ‚Äî Refactored SPA (new-format only)</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai&family=Chakra+Petch&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="/assets/bhasa/stylesheet/bhasa.css">
</head>

<body data-theme="light">
  <header>
    <div style="display:flex;align-items:center;gap:1rem">
      <strong lang="th">‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô</strong>
      <span style="opacity:0.9">Bhasa Language Learner (refactor)</span>
    </div>
    <div class="controls-row" id="headerControls">
      <button id="settingsBtn" title="Settings">‚öôÔ∏è</button>
      <button id="themeToggle" title="Toggle theme">üåû</button>
    </div>
  </header>

  <main>
    <div class="app-shell" id="appShell">
      <!-- Main content injected here -->
    </div>
  </main>

  <!-- Settings overlay (hidden) -->
  <div id="settingsOverlay"
    style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center">
    <div id="settingsPanel" style="width:900px;max-width:95%;background:#fff;border-radius:8px;padding:1rem"></div>
  </div>

  <div id="statusAnnouncement" aria-live="polite" aria-atomic="true"
    style="position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden"></div>

  <script>
    /* ========= Constants ========= */
    const CONSTANTS = {
      STORAGE_KEYS: { THEME: 'theme', THAI_FONT: 'thaiFont', CURRENT_TOPIC: 'currentTopic', CURRENT_TITLE: 'currentTitle', CURRENT_EXAMPLE: 'currentExample', PLAYBACK_DELAY: 'playbackDelay', QUESTION_LANG: 'questionLang', ANSWER_LANG: 'answerLang' },
      DEFAULT_VALUES: { THEME: 'light', PLAYBACK_DELAY: '0.5', QUESTION_LANG: 'en-US', ANSWER_LANG: 'th-TH' },
      MAX_RETRIES: 3, RETRY_DELAY: 1000
    };

    /* ========= Simple Utilities ========= */
    const Utils = {
      generateId() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 8); },
      delay(ms) { return new Promise(r => setTimeout(r, ms)); },
      sanitize(text) { const d = document.createElement('div'); d.textContent = text; return d.innerHTML; }
    };

    /* ========= Storage ========= */
    const Storage = {
      save(k, v) { try { localStorage.setItem(k, v); } catch (e) { console.warn(e); } },
      load(k, def = '') { try { return localStorage.getItem(k) ?? def; } catch (e) { return def; } },
      loadBool(k, def = false) { const v = Storage.load(k, def ? '1' : '0'); return v === '1'; },
      loadInt(k, def = 0) { const v = Storage.load(k, String(def)); return parseInt(v, 10) || def }
    };

    /* ========= AppConfig (reads setup file for languages) ========= */
    const AppConfig = {
      data: null, availableLanguages: [],
      async load() {
        try {
          const res = await fetch('/assets/bhasa/bhasaSetup.json');
          if (!res.ok) throw new Error('setup not found');
          this.data = await res.json();
        } catch (e) {
          console.warn('Failed to load bhasaSetup.json, falling back to minimal defaults', e);
          this.data = this.getDefaultConfig();
        }
        this.availableLanguages = Object.entries(this.data.languages || {}).map(([code, cfg]) => ({ code, ...cfg }));
        return this.data;
      },
      getDefaultConfig() {
        return {
          app: { name: 'Bhasa', version: '1.0' }, languages: {
            'th-TH': { name: 'Thai', nativeName: '‡πÑ‡∏ó‡∏¢', defaultDisplay: true, defaultSpeak: true, rtl: false },
            'en-US': { name: 'English', nativeName: 'English', defaultDisplay: true, defaultSpeak: false, rtl: false }
          }
        };
      },
      getLanguage(code) { return this.availableLanguages.find(l => l.code === code); }
    };

    /* ========= Network helpers ========= */
    const NetworkManager = {
      async fetchJSON(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error('HTTP ' + res.status + ' ' + url);
        return res.json();
      }
    };

    /* ========= Error UI ========= */
    const ErrorHandler = {
      show(msg) { const shell = document.getElementById('appShell'); const el = document.createElement('div'); el.className = 'panel'; el.innerHTML = `<strong>Something went wrong</strong><p>${Utils.sanitize(msg)}</p>`; shell.prepend(el); }
    };

    /* ========= TopicManager (new-format-only) ========= */
    const TopicManager = {
      topics: [],
      cache: new Map(),
      async loadTopicList() {
        try {
          const list = await NetworkManager.fetchJSON('/assets/bhasa/topics/topicList.json');
          this.topics = Array.isArray(list) ? list : [];
        } catch (e) {
          console.warn('topicList load failed, using fallback', e);
          // fallback to greetings-word.json if available
          this.topics = [{ topicFilename: 'greetings-word.json', topic: 'Friend Greetings' }];
        }
        return this.topics;
      },
      async loadTopic(filename) {
        if (this.cache.has(filename)) return this.cache.get(filename);
        const data = await NetworkManager.fetchJSON('/assets/bhasa/topics/' + filename);
        const processed = this.processTopicData(data);
        this.cache.set(filename, processed);
        return processed;
      },
      processTopicData(topicData) {
        if (!topicData || !topicData.metadata || !Array.isArray(topicData.titles)) {
          throw new Error('Invalid topic file ‚Äî expected metadata + titles[]');
        }
        return {
          topic: topicData.metadata.topic || '',
          description: topicData.metadata.description || '',
          metadata: topicData.metadata,
          titles: topicData.titles.map(t => ({
            title: t.title || '',
            description: t.description || '',
            examples: (Array.isArray(t.examples) ? t.examples : []).map(ex => ({
              id: ex.id || Utils.generateId(),
              translations: ex.translations || {},
              metadata: ex.metadata || {}
            }))
          }))
        };
      }
    };

    /* ========= Example Renderer ========= */
    const ExampleRenderer = {
      el: null,
      init(container) { this.el = container; },
      render(example) {
        if (!this.el) return;
        if (!example || !example.translations) { this.el.textContent = 'No example found'; return; }
        const wordArray = this._flattenTranslations(example.translations);
        this.el.innerHTML = '';
        wordArray.forEach((word, idx) => {
          const pair = document.createElement('div'); pair.className = 'word-pair';
          AppConfig.availableLanguages.forEach(lang => {
            const displayChecked = document.getElementById('display_' + lang.code);
            if (!displayChecked || !displayChecked.checked) return;
            const txt = word[lang.code];
            if (!txt || String(txt).trim() === '') return;
            const span = document.createElement('span');
            span.textContent = txt;
            span.dataset.index = idx;
            span.dataset.language = lang.code;
            span.lang = lang.code;
            span.tabIndex = 0;
            span.setAttribute('role', 'button');
            span.setAttribute('aria-label', `Speak ${lang.name}: ${txt}`);
            span.addEventListener('click', () => {
              if (document.getElementById('speak_' + lang.code)?.checked) {
                PlaybackController.speakWord(txt, lang.code);
              }
            });
            pair.appendChild(span);
          });
          this.el.appendChild(pair);
        });
      },
      _flattenTranslations(translations) {
        if (!translations || typeof translations !== 'object') return [];
        const langs = Object.keys(translations);
        if (langs.length === 0) return [];
        const maxLen = Math.max(...langs.map(l => Array.isArray(translations[l]) ? translations[l].length : 1));
        const out = [];
        for (let i = 0; i < maxLen; i++) {
          const item = {};
          langs.forEach(l => item[l] = Array.isArray(translations[l]) ? (translations[l][i] || '') : translations[l] || '');
          out.push(item);
        }
        return out;
      }
    };

    /* ========= TTS Manager (keeps previous API) ========= */
    const TTSManager = {
      supportedVoices: [],
      initialize() {
        this.loadVoices();
        if ('speechSynthesis' in window) {
          speechSynthesis.addEventListener('voiceschanged', () => this.loadVoices());
        }
      },
      loadVoices() { this.supportedVoices = (typeof speechSynthesis !== 'undefined') ? speechSynthesis.getVoices() : []; },
      isSupported() { return ('speechSynthesis' in window) && typeof SpeechSynthesisUtterance !== 'undefined'; },
      getLanguageVoices(lang) { return this.supportedVoices.filter(v => v.lang && (v.lang.startsWith(lang) || v.lang.includes(lang))); },
      hasLanguageSupport(lang) { return this.getLanguageVoices(lang).length > 0; },
      speak(text, lang, onend) {
        if (!this.isSupported() || !text) { if (onend) onend(); return; }
        const u = new SpeechSynthesisUtterance(text);
        if (lang) u.lang = lang;
        u.volume = 0.85; u.rate = 0.95;
        u.onend = () => { if (onend) onend(); };
        u.onerror = () => { if (onend) onend(); };
        speechSynthesis.speak(u);
      }
    };

    /* ========= PlaybackController (iterative safe loop) ========= */
    const PlaybackController = {
      isPlaying: false, isPaused: false, sentence: [], wordIndex: 0,
      async playExample(example) {
        if (!example || !example.translations) return;
        this.stop();
        this.sentence = ExampleRenderer._flattenTranslations(example.translations);
        this.wordIndex = 0;
        this.isPlaying = true; this.isPaused = false;
        // give voices a moment
        await Utils.delay(200);
        this.loop();
      },
      pause() { this.isPaused = true; this.isPlaying = false; if (typeof speechSynthesis !== 'undefined') speechSynthesis.cancel(); },
      resume() { if (this.isPaused) { this.isPaused = false; this.isPlaying = true; this.loop(); } },
      stop() { this.isPlaying = false; this.isPaused = false; this.wordIndex = 0; if (typeof speechSynthesis !== 'undefined') speechSynthesis.cancel(); },
      async loop() {
        if (!this.isPlaying) return;
        if (this.wordIndex >= this.sentence.length) { this.stop(); return; }
        const word = this.sentence[this.wordIndex];
        // languages to speak: speak checkboxes if any, else displayed languages
        const speakLangs = (AppConfig.availableLanguages.filter(l => document.getElementById('speak_' + l.code)?.checked));
        const langs = speakLangs.length ? speakLangs : (AppConfig.availableLanguages.filter(l => document.getElementById('display_' + l.code)?.checked));
        for (let li = 0; li < langs.length; li++) {
          const lang = langs[li];
          const txt = word[lang.code];
          if (!txt || String(txt).trim() === '') continue;
          // highlight
          const spans = Array.from(document.querySelectorAll('#exampleDisplay span'));
          spans.forEach(s => s.classList.remove('highlight-light'));
          const found = spans.find(s => s.dataset.index == this.wordIndex && s.dataset.language == lang.code);
          if (found) found.classList.add('highlight-light');
          // speak with timeout guard
          await this._speakWithTimeout(txt, lang.code, 3500);
          // inter-language pause
          await Utils.delay(150);
          if (!this.isPlaying) break;
        }
        this.wordIndex++;
        // yield to browser and continue
        requestAnimationFrame(() => { if (this.isPlaying) this.loop(); });
      },
      _speakWithTimeout(text, lang, timeout) {
        return new Promise(resolve => {
          if (!TTSManager.isSupported()) { resolve(); return; }
          let done = false;
          const u = new SpeechSynthesisUtterance(text);
          if (lang) u.lang = lang;
          u.onend = () => { if (done) return; done = true; resolve(); };
          u.onerror = () => { if (done) return; done = true; resolve(); };
          speechSynthesis.speak(u);
          setTimeout(() => { if (done) return; done = true; try { speechSynthesis.cancel(); } catch (e) { } resolve(); }, timeout);
        });
      },
      speakWord(text, lang) { TTSManager.speak(text, lang); }
    };

    /* ========= QuizSystem (minimal stub, uses new-format) ========= */
    const QuizSystem = {
      score: 0,
      rebuildFromCurrentExample() { /* placeholder: rebuild quiz UI from example */ },
    };

    /* ========= LanguageManager UI helpers ========= */
    const LanguageManager = {
      initUI(container) {
        container.innerHTML = '';
        const header = document.createElement('div'); header.innerHTML = '<strong>Language Options</strong>';
        container.appendChild(header);
        const grid = document.createElement('div'); grid.className = 'language-grid';
        AppConfig.availableLanguages.forEach(l => {
          const labelDisplay = document.createElement('label');
          labelDisplay.innerHTML = `<input type="checkbox" id="display_${l.code}" ${l.defaultDisplay ? 'checked' : ''}/> Display ${l.name}`;
          const labelSpeak = document.createElement('label');
          labelSpeak.innerHTML = `<input type="checkbox" id="speak_${l.code}" ${l.defaultSpeak ? 'checked' : ''}/> Speak`;
          const wrapper = document.createElement('div'); wrapper.appendChild(labelDisplay); wrapper.appendChild(labelSpeak);
          grid.appendChild(wrapper);
        });
        container.appendChild(grid);
      }
    };

    /* ========= AppController: injects SPA HTML and wires events ========= */
    const AppController = {
      async init() {
        try {
          await AppConfig.load();
          TTSManager.initialize();
          const shell = document.getElementById('appShell');
          shell.innerHTML = this.getMainHTML();
          this.bindUI();
          // load topics
          const topics = await TopicManager.loadTopicList();
          this.populateTopicSelect(topics);
          // init example renderer
          ExampleRenderer.init(document.getElementById('exampleDisplay'));
          // apply theme
          ThemeManager.init();
        } catch (e) {
          console.error('AppController.init failed', e);
          ErrorHandler.show(e.message || String(e));
        }
      },
      getMainHTML() {
        return `
      <div class="panel toolbar">
        <div>
          <strong id="appTitle">‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô</strong><small style="margin-left:0.5rem"> ‚Äî Language Learner</small>
        </div>
        <div class="controls-row">
          <button id="openSettings">Settings</button>
          <button id="refreshTopics">Reload Topics</button>
        </div>
      </div>

      <div class="panel">
        <div style="display:flex;gap:0.75rem;align-items:center">
          <label>Topic <select id="topicSelect"></select></label>
          <label>Title <select id="titleSelect"></select></label>
          <button id="renderExampleBtn">Render Example</button>
        </div>

        <div style="display:flex;gap:1rem;margin-top:0.8rem">
          <div style="flex:1">
            <div id="languageControls"></div>
            <div style="margin-top:0.6rem">
              <button id="playBtn">Play</button>
              <button id="pauseBtn">Pause</button>
              <button id="stopBtn">Stop</button>
              <button id="ttsTestBtn">Test TTS</button>
            </div>
          </div>
          <div style="flex:2">
            <h4 id="topicHeading">Example</h4>
            <div id="exampleDisplay"></div>
            <div class="footer-note">Click a word to play that word's TTS for the language column.</div>
          </div>
        </div>
      </div>
    `;
      },
      bindUI() {
        document.getElementById('openSettings').addEventListener('click', () => SettingsManager.show());
        document.getElementById('refreshTopics').addEventListener('click', async () => {
          const topics = await TopicManager.loadTopicList();
          this.populateTopicSelect(topics);
        });
        document.getElementById('renderExampleBtn').addEventListener('click', () => {
          const tIdx = Number(document.getElementById('titleSelect').value || 0);
          const eIdx = 0;
          const curTopic = window.currentTopic;
          if (!curTopic) { alert('No topic loaded'); return; }
          const title = curTopic.titles?.[tIdx];
          const example = title?.examples?.[eIdx];
          if (!example) { alert('No example found for selected title'); return; }
          ExampleRenderer.render(example);
          document.getElementById('topicHeading').textContent = curTopic.topic + ' ‚Äî ' + title.title;
          window.currentExample = example;
          QuizSystem.rebuildFromCurrentExample();
        });
        document.getElementById('playBtn').addEventListener('click', () => { if (window.currentExample) PlaybackController.playExample(window.currentExample); else alert('Render an example first'); });
        document.getElementById('pauseBtn').addEventListener('click', () => PlaybackController.pause());
        document.getElementById('stopBtn').addEventListener('click', () => PlaybackController.stop());
        document.getElementById('ttsTestBtn').addEventListener('click', async () => {
          const status = TTSManager.isSupported() ? 'TTS seems available' : 'TTS not supported in this browser';
          alert(status);
        });
        document.getElementById('settingsBtn').addEventListener('click', () => SettingsManager.show());
        document.getElementById('themeToggle').addEventListener('click', () => ThemeManager.toggle());
      },
      populateTopicSelect(topics) {
        const sel = document.getElementById('topicSelect');
        sel.innerHTML = '';
        topics.forEach(t => {
          const o = document.createElement('option');
          o.value = t.topicFilename || t.filename || '';
          o.textContent = t.topic || o.value;
          sel.appendChild(o);
        });
        sel.addEventListener('change', async (e) => {
          const filename = e.target.value;
          if (!filename) return;
          try {
            const topic = await TopicManager.loadTopic(filename);
            window.currentTopic = topic;
            // populate titles
            const ts = document.getElementById('titleSelect'); ts.innerHTML = '';
            topic.titles.forEach((t, i) => { const o = document.createElement('option'); o.value = i; o.textContent = t.title || ('Title ' + (i + 1)); ts.appendChild(o); });
            // auto-render first example for convenience
            document.getElementById('titleSelect').selectedIndex = 0;
            document.getElementById('renderExampleBtn').click();
          } catch (err) { console.error(err); alert('Failed to load topic: ' + err.message); }
        });
        // select first if present
        if (sel.options.length > 0) {
          sel.selectedIndex = 0;
          sel.dispatchEvent(new Event('change'));
        }
        // render languages UI
        LanguageManager.initUI(document.getElementById('languageControls'));
      }
    };

    /* ========= Theme Manager ========= */
    const ThemeManager = {
      init() {
        const stored = Storage.load(CONSTANTS.STORAGE_KEYS.THEME, CONSTANTS.DEFAULT_VALUES.THEME);
        this.set(stored);
      },
      set(theme) {
        document.body.dataset.theme = theme;
        const btn = document.getElementById('themeToggle');
        if (btn) btn.textContent = theme === 'light' ? 'üåû' : 'üåô';
        Storage.save(CONSTANTS.STORAGE_KEYS.THEME, theme);
      },
      toggle() { this.set(document.body.dataset.theme === 'light' ? 'dark' : 'light'); }
    };

    /* ========= SettingsManager (preserve UI idea) ========= */
    const SettingsManager = {
      show() {
        const overlay = document.getElementById('settingsOverlay');
        const panel = document.getElementById('settingsPanel');
        panel.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Settings & Help</h3>
        <button id="closeSettings">Close</button>
      </div>
      <div style="margin-top:0.5rem">
        <label>Thai Font:
          <select id="settingsThaiFont"><option value="">Default</option><option value="Tahoma">Tahoma</option><option value="Noto Sans Thai">Noto Sans Thai</option><option value="Chakra Petch">Chakra Petch</option></select>
        </label>
        <div style="margin-top:0.6rem">
          <button id="checkTTS">üîä Test TTS Setup</button>
          <div id="ttsStatus" style="margin-top:0.5rem"></div>
        </div>
      </div>
    `;
        overlay.style.display = 'flex';
        document.getElementById('closeSettings').addEventListener('click', () => this.close());
        document.getElementById('checkTTS').addEventListener('click', async () => {
          const supported = TTSManager.isSupported();
          const status = supported ? 'Speech Synthesis supported' : 'Speech Synthesis NOT supported';
          document.getElementById('ttsStatus').textContent = status;
          if (supported) {
            // quick voice list
            const voices = TTSManager.supportedVoices.map(v => v.name + ' (' + v.lang + ')').slice(0, 10).join(', ');
            document.getElementById('ttsStatus').innerHTML += '<div style="margin-top:0.4rem"><small>Voices: ' + Utils.sanitize(voices) + '</small></div>';
          }
        });
      },
      close() { document.getElementById('settingsOverlay').style.display = 'none'; document.getElementById('settingsPanel').innerHTML = ''; }
    };

    /* ========= Initialization ========= */
    window.addEventListener('DOMContentLoaded', () => {
      AppController.init();
    });

    /* expose some modules for debugging */
    window.TopicManager = TopicManager;
    window.PlaybackController = PlaybackController;
    window.TTSManager = TTSManager;
    window.ExampleRenderer = ExampleRenderer;
  </script>
</body>

</html>