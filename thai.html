<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai&family=Chakra+Petch&display=swap"
        rel="stylesheet" />
    <title>ฝึกฝน Thai</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <style>
        /* CSS Custom Properties for Theming */
        :root {
            --primary-color: #00247D;
            --primary-light: #66aaff;
            --background-light: #f9f9f9;
            --background-dark: #222;
            --text-light: #000;
            --text-dark: #eee;
            --border-light: #ccc;
            --border-dark: #555;
            --correct-color: #4caf50;
            --incorrect-color: #f44336;
            --highlight-light: yellow;
            --highlight-dark: orange;
            --header-height: 60px;
        }

        /* Base page styling - MOBILE FIRST */
        body {
            font-size: clamp(14px, 2.5vw, 18px);
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            transition: background 0.3s, color 0.3s;
            background: var(--background-light);
            color: var(--text-light);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        body[data-theme="dark"] {
            background: var(--background-dark);
            color: var(--text-dark);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--primary-color);
            color: white;
            padding: 0.5em 1em;
            height: var(--header-height);
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 0;
        }

        /* Scrollable content area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 1em;
            -webkit-overflow-scrolling: touch;
        }

        /* Fixed controls at bottom */
        .controls-area {
            background: var(--background-light);
            border-top: 1px solid var(--border-light);
            padding: 1em;
            flex-shrink: 0;
            position: sticky;
            bottom: 0;
            z-index: 90;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        body[data-theme="dark"] .controls-area {
            background: var(--background-dark);
            border-top-color: var(--border-dark);
        }

        /* Section styling */
        section {
            margin-bottom: 1.5em;
            padding-bottom: 1em;
            border-bottom: 1px solid var(--border-light);
        }

        body[data-theme="dark"] section {
            border-bottom-color: var(--border-dark);
        }

        /* Help block styling */
        details {
            padding: 0.5em 1em;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            margin: 0.5em 0;
            font-size: 0.9em;
            font-weight: normal;
            text-align: left;
            background: var(--background-light);
            color: var(--text-light);
        }

        details summary {
            cursor: pointer;
            color: var(--primary-color);
        }

        body[data-theme="dark"] details {
            background: #2a2a2a;
            border: 1px solid var(--border-dark);
            color: var(--text-dark);
        }

        body[data-theme="dark"] details summary {
            color: var(--primary-light);
        }

        /* Style nested content in details */
        details p {
            margin: 0.5em 0;
            line-height: 1.5;
            text-align: left;
        }

        details ol {
            margin: 0.5em 1.5em;
            padding-left: 1.2em;
        }

        details ol li {
            margin: 0.4em 0;
        }

        /* === Base Styles for Inputs, Selects, Buttons === */
        button,
        select,
        input[type="number"] {
            font-size: 1em;
            line-height: 1.5;
            padding: 0.5em;
            height: 2.5em;
            border-radius: 4px;
            border: 1px solid var(--border-light);
            background: #f0f0f0;
            color: var(--text-light);
            cursor: pointer;
            box-sizing: border-box;
            vertical-align: middle;
            transition: background 0.2s, color 0.2s, border-color 0.2s;
        }

        /* Number input text alignment */
        input[type="number"] {
            text-align: center;
        }

        /* Checkbox styling */
        input[type="checkbox"] {
            width: 1.2em;
            height: 1.2em;
            margin: 0 0.3em 0 0;
            accent-color: var(--primary-color);
            vertical-align: middle;
            cursor: pointer;
        }

        /* Hover states */
        button:hover,
        input[type="number"]:hover,
        select:hover {
            background: #e0e0e0;
        }

        /* Dark theme adjustments */
        body[data-theme="dark"] button,
        body[data-theme="dark"] input[type="number"],
        body[data-theme="dark"] select {
            background: #333;
            border: 1px solid var(--border-dark);
            color: var(--text-dark);
        }

        body[data-theme="dark"] button:hover,
        body[data-theme="dark"] input[type="number"]:hover,
        body[data-theme="dark"] select:hover {
            background: #444;
        }

        body[data-theme="dark"] input[type="checkbox"] {
            accent-color: var(--primary-light);
        }

        /* Theme Toggle Button */
        #themeToggle {
            background: none;
            border: none;
            width: auto;
            min-width: 0;
            padding: 0 0.5em;
            font-size: 1em;
            line-height: 1.5;
        }

        /* Controls container alignment */
        .controls,
        #bookSelectionControls,
        #settingsInline {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5em;
        }

        /* Label alignment */
        label {
            display: flex;
            align-items: center;
            gap: 0.3em;
            font-size: 0.9em;
            white-space: nowrap;
        }

        /* Thai Font Styling */
        .thai-font.tahoma {
            font-family: Tahoma, sans-serif;
        }

        .thai-font.noto {
            font-family: 'Noto Sans Thai', sans-serif;
        }

        .thai-font.chakra {
            font-family: 'Chakra Petch', sans-serif;
        }

        /* Highlighting */
        .highlight-light {
            background: var(--highlight-light);
            color: black;
        }

        .highlight-dark {
            background: var(--highlight-dark);
            color: black;
        }

        #paragraphDisplay {
            margin: 1em 0;
            white-space: pre-wrap;
            width: 100%;
            box-sizing: border-box;
            line-height: 1.6;
            min-height: 150px;
            max-height: 40vh;
            overflow-y: auto;
            padding: 1em;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            background: var(--background-light);
        }

        body[data-theme="dark"] #paragraphDisplay {
            background: #2a2a2a;
            border-color: var(--border-dark);
        }

        :lang(th-TH) {
            font-size: larger;
        }

        :lang(fa-IR) {
            direction: rtl;
        }

        .word-pair {
            display: inline-block;
            vertical-align: top;
            margin: 0 0.3em 0.5em 0;
            cursor: pointer;
            padding: 0.2em;
            border-radius: 3px;
            transition: background-color 0.2s;
        }

        .word-pair:hover {
            background-color: rgba(0, 36, 125, 0.1);
        }

        body[data-theme="dark"] .word-pair:hover {
            background-color: rgba(102, 170, 255, 0.1);
        }

        .word-pair span[lang="th-TH"] {
            display: block;
            word-break: keep-all;
            overflow-wrap: break-word;
            font-size: large;
        }

        .word-pair span[lang="en-US"] {
            border-top: 1px solid lightskyblue;
            display: block;
            word-break: normal;
            overflow-wrap: normal;
            white-space: normal;
            margin-top: 0.1em;
            color: rgb(5, 154, 247);
            font-size: 0.9em;
        }

        .word-pair span[lang="fa-IR"] {
            border-top: 1px solid lightskyblue;
            display: block;
            word-break: keep-all;
            overflow-wrap: break-word;
            direction: rtl;
            color: green;
            font-size: 0.9em;
        }

        /* Quiz styling */
        #quiz {
            margin-top: 1em;
        }

        .quiz-heading {
            font-weight: 600;
            margin-bottom: 0.5em;
        }

        .quiz-question {
            font-size: 1.25rem;
            margin: .1em 0;
            padding: 0.5em;
            background: rgba(0, 36, 125, 0.05);
            border-radius: 5px;
        }

        body[data-theme="dark"] .quiz-question {
            background: rgba(102, 170, 255, 0.1);
        }

        .quiz-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5em;
            margin-top: 0.5em;
        }

        .quiz-option {
            border: 1px solid var(--border-light);
            padding: 0.5em 0.8em;
            cursor: pointer;
            border-radius: 5px;
            user-select: none;
            flex: 1;
            min-width: 120px;
            text-align: center;
            transition: all 0.2s;
        }

        .quiz-option.correct {
            background: var(--correct-color);
            color: white;
            border-color: var(--correct-color);
        }

        .quiz-option.incorrect {
            background: var(--incorrect-color);
            color: white;
            border-color: var(--incorrect-color);
        }

        #quizControls {
            display: flex;
            flex-direction: column;
            gap: 0.8em;
            margin-top: 1em;
        }

        .quiz-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.6em;
        }

        .quiz-row-top {
            justify-content: flex-start;
        }

        .quiz-row-bottom {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.4em;
        }

        @media (min-width: 600px) {
            .quiz-row-bottom {
                flex-direction: row;
                align-items: center;
            }
        }

        .lang-select {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4em 0.8em;
        }

        /* Paragraph controls responsive layout */
        #paragraphControls {
            display: flex;
            flex-direction: column;
            gap: 0.5em;
        }

        .paragraph-controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5em;
            align-items: center;
            justify-content: center;
        }

        /* Mobile-specific adjustments */
        @media (max-width: 600px) {
            #paragraphControls {
                gap: 0.8em;
            }

            .paragraph-controls-row {
                justify-content: center;
            }

            button {
                min-height: 44px;
                min-width: 44px;
            }

            .word-pair {
                margin: 0 0.2em 0.3em 0;
            }

            .quiz-option {
                min-width: 100px;
                padding: 0.6em 0.5em;
            }

            .controls-area {
                padding: 0.8em;
            }

            .content-area {
                padding: 0.8em;
            }

            #paragraphDisplay {
                max-height: 35vh;
                padding: 0.8em;
            }
        }

        /* Desktop adjustments */
        @media (min-width: 768px) {
            .content-area {
                padding: 1.5em;
            }

            .controls-area {
                padding: 1.2em;
            }

            .word-pair {
                margin: 0 0.5em 1em 0;
            }

            #paragraphDisplay {
                max-height: 50vh;
            }
        }

        /* Error and status styling */
        .error-message {
            color: var(--incorrect-color);
            background: #ffe6e6;
            padding: 0.5em;
            border-radius: 4px;
            margin: 0.5em 0;
            border: 1px solid var(--incorrect-color);
        }

        .success-message {
            color: var(--correct-color);
            background: #e6ffe6;
            padding: 0.5em;
            border-radius: 4px;
            margin: 0.5em 0;
            border: 1px solid var(--correct-color);
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Selection controls styling */
        #bookSelectionControls {
            background: rgba(0, 36, 125, 0.05);
            padding: 1em;
            border-radius: 8px;
            margin-bottom: 1em;
        }

        body[data-theme="dark"] #bookSelectionControls {
            background: rgba(102, 170, 255, 0.1);
        }

        /* Scrollbar styling */
        .content-area::-webkit-scrollbar,
        #paragraphDisplay::-webkit-scrollbar {
            width: 8px;
        }

        .content-area::-webkit-scrollbar-track,
        #paragraphDisplay::-webkit-scrollbar-track {
            background: var(--background-light);
        }

        .content-area::-webkit-scrollbar-thumb,
        #paragraphDisplay::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 4px;
        }

        body[data-theme="dark"] .content-area::-webkit-scrollbar-track,
        body[data-theme="dark"] #paragraphDisplay::-webkit-scrollbar-track {
            background: var(--background-dark);
        }

        body[data-theme="dark"] .content-area::-webkit-scrollbar-thumb,
        body[data-theme="dark"] #paragraphDisplay::-webkit-scrollbar-thumb {
            background: var(--border-dark);
        }
    </style>
</head>

<body data-theme="light">
    <header>
        <span lang="th">ฝึกฝน</span>
        <span id="settingsInline">
            <button id="themeToggle" title="Toggle Day/Night">🌞</button>
            <label>Thai Font:
                <select id="thaiFont">
                    <option value="">Default</option>
                    <option value="Tahoma">Tahoma</option>
                    <option value="Noto Sans Thai">Noto Sans Thai</option>
                    <option value="Chakra Petch">Chakra Petch</option>
                </select>
            </label>
            <button id="settingsBtn" title="Settings & Help">⚙️</button>
        </span>
    </header>

    <main>
        <div class="content-area" id="contentArea">
            <!-- Dynamic content will be inserted here -->
        </div>
        <div class="controls-area" id="controlsArea">
            <!-- Controls will be inserted here -->
        </div>
    </main>

    <script>
        // ==================== MODULARIZED VERSION ====================

        // ========== CORE UTILITIES ==========
        const Storage = {
            save: (key, value) => localStorage.setItem(key, value),
            load: (key, defaultValue = '') => localStorage.getItem(key) || defaultValue,
            loadInt: (key, defaultValue = 0) => parseInt(Storage.load(key, defaultValue), 10),
            loadBool: (key, defaultValue = false) => Storage.load(key, defaultValue ? '1' : '0') === '1'
        };

        const TTS = {
            utterance: null,

            speak(text, lang, onEnd) {
                if (!text) return;
                speechSynthesis.cancel();
                this.utterance = new SpeechSynthesisUtterance(text);
                this.utterance.lang = lang;
                if (onEnd) this.utterance.onend = onEnd;
                speechSynthesis.speak(this.utterance);
            },

            cancel() {
                speechSynthesis.cancel();
            },

            pause() {
                speechSynthesis.pause();
            }
        };

        // ========== APPLICATION STATE ==========
        const AppState = {
            books: [],
            currentBook: null,
            currentChapter: 0,
            currentParagraph: 0,
            isPlaying: false,
            currentWordIndex: 0,
            lastHighlightedIndex: null,

            initialize() {
                this.currentBook = Storage.load('currentBook', '');
                this.currentChapter = Storage.loadInt('currentChapter', 0);
                this.currentParagraph = Storage.loadInt('currentParagraph', 0);
            },

            saveNavigation() {
                Storage.save('currentChapter', this.currentChapter);
                Storage.save('currentParagraph', this.currentParagraph);
            },

            getCurrentParagraph() {
                return this.currentBook?.chapters?.[this.currentChapter]?.paragraphs?.[this.currentParagraph] || [];
            }
        };

        // ========== UI COMPONENTS ==========
        const ThemeManager = {
            init() {
                const themeToggle = document.getElementById('themeToggle');
                themeToggle.addEventListener('click', () => this.toggle());
                this.set(Storage.load('theme', 'light'));
            },

            set(theme) {
                document.body.dataset.theme = theme;
                document.getElementById('themeToggle').textContent = theme === 'light' ? '🌞' : '🌙';
                Storage.save('theme', theme);
            },

            toggle() {
                this.set(document.body.dataset.theme === 'light' ? 'dark' : 'light');
            }
        };

        const FontManager = {
            init() {
                const thaiFont = document.getElementById('thaiFont');
                thaiFont.value = Storage.load('thaiFont', '');
                thaiFont.addEventListener('change', (e) => {
                    Storage.save('thaiFont', e.target.value);
                    this.apply();
                });
                this.apply();
            },

            apply() {
                const font = Storage.load('thaiFont', '');
                document.querySelectorAll('[lang="th"], [lang="th-TH"]').forEach(el => {
                    el.classList.add('thai-font');
                    el.classList.remove('tahoma', 'noto', 'chakra');
                    if (font === 'Tahoma') el.classList.add('tahoma');
                    if (font === 'Noto Sans Thai') el.classList.add('noto');
                    if (font === 'Chakra Petch') el.classList.add('chakra');
                });
            }
        };

        const SettingsManager = {
            show() {
                const contentArea = document.getElementById('contentArea');
                const controlsArea = document.getElementById('controlsArea');
                contentArea.innerHTML = this.getSettingsHTML();
                controlsArea.innerHTML = '';
                this.bindSettingsEvents();
            },

            getSettingsHTML() {
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center;
                                background: #00247D; color: white; padding: 0.5em 1em; border-radius: 8px;">
                        <h2 style="margin: 0;">Settings & Help</h2>
                        <button id="closeX" style="background: #666; color: white; border: none; padding: 0.5em; border-radius: 4px; cursor: pointer;">❌</button>
                    </div>
                    <div style="min-height: 60vh; display: flex; flex-direction: column; justify-content: center;">
                        <div id="settingsControls" style="text-align: center; padding: 1em;">
                            <button id="checkTTS" style="padding: 0.8em 1.5em; background: #00247D; color: white; border: none; border-radius: 4px; cursor: pointer;">Check Sound and Language Setup</button>
                            <span id="ttsStatus" style="margin-left: 1em; font-weight: bold;"></span>
                            <br><br>
                            <button id="closeBtn" style="padding: 0.6em 1.2em; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
                        </div>
                    </div>`;
            },

            bindSettingsEvents() {
                document.getElementById('closeX').addEventListener('click', this.close);
                document.getElementById('closeBtn').addEventListener('click', this.close);
                document.getElementById('checkTTS').addEventListener('click', this.checkTTS);
            },

            close() {
                AppController.reload();
            },

            checkTTS() {
                const statusEl = document.getElementById('ttsStatus');
                if ('speechSynthesis' in window) {
                    statusEl.innerHTML = "<br>Text To Speech is setup.";
                    statusEl.style.color = "green";
                    TTS.speak("Hello in English", "en-US");
                } else {
                    statusEl.innerHTML = "<br>Text To Speech not available";
                    statusEl.style.color = "red";
                }
            }
        };

        // ========== BOOK MANAGEMENT ==========
        const BookManager = {
            async loadBookList() {
                try {
                    const res = await fetch('/assets/books/bookList.json');
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    return await res.json();
                } catch (error) {
                    console.error('Error loading book list:', error);
                    return [];
                }
            },

            async loadBook(filename) {
                try {
                    const res = await fetch(`/assets/books/${filename}`);
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    return await res.json();
                } catch (error) {
                    console.error('Error loading book:', error);
                    throw error;
                }
            }
        };

        // ========== PARAGRAPH RENDERING ==========
        const ParagraphRenderer = {
            display: null,

            init(displayElement) {
                this.display = displayElement;
            },

            render(paragraph) {
                if (!this.display) return;
                this.display.innerHTML = '';

                if (!paragraph || paragraph.length === 0) {
                    this.display.textContent = 'No paragraph content available.';
                    return;
                }

                paragraph.forEach((word, index) => {
                    this.renderWord(word, index);
                });

                FontManager.apply();
            },

            renderWord(word, index) {
                // Handle newlines
                if (this.isNewline(word)) {
                    this.display.appendChild(document.createElement('br'));
                    return;
                }

                // Use the original working approach
                function buildLanguages(thText, enText, faText, wordIndex) {
                    const pairDiv = document.createElement('div');
                    pairDiv.className = 'word-pair';
                    pairDiv.dataset.index = wordIndex;

                    if (document.getElementById('showThai')?.checked && thText) {
                        const thSpan = document.createElement('span');
                        thSpan.textContent = thText;
                        thSpan.lang = 'th-TH';
                        thSpan.dataset.index = wordIndex;
                        thSpan.onclick = () => PlaybackController.playWord(thText, 'th-TH', thSpan, wordIndex);
                        pairDiv.appendChild(thSpan);
                    }

                    if (document.getElementById('showEnglish')?.checked && enText) {
                        const enSpan = document.createElement('span');
                        enSpan.textContent = enText;
                        enSpan.lang = 'en-US';
                        enSpan.dataset.index = wordIndex;
                        enSpan.onclick = () => PlaybackController.playWord(enText, 'en-US', enSpan, wordIndex);
                        pairDiv.appendChild(enSpan);
                    }

                    if (document.getElementById('showPersian')?.checked && faText) {
                        const faSpan = document.createElement('span');
                        faSpan.textContent = faText;
                        faSpan.lang = 'fa-IR';
                        faSpan.dataset.index = wordIndex;
                        faSpan.onclick = () => PlaybackController.playWord(faText, 'fa-IR', faSpan, wordIndex);
                        pairDiv.appendChild(faSpan);
                    }

                    this.display.appendChild(pairDiv);
                }

                const thParts = (word.th || '').split('\n');
                const enParts = (word.en || '').split('\n');
                const faParts = (word.fa || '').split('\n');
                const maxParts = Math.max(thParts.length, enParts.length, faParts.length);

                for (let p = 0; p < maxParts; p++) {
                    const thPart = thParts[p] || '';
                    const enPart = enParts[p] || '';
                    const faPart = faParts[p] || '';

                    if (!thPart && !enPart && !faPart) continue;

                    buildLanguages.call(this, thPart, enPart, faPart, index);

                    if (p < maxParts - 1) {
                        this.display.appendChild(document.createElement('br'));
                    }
                }
            },

            isNewline(word) {
                return word.th === "\n" && word.en === "\n" && word.fa === "\n";
            },

            clearHighlights() {
                if (!this.display) return;
                this.display.querySelectorAll('span').forEach(span => {
                    span.classList.remove('highlight-light', 'highlight-dark');
                });
            },

            highlightElement(element, index) {
                this.clearHighlights();
                if (element) {
                    const themeClass = document.body.dataset.theme === 'dark' ? 'highlight-dark' : 'highlight-light';
                    element.classList.add(themeClass);
                    AppState.lastHighlightedIndex = index;

                    // Scroll to highlighted element
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        };

        // ========== PLAYBACK CONTROLLER ==========
        const PlaybackController = {
            async playParagraph() {
                if (AppState.isPlaying) return;

                const paragraph = AppState.getCurrentParagraph();
                if (!paragraph || paragraph.length === 0) return;

                AppState.isPlaying = true;
                AppState.currentWordIndex = 0;
                await this.speakNextWord();
            },

            pauseParagraph() {
                AppState.isPlaying = false;
                TTS.cancel();
            },

            restartParagraph() {
                this.pauseParagraph();
                ParagraphRenderer.clearHighlights();
                AppState.currentWordIndex = 0;
                this.playParagraph();
            },

            async speakNextWord() {
                const paragraph = AppState.getCurrentParagraph();
                if (!AppState.isPlaying || !paragraph || AppState.currentWordIndex >= paragraph.length) {
                    AppState.isPlaying = false;
                    return;
                }

                const word = paragraph[AppState.currentWordIndex];
                if (!word || this.isNewline(word)) {
                    AppState.currentWordIndex++;
                    await this.speakNextWord();
                    return;
                }

                if (AppState.isPlaying) ParagraphRenderer.clearHighlights();

                const delay = this.getPlaybackDelay();
                const showThai = document.getElementById('showThai')?.checked;
                const showEnglish = document.getElementById('showEnglish')?.checked;
                const showPersian = document.getElementById('showPersian')?.checked;

                if (showThai && word.th && word.th !== "\n") {
                    await this.speakWord(word.th, 'th-TH', AppState.currentWordIndex, true);
                }

                if (showEnglish && word.en && word.en !== "\n") {
                    await this.speakWord(word.en, 'en-US', AppState.currentWordIndex, true);
                }

                if (showPersian && word.fa && word.fa !== "\n") {
                    await this.speakWord(word.fa, 'fa-IR', AppState.currentWordIndex, true);
                }

                AppState.currentWordIndex++;
                setTimeout(() => { if (AppState.isPlaying) this.speakNextWord(); }, delay);
            },

            async speakWord(text, lang, index, autoAdvance = false) {
                return new Promise(resolve => {
                    if (!text || text === "\n") {
                        resolve();
                        return;
                    }

                    const pairDiv = ParagraphRenderer.display?.querySelector(`.word-pair[data-index="${index}"]`);
                    const span = pairDiv ? pairDiv.querySelector(`span[lang="${lang}"]`) : null;

                    if (span) {
                        ParagraphRenderer.highlightElement(span, index);
                    }

                    TTS.speak(text, lang, () => {
                        if (autoAdvance && AppState.isPlaying && span) {
                            span.classList.remove('highlight-light', 'highlight-dark');
                        }
                        resolve();
                    });
                });
            },

            playWord(text, lang, span, index) {
                if (!text || text === "\n") return;
                ParagraphRenderer.highlightElement(span, index);
                TTS.cancel();
                this.speakWord(text, lang, index, false);
            },

            isNewline(word) {
                return word.th === "\n" && word.en === "\n" && word.fa === "\n";
            },

            getPlaybackDelay() {
                const delaySec = parseFloat(document.getElementById('playbackDelay')?.value || Storage.load('playbackDelay', '1500'));
                return Math.min(Math.max(isNaN(delaySec) ? 1500 : delaySec, 500), 5000);
            }
        };

        // ========== QUIZ SYSTEM ==========
        const QuizSystem = {
            data: [],
            currentQuestion: 0,
            score: 0,
            attempts: 0,

            buildFromParagraph(paragraph) {
                this.data = paragraph.map(word => ({
                    ...word,
                    attempted: false,
                    correct: false
                }));
                this.currentQuestion = 0;
                this.score = 0;
                this.attempts = 0;
                this.render();
            },

            render() {
                const quizContainer = document.getElementById("quiz");
                if (!quizContainer) return;

                quizContainer.innerHTML = "";

                if (!this.data.length) {
                    quizContainer.textContent = "No quiz available for this paragraph.";
                    return;
                }

                const question = this.data[this.currentQuestion];
                const questionLang = document.querySelector('input[name="questionLang"]:checked')?.value;
                const answerLang = document.querySelector('input[name="answerLang"]:checked')?.value;

                if (!this.validateLanguages(questionLang, answerLang, quizContainer)) return;

                this.renderQuestion(question, questionLang, quizContainer);
                this.renderOptions(question, answerLang, quizContainer);
                FontManager.apply();
            },

            validateLanguages(questionLang, answerLang, container) {
                if (!questionLang || !answerLang) {
                    container.textContent = "Select both Question and Answer languages.";
                    return false;
                }
                if (questionLang === answerLang) {
                    container.textContent = "Answer language must be different from Question.";
                    return false;
                }
                return true;
            },

            renderQuestion(question, questionLang, container) {
                const questionEl = document.createElement("div");
                questionEl.className = "quiz-question";
                questionEl.textContent = question[questionLang] || "";
                questionEl.lang = this.getLangCode(questionLang);
                questionEl.style.cursor = "pointer";
                questionEl.addEventListener("click", () => {
                    TTS.speak(question[questionLang], this.getLangCode(questionLang));
                });
                container.appendChild(questionEl);
            },

            renderOptions(question, answerLang, container) {
                const options = this.generateOptions(question, answerLang);
                const optionsContainer = document.createElement("div");
                optionsContainer.className = "quiz-options";

                options.forEach(option => {
                    const optionEl = this.createOptionElement(option, answerLang, question);
                    optionsContainer.appendChild(optionEl);
                });

                container.appendChild(optionsContainer);
            },

            generateOptions(question, answerLang) {
                const correctAnswer = question[answerLang];
                let options = this.data
                    .map(q => q[answerLang])
                    .filter((val, idx, arr) => arr.indexOf(val) === idx && val)
                    .filter(opt => opt !== correctAnswer)
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 3);

                options = [correctAnswer, ...options].sort(() => Math.random() - 0.5);
                return options;
            },

            createOptionElement(option, answerLang, question) {
                const optionEl = document.createElement("div");
                optionEl.lang = this.getLangCode(answerLang);
                optionEl.className = "quiz-option";
                optionEl.textContent = option;

                optionEl.addEventListener("click", () => {
                    TTS.speak(option, this.getLangCode(answerLang));
                    this.handleAnswer(optionEl, option, question[answerLang], question);
                });

                return optionEl;
            },

            handleAnswer(optionEl, selectedAnswer, correctAnswer, question) {
                if (selectedAnswer === correctAnswer) {
                    if (!question.correct) {
                        optionEl.classList.add("correct");
                        this.score++;
                        question.correct = true;
                        question.attempted = true;
                        this.attempts++;
                    }
                } else {
                    optionEl.classList.add("incorrect");
                    question.correct = false;
                    question.attempted = true;
                    this.attempts++;
                }

                document.getElementById("score").textContent = `Score: ${this.score}/${this.attempts}`;
            },

            getLangCode(lang) {
                const codes = { th: 'th-TH', en: 'en-US', fa: 'fa-IR' };
                return codes[lang] || 'th-TH';
            },

            nextQuestion() {
                this.currentQuestion++;
                this.render();
            },

            previousQuestion() {
                this.currentQuestion = Math.max(0, this.currentQuestion - 1);
                this.resetQuestionStates();
                this.render();
            },

            retry() {
                this.resetQuestionStates();
                this.render();
            },

            resetQuestionStates() {
                this.data.forEach(question => {
                    question.attempted = false;
                    question.correct = false;
                });
            }
        };

        // ========== NAVIGATION CONTROLLER ==========
        const NavigationController = {
            bookSelect: null,
            chapterSelect: null,
            paragraphSelect: null,

            init(bookSelect, chapterSelect, paragraphSelect) {
                this.bookSelect = bookSelect;
                this.chapterSelect = chapterSelect;
                this.paragraphSelect = paragraphSelect;
            },

            async handleBookChange(bookFilename) {
                Storage.save('currentBook', bookFilename);
                await AppController.loadBook(bookFilename);
            },

            handleChapterChange(chapterIndex) {
                AppState.currentChapter = chapterIndex;
                AppController.populateParagraphs();
            },

            handleParagraphChange(paragraphIndex) {
                AppState.currentParagraph = paragraphIndex;
                AppController.loadParagraph();
            },

            nextParagraph() {
                const max = AppState.currentBook?.chapters?.[AppState.currentChapter]?.paragraphs?.length || 0;
                if (AppState.currentParagraph < max - 1) {
                    AppState.currentParagraph++;
                    this.paragraphSelect.value = AppState.currentParagraph;
                    AppController.loadParagraph();
                }
            },

            previousParagraph() {
                if (AppState.currentParagraph > 0) {
                    AppState.currentParagraph--;
                    this.paragraphSelect.value = AppState.currentParagraph;
                    AppController.loadParagraph();
                }
            }
        };

        // ========== MAIN APPLICATION CONTROLLER ==========
        const AppController = {
            async init() {
                AppState.initialize();
                ThemeManager.init();
                FontManager.init();
                this.setupEventListeners();
                await this.loadBooks();
            },

            setupEventListeners() {
                document.getElementById('settingsBtn').addEventListener('click', () => SettingsManager.show());
            },

            async loadBooks() {
                const bookList = await BookManager.loadBookList();
                this.populateBookSelect(bookList);

                if (bookList.length > 0) {
                    await this.loadBook(AppState.currentBook || bookList[0].bookFilename);
                }
            },

            populateBookSelect(bookList) {
                const bookSelect = document.getElementById('bookSelect');
                if (!bookSelect) return;

                bookSelect.innerHTML = '';

                if (bookList.length === 0) {
                    bookSelect.innerHTML = '<option>No books available</option>';
                    bookSelect.disabled = true;
                    return;
                }

                bookList.forEach(book => {
                    const option = document.createElement('option');
                    option.value = book.bookFilename;
                    option.textContent = book.bookTitle;
                    bookSelect.appendChild(option);
                });

                bookSelect.value = AppState.currentBook || bookList[0].bookFilename;
            },

            async loadBook(filename) {
                try {
                    AppState.currentBook = await BookManager.loadBook(filename);
                    Storage.save('currentBook', filename);
                    this.populateChapters();
                } catch (error) {
                    const contentArea = document.getElementById('contentArea');
                    if (contentArea) {
                        contentArea.innerHTML =
                            `<div class="error-message">Error loading book: ${error.message}. Please check that the book file exists at /assets/books/${filename}</div>`;
                    }
                }
            },

            populateChapters() {
                const chapterSelect = document.getElementById('chapterSelect');
                if (!chapterSelect) return;

                chapterSelect.innerHTML = '';

                if (!AppState.currentBook?.chapters?.length) {
                    chapterSelect.innerHTML = '<option>No chapters available</option>';
                    chapterSelect.disabled = true;
                    return;
                }

                AppState.currentBook.chapters.forEach((chapter, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = chapter.chapterTitle || `Chapter ${index + 1}`;
                    chapterSelect.appendChild(option);
                });

                AppState.currentChapter = Math.min(AppState.currentChapter, AppState.currentBook.chapters.length - 1);
                chapterSelect.value = AppState.currentChapter;
                chapterSelect.disabled = false;
                this.populateParagraphs();
            },

            populateParagraphs() {
                const paragraphSelect = document.getElementById('paragraphSelect');
                if (!paragraphSelect) return;

                paragraphSelect.innerHTML = '';

                const currentChapter = AppState.currentBook?.chapters?.[AppState.currentChapter];
                if (!currentChapter?.paragraphs?.length) {
                    paragraphSelect.innerHTML = '<option>No paragraphs available</option>';
                    paragraphSelect.disabled = true;
                    return;
                }

                currentChapter.paragraphs.forEach((paragraph, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `Paragraph ${index + 1}`;
                    paragraphSelect.appendChild(option);
                });

                AppState.currentParagraph = Math.min(AppState.currentParagraph, currentChapter.paragraphs.length - 1);
                paragraphSelect.value = AppState.currentParagraph;
                paragraphSelect.disabled = false;
                this.loadParagraph();
            },

            loadParagraph() {
                AppState.saveNavigation();
                this.renderParagraph();
            },

            renderParagraph() {
                const paragraph = AppState.getCurrentParagraph();
                ParagraphRenderer.render(paragraph);
                QuizSystem.buildFromParagraph(paragraph);
            },

            reload() {
                this.initSPA();
                this.loadBooks();
            },

            initSPA() {
                const contentArea = document.getElementById('contentArea');
                const controlsArea = document.getElementById('controlsArea');

                if (!contentArea || !controlsArea) return;

                contentArea.innerHTML = this.getMainHTML();
                controlsArea.innerHTML = this.getControlsHTML();

                this.bindUIElements();
                this.restoreSettings();
            },

            getMainHTML() {
                return `
                    <section id="bookSelectionControls" class="controls">
                        <label>Book: <select id="bookSelect"></select></label>
                        <label>Chapter: <select id="chapterSelect"></select></label>
                        <label>Paragraph: <select id="paragraphSelect"></select></label>
                    </section>
                    
                    <section id="paragraphSec">
                        <h3>Paragraph Content</h3>
                        <div id="paragraphDisplay"></div>
                        <div id="paragraphControls" class="controls">
                            <div class="paragraph-controls-row">
                                <button id="playBtn">▶️</button>
                                <button id="pauseBtn">⏸️</button>
                                <button id="restartBtn">⏮️</button>
                                <button id="prevParagraph">⬅️</button>
                                <button id="nextParagraph">➡️</button>
                            </div>
                            <div class="paragraph-controls-row">
                                <label><input type="checkbox" id="showThai" checked> Thai</label>
                                <label><input type="checkbox" id="showEnglish"> English</label>
                                <label><input type="checkbox" id="showPersian"> Persian</label>
                                <label>Delay: <input type="number" id="playbackDelay" value="1500" min="500" max="5000" step="100"></label>
                            </div>
                        </div>
                    </section>
                    
                    <section id="quizSec">
                        <h3>Practice Quiz</h3>
                        <div id="quiz"></div>
                        <div id="quizControls">
                            <div class="quiz-row quiz-row-top">
                                <button id="prevQ">⬅️</button>
                                <button id="nextQ">➡️</button>
                                <button id="retryQuiz">🔄</button>
                                <label><input type="checkbox" id="incorrectOnly"> Incorrect Only</label>
                                <div id="score">Score: 0/0</div>
                            </div>
                            <div class="quiz-row quiz-row-bottom">
                                <div class="lang-select">
                                    <span>Question: </span>
                                    <label><input type="radio" name="questionLang" id="questionThai" value="th" checked> Thai</label>
                                    <label><input type="radio" name="questionLang" id="questionEnglish" value="en"> English</label>
                                    <label><input type="radio" name="questionLang" id="questionPersian" value="fa"> Persian</label>
                                </div>
                                <div class="lang-select">
                                    <span>Answer: </span>
                                    <label><input type="radio" name="answerLang" id="answerThai" value="th"> Thai</label>
                                    <label><input type="radio" name="answerLang" id="answerEnglish" value="en" checked> English</label>
                                    <label><input type="radio" name="answerLang" id="answerPersian" value="fa"> Persian</label>
                                </div>
                            </div>
                        </div>
                    </section>`;
            },

            getControlsHTML() {
                return ``; // Empty controls area - all controls are in main content
            },

            bindUIElements() {
                // Initialize component references
                ParagraphRenderer.init(document.getElementById('paragraphDisplay'));
                NavigationController.init(
                    document.getElementById('bookSelect'),
                    document.getElementById('chapterSelect'),
                    document.getElementById('paragraphSelect')
                );

                // Event delegation for dynamic elements
                document.addEventListener('change', (e) => {
                    this.handleSettingChange(e);
                });

                // Playback controls
                document.getElementById('playBtn')?.addEventListener('click', () => PlaybackController.playParagraph());
                document.getElementById('pauseBtn')?.addEventListener('click', () => PlaybackController.pauseParagraph());
                document.getElementById('restartBtn')?.addEventListener('click', () => PlaybackController.restartParagraph());
                document.getElementById('nextParagraph')?.addEventListener('click', () => NavigationController.nextParagraph());
                document.getElementById('prevParagraph')?.addEventListener('click', () => NavigationController.previousParagraph());

                // Quiz controls
                document.getElementById('prevQ')?.addEventListener('click', () => QuizSystem.previousQuestion());
                document.getElementById('nextQ')?.addEventListener('click', () => QuizSystem.nextQuestion());
                document.getElementById('retryQuiz')?.addEventListener('click', () => QuizSystem.retry());

                // Language settings
                this.bindLanguageSettings();
            },

            handleSettingChange(event) {
                const handlers = {
                    'bookSelect': () => NavigationController.handleBookChange(event.target.value),
                    'chapterSelect': () => NavigationController.handleChapterChange(+event.target.value),
                    'paragraphSelect': () => NavigationController.handleParagraphChange(+event.target.value),
                    'showThai': () => this.saveAndRender('showThai', event.target.checked),
                    'showEnglish': () => this.saveAndRender('showEnglish', event.target.checked),
                    'showPersian': () => this.saveAndRender('showPersian', event.target.checked),
                    'playbackDelay': () => this.handlePlaybackDelayChange(event.target)
                };

                const handler = handlers[event.target.id];
                if (handler) handler();
            },

            saveAndRender(setting, value) {
                Storage.save(setting, value ? '1' : '0');
                this.renderParagraph();
            },

            handlePlaybackDelayChange(input) {
                let value = parseFloat(input.value);
                if (isNaN(value)) value = 1500;
                value = Math.min(Math.max(value, 500), 5000);
                input.value = value;
                Storage.save('playbackDelay', input.value);
            },

            bindLanguageSettings() {
                const savedQuestionLang = Storage.load('questionLang', 'th');
                const savedAnswerLang = Storage.load('answerLang', 'en');

                const questionRadio = document.querySelector(`input[name="questionLang"][value="${savedQuestionLang}"]`);
                const answerRadio = document.querySelector(`input[name="answerLang"][value="${savedAnswerLang}"]`);

                if (questionRadio) questionRadio.checked = true;
                if (answerRadio) answerRadio.checked = true;

                document.querySelectorAll('input[name="questionLang"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        Storage.save('questionLang', e.target.value);
                        this.renderParagraph();
                    });
                });

                document.querySelectorAll('input[name="answerLang"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        Storage.save('answerLang', e.target.value);
                        this.renderParagraph();
                    });
                });
            },

            restoreSettings() {
                const showThai = document.getElementById('showThai');
                const showEnglish = document.getElementById('showEnglish');
                const showPersian = document.getElementById('showPersian');
                const playbackDelay = document.getElementById('playbackDelay');

                if (showThai) showThai.checked = Storage.loadBool('showThai', true);
                if (showEnglish) showEnglish.checked = Storage.loadBool('showEnglish', false);
                if (showPersian) showPersian.checked = Storage.loadBool('showPersian', false);
                if (playbackDelay) playbackDelay.value = Storage.load('playbackDelay', '1500');
            }
        };

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', () => {
            AppController.initSPA();
            AppController.init();
        });
    </script>
</body>

</html>