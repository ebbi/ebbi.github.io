<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai&family=Chakra+Petch&display=swap"
        rel="stylesheet" />
    <title>ฝึกฝน Thai</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <style>
        /* CSS Custom Properties for Theming */
        :root {
            --primary-color: #00247D;
            --primary-light: #66aaff;
            --background-light: #f9f9f9;
            --background-dark: #222;
            --text-light: #000;
            --text-dark: #eee;
            --border-light: #ccc;
            --border-dark: #555;
            --correct-color: #4caf50;
            --incorrect-color: #f44336;
            --highlight-light: yellow;
            --highlight-dark: orange;
            --header-height: 60px;
        }

        /* Base page styling - MOBILE FIRST */
        body {
            font-size: clamp(14px, 2.5vw, 18px);
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            transition: background 0.3s, color 0.3s;
            background: var(--background-light);
            color: var(--text-light);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        body[data-theme="dark"] {
            background: var(--background-dark);
            color: var(--text-dark);
        }

        /* Header Styling */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--primary-color);
            color: white;
            padding: 0.3em 1em;
            height: auto;
            min-height: 2.5em;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        #appTitle {
            font-size: 1.2rem;
            font-weight: bold;
            height: 100%;
            display: flex;
            align-items: center;
            font-family: inherit;
            /* Will be overridden by FontManager */
        }

        #headerControls {
            display: flex;
            align-items: center;
            gap: 0.8em;
            /* Equal spacing between all controls */
            height: 100%;
            font-size: 1rem;
            /* Consistent 1rem font size */
        }

        .header-label {
            display: flex;
            align-items: center;
            gap: 0.4em;
            color: white;
            margin: 0;
            height: 2em;
            font-size: 1rem;
            /* Consistent 1rem font size */
        }

        .header-label select {
            height: 2em;
            padding: 0.3em 0.5em;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            /* Consistent 1rem font size */
            cursor: pointer;
            box-sizing: border-box;
        }

        .header-label select:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .header-label select option {
            background: var(--primary-color);
            color: white;
        }

        /* Header icons - completely remove button styling */
        #themeToggle,
        #settingsBtn {
            background: none !important;
            border: none !important;
            color: white;
            padding: 0.3em;
            cursor: pointer;
            font-size: 1.1rem;
            /* Slightly larger for icons */
            height: 2em;
            width: 2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
            border-radius: 4px;
            /* Explicitly override any inherited button styles */
            line-height: normal;
            box-shadow: none;
            text-shadow: none;
            font-family: inherit;
        }

        #themeToggle:hover,
        #settingsBtn:hover {
            background: rgba(255, 255, 255, 0.1) !important;
        }

        /* Remove dark mode button styling for header icons */
        body[data-theme="dark"] #themeToggle,
        body[data-theme="dark"] #settingsBtn {
            background: none !important;
            border: none !important;
            color: white;
        }

        body[data-theme="dark"] #themeToggle:hover,
        body[data-theme="dark"] #settingsBtn:hover {
            background: rgba(255, 255, 255, 0.1) !important;
        }

        /* Remove the old settingsInline styles */
        #settingsInline {
            display: none;
        }

        /* Mobile adjustments for header */
        @media (max-width: 600px) {
            header {
                padding: 0.3em 0.8em;
            }

            #appTitle {
                font-size: 1.1rem;
            }

            #headerControls {
                gap: 0.6em;
                font-size: 0.9rem;
            }

            .header-label {
                font-size: 0.9rem;
                height: 1.8em;
            }

            .header-label select {
                font-size: 0.9rem;
                height: 1.8em;
                padding: 0.2em 0.4em;
            }

            #themeToggle,
            #settingsBtn {
                height: 1.8em;
                width: 1.8em;
                font-size: 1rem;
                padding: 0.2em;
            }
        }

        /* Ensure Thai font is applied to app title */
        #appTitle.thai-font.tahoma {
            font-family: Tahoma, sans-serif;
        }

        #appTitle.thai-font.noto {
            font-family: 'Noto Sans Thai', sans-serif;
        }

        #appTitle.thai-font.chakra {
            font-family: 'Chakra Petch', sans-serif;
        }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 0;
        }

        /* Scrollable content area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 1em;
            -webkit-overflow-scrolling: touch;
            padding-top: 0.5em;
            scroll-padding-top: 120px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            overflow-anchor: none;
        }

        /* Fixed controls at bottom */
        .controls-area {
            background: var(--background-light);
            border-top: 1px solid var(--border-light);
            padding: 1em;
            flex-shrink: 0;
            position: sticky;
            bottom: 0;
            z-index: 90;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        body[data-theme="dark"] .controls-area {
            background: var(--background-dark);
            border-top-color: var(--border-dark);
        }

        /* Section styling */
        section {
            margin-bottom: 1.5em;
            padding-bottom: 1em;
            border-bottom: 1px solid var(--border-light);
        }

        body[data-theme="dark"] section {
            border-bottom-color: var(--border-dark);
        }

        /* Help block styling */
        details {
            padding: 0.5em 1em;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            margin: 0.5em 0;
            font-size: 0.9em;
            font-weight: normal;
            text-align: left;
            background: var(--background-light);
            color: var(--text-light);
        }

        details summary {
            cursor: pointer;
            color: var(--primary-color);
        }

        body[data-theme="dark"] details {
            background: #2a2a2a;
            border: 1px solid var(--border-dark);
            color: var(--text-dark);
        }

        body[data-theme="dark"] details summary {
            color: var(--primary-light);
        }

        /* Style nested content in details */
        details p {
            margin: 0.5em 0;
            line-height: 1.5;
            text-align: left;
        }

        details ol {
            margin: 0.5em 1.5em;
            padding-left: 1.2em;
        }

        details ol li {
            margin: 0.4em 0;
        }

        /* === Base Styles for Inputs, Selects, Buttons === */
        button,
        select,
        input[type="number"] {
            font-size: 1em;
            line-height: 1.5;
            padding: 0.4em 0.6em;
            height: 2em;
            border-radius: 4px;
            border: 1px solid var(--border-light);
            background: #f0f0f0;
            color: var(--text-light);
            cursor: pointer;
            box-sizing: border-box;
            vertical-align: middle;
            transition: background 0.2s, color 0.2s, border-color 0.2s;
        }

        /* Number input text alignment */
        input[type="number"] {
            text-align: center;
        }

        /* Hover states */
        button:hover,
        input[type="number"]:hover,
        select:hover {
            background: #e0e0e0;
        }

        /* Dark theme adjustments */
        body[data-theme="dark"] button,
        body[data-theme="dark"] input[type="number"],
        body[data-theme="dark"] select {
            background: #333;
            border: 1px solid var(--border-dark);
            color: var(--text-dark);
        }

        body[data-theme="dark"] button:hover,
        body[data-theme="dark"] input[type="number"]:hover,
        body[data-theme="dark"] select:hover {
            background: #444;
        }

        /* Dark theme adjustments */
        body[data-theme="dark"] button,
        body[data-theme="dark"] input[type="number"],
        body[data-theme="dark"] select {
            background: #333;
            border: 1px solid var(--border-dark);
            color: var(--text-dark);
        }

        body[data-theme="dark"] button:hover,
        body[data-theme="dark"] input[type="number"]:hover,
        body[data-theme="dark"] select:hover {
            background: #444;
        }

        body[data-theme="dark"] input[type="checkbox"] {
            accent-color: var(--primary-light);
        }

        /* Theme Toggle Button */
        #themeToggle {
            background: none;
            border: none;
            width: auto;
            min-width: 0;
            padding: 0 0.5em;
            font-size: 1em;
            line-height: 1.5;
        }

        /* Label alignment - ensure consistent font size */
        label {
            display: flex;
            align-items: center;
            gap: 0.3em;
            font-size: 1em;
            /* Ensure consistent base font size */
            white-space: nowrap;
        }

        /* Label alignment */
        label {
            display: flex;
            align-items: center;
            gap: 0.3em;
            font-size: 0.9em;
            white-space: nowrap;
        }

        /* Thai Font Styling */
        .thai-font.tahoma {
            font-family: Tahoma, sans-serif;
        }

        .thai-font.noto {
            font-family: 'Noto Sans Thai', sans-serif;
        }

        .thai-font.chakra {
            font-family: 'Chakra Petch', sans-serif;
        }

        /* Highlighting */
        .highlight-light {
            background: var(--highlight-light);
            color: black;
        }

        .highlight-dark {
            background: var(--highlight-dark);
            color: black;
        }

        #paragraphDisplay {
            margin: 0.5em 0 1em 0;
            white-space: pre-wrap;
            width: 100%;
            box-sizing: border-box;
            line-height: 1.6;
            min-height: 150px;
            max-height: 45vh;
            overflow-y: auto;
            padding: 1em;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            background: var(--background-light);
            scroll-margin-top: 100px;
        }

        body[data-theme="dark"] #paragraphDisplay {
            background: #2a2a2a;
            border-color: var(--border-dark);
        }

        :lang(th-TH) {
            font-size: larger;
        }

        :lang(fa-IR) {
            direction: rtl;
        }

        .word-pair {
            display: inline-block;
            vertical-align: top;
            margin: 0 0.3em 0.5em 0;
            cursor: pointer;
            padding: 0.2em;
            border-radius: 3px;
            transition: background-color 0.2s;
        }

        .word-pair:hover {
            background-color: rgba(0, 36, 125, 0.1);
        }

        body[data-theme="dark"] .word-pair:hover {
            background-color: rgba(102, 170, 255, 0.1);
        }

        .word-pair span[lang="th-TH"] {
            display: block;
            word-break: keep-all;
            overflow-wrap: break-word;
            font-size: large;
        }

        .word-pair span[lang="en-US"] {
            border-top: 1px solid lightskyblue;
            display: block;
            word-break: normal;
            overflow-wrap: normal;
            white-space: normal;
            margin-top: 0.1em;
            color: rgb(5, 154, 247);
            font-size: 0.9em;
        }

        .word-pair span[lang="fa-IR"] {
            border-top: 1px solid lightskyblue;
            display: block;
            word-break: keep-all;
            overflow-wrap: break-word;
            direction: rtl;
            color: green;
            font-size: 0.9em;
        }

        /* Quiz styling */
        #quiz {
            margin-top: 1em;
        }

        .quiz-heading {
            font-weight: 600;
            margin-bottom: 0.5em;
        }

        .quiz-question {
            font-size: 1.25rem;
            margin: .1em 0;
            padding: 0.5em;
            background: rgba(0, 36, 125, 0.05);
            border-radius: 5px;
        }

        body[data-theme="dark"] .quiz-question {
            background: rgba(102, 170, 255, 0.1);
        }

        .quiz-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5em;
            margin-top: 0.5em;
        }

        .quiz-option {
            border: 1px solid var(--border-light);
            padding: 0.5em 0.8em;
            cursor: pointer;
            border-radius: 5px;
            user-select: none;
            flex: 1;
            min-width: 120px;
            text-align: center;
            transition: all 0.2s;
        }

        .quiz-option.correct {
            background: var(--correct-color);
            color: white;
            border-color: var(--correct-color);
        }

        .quiz-option.incorrect {
            background: var(--incorrect-color);
            color: white;
            border-color: var(--incorrect-color);
        }

        #quizControls {
            display: flex;
            flex-direction: column;
            gap: 0.8em;
            margin-top: 1em;
        }

        .quiz-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.6em;
        }

        .quiz-row-top {
            justify-content: flex-start;
        }

        .quiz-row-bottom {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.4em;
        }

        @media (min-width: 600px) {
            .quiz-row-bottom {
                flex-direction: row;
                align-items: center;
            }
        }

        .lang-select {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4em 0.8em;
        }

        /* Paragraph controls responsive layout */
        #paragraphControls {
            display: flex;
            flex-direction: column;
            gap: 0.5em;
        }

        /* Paragraph label styling */
        .paragraph-label {
            font-weight: bold;
            font-size: 1em;
            color: var(--text-light);
            margin: 0 0.2em;
        }

        body[data-theme="dark"] .paragraph-label {
            color: var(--text-dark);
        }

        /* Updated paragraph controls layout */
        .paragraph-controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5em;
            align-items: center;
            justify-content: center;
        }

        /* Language Controls Styling - Compact Details Version */
        .language-controls {
            width: 100%;
            max-width: 280px;
            margin: 0.3em auto;
            font-size: 1rem;
            /* Set base font size to 1rem */
        }

        .language-controls details {
            border: 1px solid var(--border-light);
            border-radius: 6px;
            padding: 0.4em;
            background: var(--background-light);
            margin: 0;
            font-size: 1rem;
            /* Ensure all text uses 1rem */
        }

        body[data-theme="dark"] .language-controls details {
            background: #2a2a2a;
            border-color: var(--border-dark);
        }

        .language-controls summary {
            font-weight: bold;
            cursor: pointer;
            padding: 0.2em 0.4em;
            margin: -0.4em -0.4em 0 -0.4em;
            border-radius: 4px;
            list-style: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1rem;
            /* Summary uses 1rem */
        }

        .language-controls summary::-webkit-details-marker {
            display: none;
        }

        .language-controls summary::after {
            content: "▶";
            font-size: 0.8em;
            transition: transform 0.2s;
            margin-left: 0.5em;
        }

        .language-controls details[open] summary::after {
            transform: rotate(90deg);
        }

        .language-controls-content {
            padding: 0.6em 0.2em 0.2em 0.2em;
            font-size: 1rem;
            /* Content uses 1rem */
        }

        .control-type {
            font-size: 0.85em;
            font-weight: bold;
            min-width: 50px;
            text-align: left;
        }

        .language-checkboxes {
            display: flex;
            justify-content: space-between;
            flex: 1;
            gap: 0.3em;
        }

        .language-checkbox-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .language-checkbox-group label {
            margin: 0;
            display: flex;
            justify-content: center;
        }

        .language-checkbox-group input[type="checkbox"] {
            margin: 0;
            width: 1.1em;
            height: 1.1em;
        }

        .language-title {
            font-size: 0.85em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 0.1em;
        }

        /* Mobile adjustments for language controls */
        @media (max-width: 600px) {
            .language-controls {
                max-width: 100%;
                font-size: 0.8em;
            }

            .language-controls details {
                padding: 0.3em;
            }

            .control-type {
                min-width: 45px;
                font-size: 0.8em;
            }

            .language-title {
                font-size: 0.8em;
            }

            .language-checkboxes {
                gap: 0.2em;
            }

            .language-controls-content {
                padding: 0.4em 0.1em 0.1em 0.1em;
            }
        }

        body[data-theme="dark"] .language-controls {
            background: #2a2a2a;
            border-color: var(--border-dark);
        }

        .language-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.2em 0;
            margin-bottom: 0.2em;
            border-bottom: 1px solid var(--border-light);
            font-size: 1rem;
            /* Header row uses 1rem */
        }

        .language-controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.2em 0;
            font-size: 1rem;
            /* Control rows use 1rem */
        }

        /* Updated Language Options panel for delay input */
        .language-controls-row .language-checkbox-group input[type="number"] {
            width: 5em;
            /* Reduced width for 5 characters */
            height: 2em;
            padding: 0.3em;
            font-size: 1rem;
            /* Input uses 1rem */
            text-align: center;
        }

        /* Ensure proper spacing in the delay row */
        .language-controls-row:last-child {
            margin-top: 0.3em;
            padding-top: 0.3em;
            border-top: 1px solid var(--border-light);
        }


        .control-type {
            font-size: 1rem;
            /* Control type uses 1rem */
            font-weight: bold;
            min-width: 50px;
            text-align: left;
        }

        .language-checkboxes {
            display: flex;
            justify-content: space-between;
            flex: 1;
            gap: 0.3em;
        }

        .language-checkbox-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .language-checkbox-group label {
            margin: 0;
            display: flex;
            justify-content: center;
        }

        .language-checkbox-group input[type="checkbox"] {
            margin: 0;
            width: 1.1em;
            height: 1.1em;
        }

        .language-title {
            font-size: 1rem;
            /* Language titles use 1rem */
            font-weight: bold;
            text-align: center;
            margin-bottom: 0.1em;
        }

        /* Mobile adjustments for language controls */
        @media (max-width: 600px) {
            .language-controls {
                max-width: 100%;
                padding: 0.6em;
            }

            .control-type {
                min-width: 50px;
                font-size: 0.85em;
            }

            .language-title {
                font-size: 0.85em;
            }

            .language-checkboxes {
                gap: 0.3em;
            }
        }

        body[data-theme="dark"] .language-controls {
            background: #2a2a2a;
            border-color: var(--border-dark);
        }


        body[data-theme="dark"] .language-controls-row:last-child {
            border-top-color: var(--border-dark);
        }

        .language-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.5em;
            margin-bottom: 0.5em;
            border-bottom: 1px solid var(--border-light);
            font-weight: bold;
        }

        .language-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.3em 0;
        }

        .language-name {
            flex: 1;
            font-size: 0.9em;
        }

        .control-group {
            display: flex;
            gap: 1.5em;
            align-items: center;
        }

        .control-label {
            font-size: 0.8em;
            font-weight: normal;
            text-align: center;
            min-width: 50px;
        }

        .language-controls label {
            margin: 0;
            display: flex;
            justify-content: center;
        }

        .language-controls input[type="checkbox"] {
            margin: 0;
        }

        /* Mobile adjustments for the new layout */
        @media (max-width: 600px) {
            .paragraph-controls-row {
                gap: 0.4em;
            }

            /* Make Language Options details inline */
            .paragraph-controls-row .language-controls {
                display: inline-block;
                margin: 0;
            }

            .paragraph-controls-row .language-controls {
                margin-top: 0.3em;
            }

            .language-controls-row .language-checkbox-group input[type="number"] {
                width: 4em;
                /* Slightly smaller on mobile */
            }

            button {
                min-height: 44px;
                min-width: 44px;
            }

            .word-pair {
                margin: 0 0.2em 0.3em 0;
            }

            .quiz-option {
                min-width: 100px;
                padding: 0.6em 0.5em;
            }

            .controls-area {
                padding: 0.8em;
            }

            .content-area {
                padding: 0.8em;
                scroll-padding-top: 100px;
            }

            #paragraphDisplay {
                max-height: 35vh;
                padding: 0.8em;
                scroll-margin-top: 80px;
            }

            .language-controls {
                max-width: 100%;
                font-size: 0.9rem;
                /* Slightly smaller on mobile */
            }

            .language-controls details {
                padding: 0.3em;
            }

            .control-type {
                min-width: 45px;
            }

            .language-controls-content {
                padding: 0.4em 0.1em 0.1em 0.1em;
            }

            .control-group {
                gap: 1em;
            }

            .control-label {
                min-width: 40px;
                font-size: 0.75em;
            }

            .language-name {
                font-size: 0.85em;
            }

            .language-checkboxes {
                gap: 0.2em;
            }

        }

        /* Desktop adjustments */
        @media (min-width: 768px) {
            .content-area {
                padding: 1.5em;
                scroll-padding-top: 120px;
            }

            .controls-area {
                padding: 1.2em;
            }

            .word-pair {
                margin: 0 0.5em 1em 0;
            }

            #paragraphDisplay {
                max-height: 50vh;
            }
        }

        /* Error and status styling */
        .error-message {
            color: var(--incorrect-color);
            background: #ffe6e6;
            padding: 0.5em;
            border-radius: 4px;
            margin: 0.5em 0;
            border: 1px solid var(--incorrect-color);
        }

        .success-message {
            color: var(--correct-color);
            background: #e6ffe6;
            padding: 0.5em;
            border-radius: 4px;
            margin: 0.5em 0;
            border: 1px solid var(--correct-color);
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Selection controls styling */
        #bookSelectionControls {
            background: rgba(0, 36, 125, 0.05);
            padding: 1em;
            border-radius: 8px;
            margin-bottom: 1em;
            position: sticky;
            top: 0;
            z-index: 80;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-light);
            margin-top: 0.5em;
        }

        body[data-theme="dark"] #bookSelectionControls {
            background: rgba(102, 170, 255, 0.1);
            border-color: var(--border-dark);
        }

        /* TTS Status Styles */
        .tts-status-container {
            margin: 1em 0;
            padding: 1em;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .tts-status-success {
            background: #e8f5e8;
            border-left-color: var(--correct-color);
            color: #2d5016;
        }

        .tts-status-error {
            background: #ffeaea;
            border-left-color: var(--incorrect-color);
            color: #8b0000;
        }

        .tts-status-warning {
            background: #fff4e6;
            border-left-color: orange;
            color: #663c00;
        }

        .tts-status-info {
            background: #e8f4fd;
            border-left-color: var(--primary-color);
            color: #004085;
        }

        body[data-theme="dark"] .tts-status-success {
            background: #1a331a;
            color: #90ee90;
        }

        body[data-theme="dark"] .tts-status-error {
            background: #331a1a;
            color: #ff6b6b;
        }

        body[data-theme="dark"] .tts-status-warning {
            background: #332900;
            color: #ffd700;
        }

        body[data-theme="dark"] .tts-status-info {
            background: #1a2833;
            color: #66aaff;
        }

        .tts-setup-steps {
            margin: 1em 0;
            padding: 1em;
            background: var(--background-light);
            border-radius: 8px;
            border: 1px solid var(--border-light);
        }

        body[data-theme="dark"] .tts-setup-steps {
            background: #2a2a2a;
            border-color: var(--border-dark);
        }

        .tts-step {
            margin: 0.5em 0;
            padding: 0.5em;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .tts-language-check {
            display: flex;
            flex-wrap: wrap;
            gap: 1em;
            margin: 1em 0;
        }

        .language-test {
            padding: 0.5em 1em;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .language-test:hover {
            background: var(--primary-light);
        }

        .test-result {
            margin-top: 0.5em;
            font-size: 0.9em;
            opacity: 0.8;
        }

        .success-check {
            color: var(--correct-color);
        }

        .error-cross {
            color: var(--incorrect-color);
        }

        /* Scrollbar styling */
        .content-area::-webkit-scrollbar,
        #paragraphDisplay::-webkit-scrollbar {
            width: 8px;
        }

        .content-area::-webkit-scrollbar-track,
        #paragraphDisplay::-webkit-scrollbar-track {
            background: var(--background-light);
        }

        .content-area::-webkit-scrollbar-thumb,
        #paragraphDisplay::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 4px;
        }

        body[data-theme="dark"] .content-area::-webkit-scrollbar-track,
        body[data-theme="dark"] #paragraphDisplay::-webkit-scrollbar-track {
            background: var(--background-dark);
        }

        body[data-theme="dark"] .content-area::-webkit-scrollbar-thumb,
        body[data-theme="dark"] #paragraphDisplay::-webkit-scrollbar-thumb {
            background: var(--border-dark);
        }

        /* Ensure selects are visible when dropdown opens */
        select:focus {
            position: relative;
            z-index: 1000;
        }

        /* Add specific scroll margin for select elements */
        #bookSelect,
        #chapterSelect,
        #paragraphSelect {
            scroll-margin-top: 120px;
        }

        /* New styles for refactored layout */
        .selection-header {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 0.5em 0 0.5em 0;
            color: var(--primary-color);
            text-align: center;
        }

        body[data-theme="dark"] .selection-header {
            color: var(--primary-light);
        }

        .book-options-details {
            margin-bottom: 1em;
        }

        .book-options-details summary {
            font-weight: bold;
            padding: 0.5em;
            background: rgba(0, 36, 125, 0.05);
            border-radius: 4px;
            cursor: pointer;
        }

        body[data-theme="dark"] .book-options-details summary {
            background: rgba(102, 170, 255, 0.1);
        }

        .book-options-details[open] summary {
            border-radius: 4px 4px 0 0;
        }

        .book-options-content {
            padding: 0.5em;
            background: rgba(0, 36, 125, 0.02);
            border-radius: 0 0 4px 4px;
        }

        body[data-theme="dark"] .book-options-content {
            background: rgba(102, 170, 255, 0.05);
        }

        .book-selection-controls {
            display: flex;
            flex-direction: column;
            gap: 0.5em;
        }

        @media (min-width: 600px) {
            .book-selection-controls {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
        }

        .book-selection-controls label {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.2em;
        }

        /* Ensure proper spacing for mobile */
        @media (max-width: 600px) {
            .selection-header {
                font-size: 1.1rem;
                margin: 0.3em 0;
            }

            .book-options-details {
                margin-bottom: 0.8em;
            }
        }
    </style>

</head>

<body data-theme="light">

    <header>
        <span lang="th" id="appTitle">ฝึกฝน</span>
        <div id="headerControls">
            <label class="header-label">
                Thai Font:
                <select id="thaiFont">
                    <option value="">Default</option>
                    <option value="Tahoma">Tahoma</option>
                    <option value="Noto Sans Thai">Noto Sans Thai</option>
                    <option value="Chakra Petch">Chakra Petch</option>
                </select>
            </label>
            <button id="themeToggle" title="Toggle Day/Night">🌞</button>
            <button id="settingsBtn" title="Settings & Help">⚙️</button>
        </div>
    </header>
    <main>
        <div class="content-area" id="contentArea">
            <!-- Dynamic content will be inserted here -->
        </div>
        <div class="controls-area" id="controlsArea">
            <!-- Controls will be inserted here -->
        </div>
    </main>

    <script>
        // ==================== MODULARIZED VERSION ====================

        // ========== CORE UTILITIES ==========
        const Storage = {
            save: (key, value) => localStorage.setItem(key, value),
            load: (key, defaultValue = '') => localStorage.getItem(key) || defaultValue,
            loadInt: (key, defaultValue = 0) => parseInt(Storage.load(key, defaultValue), 10),
            loadBool: (key, defaultValue = false) => Storage.load(key, defaultValue ? '1' : '0') === '1'
        };

        // ========== ENHANCED TTS MANAGER ==========
        const TTSManager = {
            supportedVoices: [],
            testResults: {},

            initialize() {
                this.loadVoices();
                speechSynthesis.addEventListener('voiceschanged', () => {
                    this.loadVoices();
                });
            },

            loadVoices() {
                this.supportedVoices = speechSynthesis.getVoices();
            },

            isSupported() {
                return 'speechSynthesis' in window && typeof SpeechSynthesisUtterance !== 'undefined';
            },

            getLanguageVoices(lang) {
                return this.supportedVoices.filter(voice =>
                    voice.lang.startsWith(lang) || voice.lang.includes(lang)
                );
            },

            hasLanguageSupport(lang) {
                return this.getLanguageVoices(lang).length > 0;
            },

            testLanguage(lang, text) {
                return new Promise((resolve) => {
                    if (!this.isSupported()) {
                        resolve({ success: false, error: 'TTS not supported' });
                        return;
                    }

                    if (!this.hasLanguageSupport(lang)) {
                        resolve({ success: false, error: `No ${lang} voices available` });
                        return;
                    }

                    try {
                        const utterance = new SpeechSynthesisUtterance(text);
                        utterance.lang = lang;
                        utterance.volume = 0.7;

                        utterance.onend = () => {
                            resolve({ success: true, voices: this.getLanguageVoices(lang) });
                        };

                        utterance.onerror = (error) => {
                            resolve({ success: false, error: error.error });
                        };

                        speechSynthesis.speak(utterance);
                    } catch (error) {
                        resolve({ success: false, error: error.message });
                    }
                });
            },

            async comprehensiveTest() {
                const tests = [
                    { lang: 'en-US', text: 'Hello, this is English text-to-speech', name: 'English' },
                    { lang: 'th-TH', text: 'สวัสดี นี่คือการทดสอบเสียงพูดภาษาไทย', name: 'Thai' },
                    { lang: 'fa-IR', text: 'سلام، این تست گفتار فارسی است', name: 'Persian' }
                ];

                this.testResults = {};
                let allPassed = true;
                const isFirefox = /firefox|fxios/.test(navigator.userAgent.toLowerCase()) && !/seamonkey/.test(navigator.userAgent.toLowerCase());
                const isRaspberryPi = this.detectRaspberryPi();

                for (const test of tests) {
                    const result = await this.testLanguage(test.lang, test.text);

                    // Special handling for Firefox on Raspberry Pi
                    if (isFirefox && isRaspberryPi && !result.success) {
                        this.testResults[test.lang] = {
                            ...result,
                            name: test.name,
                            text: test.text,
                            note: 'Firefox on Raspberry Pi may require eSpeak installation. Run: sudo apt install espeak espeak-data'
                        };
                    } else {
                        this.testResults[test.lang] = {
                            ...result,
                            name: test.name,
                            text: test.text
                        };
                    }

                    if (!result.success) {
                        allPassed = false;
                    }

                    // Small delay between tests
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                return allPassed;
            },

            getSetupInstructions() {
                const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                const userAgent = navigator.userAgent.toLowerCase();

                // More specific browser detection
                const isChrome = /chrome|chromium|crios/.test(userAgent) && !/edg|opr|opera|firefox|safari/.test(userAgent);
                const isFirefox = /firefox|fxios/.test(userAgent) && !/seamonkey/.test(userAgent);
                const isSafari = /safari/.test(userAgent) && !/chrome|chromium|crios|android|firefox|opr|opera/.test(userAgent);
                const isEdge = /edg/.test(userAgent);

                if (isMobile) {
                    return this.getMobileSetupInstructions(isChrome, isSafari, isFirefox, isEdge);
                } else {
                    return this.getDesktopSetupInstructions(isChrome, isSafari, isFirefox, isEdge);
                }
            },
            getMobileSetupInstructions(isChrome, isSafari, isFirefox) {
                let instructions = '';

                if (isChrome) {
                    instructions = `
            <div class="tts-setup-steps">
                <h4>Android Chrome Setup:</h4>
                <div class="tts-step">
                    <strong>1. Install Language Packs:</strong>
                    <p>Go to Settings → Accessibility → Text-to-speech output → Google Text-to-speech engine → Install voice data</p>
                </div>
                <div class="tts-step">
                    <strong>2. Download Languages:</strong>
                    <p>Install English, Thai, and Persian language packs for full functionality</p>
                </div>
                <div class="tts-step">
                    <strong>3. Enable in Chrome:</strong>
                    <p>Chrome Settings → Accessibility → Enable "Simplified view for open pages"</p>
                </div>
            </div>
        `;
                } else if (isSafari) {
                    instructions = `
            <div class="tts-setup-steps">
                <h4>iOS Safari Setup:</h4>
                <div class="tts-step">
                    <strong>1. Enable Spoken Content:</strong>
                    <p>Settings → Accessibility → Spoken Content → Enable "Speak Selection"</p>
                </div>
                <div class="tts-step">
                    <strong>2. Download Voices:</strong>
                    <p>In Spoken Content → Voices → Download English, Thai, and Persian voices</p>
                </div>
                <div class="tts-step">
                    <strong>3. Test in Safari:</strong>
                    <p>Select any text on a webpage and tap "Speak" to test</p>
                </div>
            </div>
        `;
                } else if (isFirefox) {
                    instructions = `
            <div class="tts-setup-steps">
                <h4>Android Firefox Setup:</h4>
                <div class="tts-step">
                    <strong>1. Enable TTS in Firefox:</strong>
                    <p>Firefox may use the system TTS engine. Ensure your device has language packs installed.</p>
                </div>
                <div class="tts-step">
                    <strong>2. Install System Language Packs:</strong>
                    <p>Go to Android Settings → Accessibility → Text-to-speech output → Install voices for English, Thai, and Persian</p>
                </div>
                <div class="tts-step">
                    <strong>3. Set Default TTS Engine:</strong>
                    <p>In Text-to-speech output settings, set Google Text-to-speech as default and install required languages</p>
                </div>
            </div>
        `;
                }

                return instructions;
            },

            getDesktopSetupInstructions(isChrome, isSafari, isFirefox, isEdge) {
                let instructions = '';

                // Check browsers in order of specificity
                if (isFirefox) {
                    instructions = `
            <div class="tts-setup-steps">
                <h4>Firefox on Raspberry Pi Setup:</h4>
                <div class="tts-step">
                    <strong>1. Install System TTS Packages:</strong>
                    <p>Open terminal and run:<br>
                       <code>sudo apt update && sudo apt install espeak espeak-data</code></p>
                </div>
                <div class="tts-step">
                    <strong>2. Install Additional Language Support:</strong>
                    <p>For better language support, install:<br>
                       <code>sudo apt install festvox-rablpc16k libttspico-utils</code></p>
                </div>
                <div class="tts-step">
                    <strong>3. Check Audio Output:</strong>
                    <p>Ensure your Raspberry Pi audio is working:<br>
                       <code>speaker-test -t wav -c 2</code></p>
                </div>
                <div class="tts-step">
                    <strong>4. Firefox TTS Limitations:</strong>
                    <p>Firefox on Raspberry Pi uses eSpeak which has limited voice quality. 
                       For better TTS, consider using Chromium browser instead.</p>
                </div>
                <div class="tts-step">
                    <strong>5. Test TTS in Terminal:</strong>
                    <p>Test if system TTS works:<br>
                       <code>espeak "Hello this is a test"</code><br>
                       If this works, Firefox should be able to use TTS.</p>
                </div>
            </div>
        `;
                } else if (isChrome) {
                    instructions = `
            <div class="tts-setup-steps">
                <h4>Chrome/Chromium on Raspberry Pi Setup:</h4>
                <div class="tts-step">
                    <strong>1. Check System TTS:</strong>
                    <p>Ensure basic audio works:<br>
                       <code>sudo apt install alsa-utils</code><br>
                       <code>aplay /usr/share/sounds/alsa/Front_Left.wav</code></p>
                </div>
                <div class="tts-step">
                    <strong>2. Install Language Support:</strong>
                    <p>Chromium uses system TTS. Install voices:<br>
                       <code>sudo apt install speech-dispatcher festvox-*</code></p>
                </div>
                <div class="tts-step">
                    <strong>3. Browser Permissions:</strong>
                    <p>Ensure Chromium has permission to play audio and use TTS features</p>
                </div>
            </div>
        `;
                } else if (isSafari) {
                    instructions = `
            <div class="tts-setup-steps">
                <h4>Safari Setup:</h4>
                <div class="tts-step">
                    <strong>1. Enable Speech in macOS:</strong>
                    <p>System Preferences → Accessibility → Speech → Enable "Speak selected text"</p>
                </div>
                <div class="tts-step">
                    <strong>2. Download Voices:</strong>
                    <p>System Preferences → Accessibility → Speech → System Voice → Customize → Download English, Thai, and Persian</p>
                </div>
            </div>
        `;
                } else if (isEdge) {
                    instructions = `
            <div class="tts-setup-steps">
                <h4>Edge Browser Setup:</h4>
                <div class="tts-step">
                    <strong>1. System TTS Setup:</strong>
                    <p>Edge uses Windows TTS. Install voices via Settings → Time & Language → Language & Region</p>
                </div>
                <div class="tts-step">
                    <strong>2. Install Required Languages:</strong>
                    <p>Ensure your system has English, Thai, and Persian TTS voices installed</p>
                </div>
            </div>
        `;
                } else {
                    // Fallback for unknown browsers
                    instructions = `
            <div class="tts-setup-steps">
                <h4>General Raspberry Pi TTS Setup:</h4>
                <div class="tts-step">
                    <strong>1. Install Basic TTS:</strong>
                    <p><code>sudo apt update && sudo apt install espeak espeak-data</code></p>
                </div>
                <div class="tts-step">
                    <strong>2. Test Audio System:</strong>
                    <p><code>sudo apt install alsa-utils</code><br>
                       <code>speaker-test -t wav -c 2</code></p>
                </div>
                <div class="tts-step">
                    <strong>3. Test TTS in Terminal:</strong>
                    <p><code>espeak "Hello world"</code></p>
                </div>
                <div class="tts-step">
                    <strong>4. Browser Recommendations:</strong>
                    <p>For better TTS on Raspberry Pi, use Chromium browser instead of Firefox</p>
                </div>
            </div>
        `;
                }

                return instructions;
            },

            getMobileSetupInstructions(isChrome, isSafari) {
                let instructions = '';

                if (isChrome) {
                    instructions = `
            <div class="tts-setup-steps">
                <h4>Android Chrome Setup:</h4>
                <div class="tts-step">
                    <strong>1. Install Language Packs:</strong>
                    <p>Go to Settings → Accessibility → Text-to-speech output → Google Text-to-speech engine → Install voice data</p>
                </div>
                <div class="tts-step">
                    <strong>2. Download Languages:</strong>
                    <p>Install English, Thai, and Persian language packs for full functionality</p>
                </div>
                <div class="tts-step">
                    <strong>3. Enable in Chrome:</strong>
                    <p>Chrome Settings → Accessibility → Enable "Simplified view for open pages"</p>
                </div>
            </div>
        `;
                } else if (isSafari) {
                    instructions = `
            <div class="tts-setup-steps">
                <h4>iOS Safari Setup:</h4>
                <div class="tts-step">
                    <strong>1. Enable Spoken Content:</strong>
                    <p>Settings → Accessibility → Spoken Content → Enable "Speak Selection"</p>
                </div>
                <div class="tts-step">
                    <strong>2. Download Voices:</strong>
                    <p>In Spoken Content → Voices → Download English, Thai, and Persian voices</p>
                </div>
                <div class="tts-step">
                    <strong>3. Test in Safari:</strong>
                    <p>Select any text on a webpage and tap "Speak" to test</p>
                </div>
            </div>
        `;
                }

                return instructions;
            },

            getDesktopSetupInstructions(isChrome, isSafari) {
                let instructions = '';

                if (isChrome) {
                    instructions = `
            <div class="tts-setup-steps">
                <h4>Chrome Desktop Setup:</h4>
                <div class="tts-step">
                    <strong>1. Check System TTS:</strong>
                    <p>Windows: Settings → Ease of Access → Narrator<br>
                       Mac: System Preferences → Accessibility → Speech</p>
                </div>
                <div class="tts-step">
                    <strong>2. Install Languages:</strong>
                    <p>Download English, Thai, and Persian TTS voices through your operating system</p>
                </div>
                <div class="tts-step">
                    <strong>3. Chrome Permissions:</strong>
                    <p>Ensure Chrome has permission to use microphone/TTS features</p>
                </div>
            </div>
        `;
                } else if (isSafari) {
                    instructions = `
            <div class="tts-setup-steps">
                <h4>Safari Desktop Setup:</h4>
                <div class="tts-step">
                    <strong>1. Enable Speech in macOS:</strong>
                    <p>System Preferences → Accessibility → Speech → Enable "Speak selected text"</p>
                </div>
                <div class="tts-step">
                    <strong>2. Download Voices:</strong>
                    <p>System Preferences → Accessibility → Speech → System Voice → Customize → Download English, Thai, and Persian</p>
                </div>
                <div class="tts-step">
                    <strong>3. Safari Settings:</strong>
                    <p>Safari → Preferences → Advanced → Accessibility → Never use font sizes smaller than 10px</p>
                </div>
            </div>
        `;
                }

                return instructions;
            },

            // Add this method to detect Raspberry Pi
            detectRaspberryPi() {
                const userAgent = navigator.userAgent.toLowerCase();
                const isRaspberryPi = /raspberry|rpi|armv|aarch/.test(userAgent) ||
                    navigator.platform.toLowerCase().includes('arm') ||
                    navigator.hardwareConcurrency === 4; // Common RPi core count

                return isRaspberryPi;
            },


            getStatusMessage() {
                if (!this.isSupported()) {
                    const isFirefox = /Firefox/.test(navigator.userAgent);
                    let message = 'Your browser does not support the Web Speech API. ';

                    if (isFirefox) {
                        message += 'Firefox has limited TTS support and may require additional system configuration. ';
                    }

                    message += 'Please use Chrome, Safari, or Edge for the best experience.';

                    return {
                        type: 'error',
                        title: 'Text-to-Speech Not Supported',
                        message: message
                    };
                }

                const hasEnglish = this.hasLanguageSupport('en');
                const hasThai = this.hasLanguageSupport('th');
                const hasPersian = this.hasLanguageSupport('fa');

                if (!hasEnglish && !hasThai && !hasPersian) {
                    const isFirefox = /Firefox/.test(navigator.userAgent);
                    let message = 'No English, Thai, or Persian TTS voices found. You need to install language packs.';

                    if (isFirefox) {
                        message += ' Firefox relies on system TTS voices - please install voices through your operating system.';
                    }

                    return {
                        type: 'error',
                        title: 'No Language Voices Available',
                        message: message
                    };
                }

                const missingLanguages = [];
                if (!hasEnglish) missingLanguages.push('English');
                if (!hasThai) missingLanguages.push('Thai');
                if (!hasPersian) missingLanguages.push('Persian');

                if (missingLanguages.length > 0) {
                    const missingText = missingLanguages.join(', ');
                    const availableLanguages = [];
                    if (hasEnglish) availableLanguages.push('English');
                    if (hasThai) availableLanguages.push('Thai');
                    if (hasPersian) availableLanguages.push('Persian');
                    const availableText = availableLanguages.join(', ');

                    const isFirefox = /Firefox/.test(navigator.userAgent);
                    let message = `TTS works for ${availableText}, but ${missingText} voices are not available. Install missing language packs for complete functionality.`;

                    if (isFirefox) {
                        message += ' In Firefox, install missing voices through your operating system settings.';
                    }

                    return {
                        type: 'warning',
                        title: 'Some Languages Missing',
                        message: message
                    };
                }

                const isFirefox = /Firefox/.test(navigator.userAgent);
                let message = 'English, Thai, and Persian text-to-speech are all available and ready for your language practice!';

                if (isFirefox) {
                    message += ' (Firefox TTS is working correctly)';
                }

                return {
                    type: 'success',
                    title: 'TTS Ready for Language Learning',
                    message: message
                };
            },


            speak(text, lang, onEnd) {
                if (!text) return;
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;
                if (onEnd) utterance.onend = onEnd;
                speechSynthesis.speak(utterance);
            },

            cancel() {
                speechSynthesis.cancel();
            },

            pause() {
                speechSynthesis.pause();
            }
        };

        // Initialize TTS Manager when page loads
        TTSManager.initialize();

        // ========== APPLICATION STATE ==========
        const AppState = {
            books: [],
            currentBook: null,
            currentChapter: 0,
            currentParagraph: 0,
            isPlaying: false,
            currentWordIndex: 0,
            lastHighlightedIndex: null,

            initialize() {
                this.currentBook = Storage.load('currentBook', '');
                this.currentChapter = Storage.loadInt('currentChapter', 0);
                this.currentParagraph = Storage.loadInt('currentParagraph', 0);
            },

            saveNavigation() {
                Storage.save('currentChapter', this.currentChapter);
                Storage.save('currentParagraph', this.currentParagraph);
            },

            getCurrentParagraph() {
                return this.currentBook?.chapters?.[this.currentChapter]?.paragraphs?.[this.currentParagraph] || [];
            }
        };

        // ========== UI COMPONENTS ==========
        const ThemeManager = {
            init() {
                const themeToggle = document.getElementById('themeToggle');
                themeToggle.addEventListener('click', () => this.toggle());
                this.set(Storage.load('theme', 'light'));
            },

            set(theme) {
                document.body.dataset.theme = theme;
                document.getElementById('themeToggle').textContent = theme === 'light' ? '🌞' : '🌙';
                Storage.save('theme', theme);
            },

            toggle() {
                this.set(document.body.dataset.theme === 'light' ? 'dark' : 'light');
            }
        };

        const FontManager = {
            init() {
                const thaiFont = document.getElementById('thaiFont');
                thaiFont.value = Storage.load('thaiFont', '');
                thaiFont.addEventListener('change', (e) => {
                    Storage.save('thaiFont', e.target.value);
                    this.apply();
                });
                this.apply();
            },

            apply() {
                const font = Storage.load('thaiFont', '');
                document.querySelectorAll('[lang="th"], [lang="th-TH"], #appTitle').forEach(el => {
                    el.classList.add('thai-font');
                    el.classList.remove('tahoma', 'noto', 'chakra');
                    if (font === 'Tahoma') el.classList.add('tahoma');
                    if (font === 'Noto Sans Thai') el.classList.add('noto');
                    if (font === 'Chakra Petch') el.classList.add('chakra');
                });
            }
        };

        // ========== SETTINGS MANAGER ==========
        const SettingsManager = {
            show() {
                const contentArea = document.getElementById('contentArea');
                const controlsArea = document.getElementById('controlsArea');
                contentArea.innerHTML = this.getSettingsHTML();
                controlsArea.innerHTML = '';
                this.bindSettingsEvents();

                // Show initial TTS status
                this.showInitialTTSStatus();
            },

            getSettingsHTML() {
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center;
                                background: #00247D; color: white; padding: 0.5em 1em; border-radius: 8px;">
                        <h2 style="margin: 0;">Settings & Help</h2>
                        <button id="closeX" style="background: #666; color: white; border: none; padding: 0.5em; border-radius: 4px; cursor: pointer;">❌</button>
                    </div>
                    
                    <div class="settings-content" style="padding: 1em;">
                        <div class="settings-section">
                            <h3>Text-to-Speech Setup</h3>
                            <p>This app uses Text-to-Speech (TTS) to help you learn pronunciation in both Thai and English. 
                               Please test your setup and follow the instructions if needed.</p>
                            
                            <button id="checkTTS" class="settings-button" style="padding: 0.8em 1.5em; background: #00247D; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 1em 0;">
                                🔊 Test TTS Setup & Language Support
                            </button>
                            
                            <div id="ttsStatus"></div>
                            <div id="ttsSetupInstructions"></div>
                            <div id="languageTests"></div>
                        </div>
                        
                        <div style="margin-top: 2em; padding-top: 1em; border-top: 1px solid var(--border-light);">
                            <button id="closeBtn" style="padding: 0.6em 1.2em; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">Close Settings</button>
                        </div>
                    </div>`;
            },

            bindSettingsEvents() {
                document.getElementById('closeX').addEventListener('click', this.close);
                document.getElementById('closeBtn').addEventListener('click', this.close);
                document.getElementById('checkTTS').addEventListener('click', () => this.performTTSCheck());
            },

            close() {
                // Clear any errors and reload the main app view
                const contentArea = document.getElementById('contentArea');
                const controlsArea = document.getElementById('controlsArea');

                // Reset to main app view
                contentArea.innerHTML = AppController.getMainHTML();
                controlsArea.innerHTML = AppController.getControlsHTML();

                // Re-initialize the app components
                AppController.bindUIElements();
                AppController.restoreSettings();

                // Re-populate the book list and restore current selection
                AppController.reloadBookList();
            },

            showInitialTTSStatus() {
                const status = TTSManager.getStatusMessage();
                this.showTTSStatus(status);

                // Show setup instructions for common issues
                if (status.type !== 'success') {
                    const instructions = TTSManager.getSetupInstructions();
                    document.getElementById('ttsSetupInstructions').innerHTML = instructions;
                }
            },

            async performTTSCheck() {
                const ttsStatus = document.getElementById('ttsStatus');
                const checkBtn = document.getElementById('checkTTS');
                const languageTests = document.getElementById('languageTests');

                checkBtn.innerHTML = '🔄 Testing TTS...';
                checkBtn.disabled = true;
                ttsStatus.innerHTML = '';
                languageTests.innerHTML = '';

                // Show initial system status
                const status = TTSManager.getStatusMessage();
                this.showTTSStatus(status);

                // Perform comprehensive test
                const testPassed = await TTSManager.comprehensiveTest();

                // Show detailed test results
                this.showLanguageTestResults();

                // Show setup instructions if needed
                if (!testPassed) {
                    const instructions = TTSManager.getSetupInstructions();
                    document.getElementById('ttsSetupInstructions').innerHTML = instructions;
                }

                checkBtn.innerHTML = '✅ TTS Test Complete';
                checkBtn.disabled = false;

                // Update status based on test results
                const finalStatus = TTSManager.getStatusMessage();
                this.showTTSStatus(finalStatus);
            },

            showTTSStatus(status) {
                const ttsStatus = document.getElementById('ttsStatus');
                const statusClass = `tts-status-${status.type === 'warning' ? 'info' : status.type}`;

                ttsStatus.innerHTML = `
                    <div class="tts-status-container ${statusClass}">
                        <h4 style="margin: 0 0 0.5em 0;">${status.title}</h4>
                        <p style="margin: 0;">${status.message}</p>
                    </div>
                `;
            },

            showLanguageTestResults() {
                const languageTests = document.getElementById('languageTests');
                const results = TTSManager.testResults;

                if (Object.keys(results).length === 0) return;

                let html = `<h4>Language Test Results:</h4><div class="tts-language-check">`;

                for (const [lang, result] of Object.entries(results)) {
                    const icon = result.success ? '✅' : '❌';
                    const resultClass = result.success ? 'success-check' : 'error-cross';
                    const voices = result.voices ? result.voices.map(v => v.name).join(', ') : 'No voices';

                    html += `
                        <div style="flex: 1; min-width: 200px; padding: 1em; background: rgba(0,0,0,0.05); border-radius: 8px;">
                            <div style="font-weight: bold;">${icon} ${result.name}</div>
                            <div class="test-result ${resultClass}">
                                ${result.success ?
                            `Working - ${voices}` :
                            `Failed: ${result.error}`
                        }
                            </div>
                            <button onclick="testSingleLanguage('${lang}', '${result.text}')" 
                                    class="language-test" 
                                    style="margin-top: 0.5em;">
                                Test ${result.name} Again
                            </button>
                        </div>
                    `;
                }

                html += `</div>`;
                languageTests.innerHTML = html;
            }
        };

        // Global function for testing individual languages
        window.testSingleLanguage = async function (lang, text) {
            let languageName = '';
            switch (lang) {
                case 'en-US': languageName = 'English'; break;
                case 'th-TH': languageName = 'Thai'; break;
                case 'fa-IR': languageName = 'Persian'; break;
                default: languageName = lang;
            }

            const result = await TTSManager.testLanguage(lang, text);
            alert(`${languageName} TTS Test: ${result.success ? 'SUCCESS' : 'FAILED'}\n${result.success ? 'Voice is working properly' : 'Error: ' + result.error}`);
        };
        // ========== BOOK MANAGEMENT ==========
        const BookManager = {
            async loadBookList() {
                try {
                    const res = await fetch('/assets/books/bookList.json');
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    return await res.json();
                } catch (error) {
                    console.error('Error loading book list:', error);
                    return [];
                }
            },

            async loadBook(filename) {
                try {
                    const res = await fetch(`/assets/books/${filename}`);
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    return await res.json();
                } catch (error) {
                    console.error('Error loading book:', error);
                    throw error;
                }
            }
        };

        // ========== PARAGRAPH RENDERING ==========
        const ParagraphRenderer = {
            display: null,

            init(displayElement) {
                this.display = displayElement;
            },

            render(paragraph) {
                if (!this.display) return;
                this.display.innerHTML = '';

                if (!paragraph || paragraph.length === 0) {
                    this.display.textContent = 'No paragraph content available.';
                    return;
                }

                paragraph.forEach((word, index) => {
                    this.renderWord(word, index);
                });

                FontManager.apply();
            },

            renderWord(word, index) {
                // Handle newlines
                if (this.isNewline(word)) {
                    this.display.appendChild(document.createElement('br'));
                    return;
                }

                const renderer = this;

                function buildLanguages(thText, enText, faText, wordIndex) {
                    const pairDiv = document.createElement('div');
                    pairDiv.className = 'word-pair';
                    pairDiv.dataset.index = wordIndex;

                    // Use display settings for showing text
                    if (document.getElementById('displayThai')?.checked && thText) {
                        const thSpan = document.createElement('span');
                        thSpan.textContent = thText;
                        thSpan.lang = 'th-TH';
                        thSpan.dataset.index = wordIndex;
                        thSpan.onclick = () => {
                            // Use speak settings for audio
                            if (document.getElementById('speakThai')?.checked) {
                                PlaybackController.playWord(thText, 'th-TH', thSpan, wordIndex);
                            }
                        };
                        pairDiv.appendChild(thSpan);
                    }

                    if (document.getElementById('displayEnglish')?.checked && enText) {
                        const enSpan = document.createElement('span');
                        enSpan.textContent = enText;
                        enSpan.lang = 'en-US';
                        enSpan.dataset.index = wordIndex;
                        enSpan.onclick = () => {
                            if (document.getElementById('speakEnglish')?.checked) {
                                PlaybackController.playWord(enText, 'en-US', enSpan, wordIndex);
                            }
                        };
                        pairDiv.appendChild(enSpan);
                    }

                    if (document.getElementById('displayPersian')?.checked && faText) {
                        const faSpan = document.createElement('span');
                        faSpan.textContent = faText;
                        faSpan.lang = 'fa-IR';
                        faSpan.dataset.index = wordIndex;
                        faSpan.onclick = () => {
                            if (document.getElementById('speakPersian')?.checked) {
                                PlaybackController.playWord(faText, 'fa-IR', faSpan, wordIndex);
                            }
                        };
                        pairDiv.appendChild(faSpan);
                    }

                    renderer.display.appendChild(pairDiv);
                }

                const thParts = (word.th || '').split('\n');
                const enParts = (word.en || '').split('\n');
                const faParts = (word.fa || '').split('\n');
                const maxParts = Math.max(thParts.length, enParts.length, faParts.length);

                for (let p = 0; p < maxParts; p++) {
                    const thPart = thParts[p] || '';
                    const enPart = enParts[p] || '';
                    const faPart = faParts[p] || '';

                    if (!thPart && !enPart && !faPart) continue;

                    buildLanguages.call(this, thPart, enPart, faPart, index);

                    if (p < maxParts - 1) {
                        this.display.appendChild(document.createElement('br'));
                    }
                }
            },

            isNewline(word) {
                return word.th === "\n" && word.en === "\n" && word.fa === "\n";
            },

            clearHighlights() {
                if (!this.display) return;
                this.display.querySelectorAll('span').forEach(span => {
                    span.classList.remove('highlight-light', 'highlight-dark');
                });
            },

            highlightElement(element, index) {
                this.clearHighlights();
                if (element) {
                    const themeClass = document.body.dataset.theme === 'dark' ? 'highlight-dark' : 'highlight-light';
                    element.classList.add(themeClass);
                    AppState.lastHighlightedIndex = index;

                    // Scroll to highlighted element
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        };

        // ========== PLAYBACK CONTROLLER ==========
        const PlaybackController = {
            async playParagraph() {
                if (AppState.isPlaying) return;

                const paragraph = AppState.getCurrentParagraph();
                if (!paragraph || paragraph.length === 0) return;

                AppState.isPlaying = true;

                // Don't reset currentWordIndex if we're resuming from pause
                // Only reset if we're at the end or haven't started
                if (AppState.currentWordIndex >= paragraph.length) {
                    AppState.currentWordIndex = 0;
                }

                await this.speakNextWord();
            },

            pauseParagraph() {
                AppState.isPlaying = false;
                TTSManager.cancel();
                // DON'T clear highlights when pausing - keep the current word highlighted
            },

            restartParagraph() {
                this.pauseParagraph();
                ParagraphRenderer.clearHighlights();
                AppState.currentWordIndex = 0;
                this.playParagraph();
            },

            async speakNextWord() {
                const paragraph = AppState.getCurrentParagraph();
                if (!AppState.isPlaying || !paragraph || AppState.currentWordIndex >= paragraph.length) {
                    AppState.isPlaying = false;
                    ParagraphRenderer.clearHighlights();
                    return;
                }

                const word = paragraph[AppState.currentWordIndex];
                if (!word || this.isNewline(word)) {
                    AppState.currentWordIndex++;
                    await this.speakNextWord();
                    return;
                }

                // Highlight the current word immediately when starting to speak it
                this.highlightCurrentWord(AppState.currentWordIndex);

                const delay = this.getPlaybackDelay();

                // Use speak settings for audio playback
                const speakThai = document.getElementById('speakThai')?.checked;
                const speakEnglish = document.getElementById('speakEnglish')?.checked;
                const speakPersian = document.getElementById('speakPersian')?.checked;

                let anyWordSpoken = false;

                if (speakThai && word.th && word.th !== "\n") {
                    await this.speakWord(word.th, 'th-TH', AppState.currentWordIndex, true);
                    anyWordSpoken = true;
                }

                if (speakEnglish && word.en && word.en !== "\n") {
                    await this.speakWord(word.en, 'en-US', AppState.currentWordIndex, true);
                    anyWordSpoken = true;
                }

                if (speakPersian && word.fa && word.fa !== "\n") {
                    await this.speakWord(word.fa, 'fa-IR', AppState.currentWordIndex, true);
                    anyWordSpoken = true;
                }

                // Only advance to next word if we're still playing and actually spoke something
                if (AppState.isPlaying && anyWordSpoken) {
                    AppState.currentWordIndex++;
                    setTimeout(() => {
                        if (AppState.isPlaying) this.speakNextWord();
                    }, delay);
                } else if (!anyWordSpoken) {
                    // If no words were spoken (all speak options disabled), move to next word
                    AppState.currentWordIndex++;
                    if (AppState.isPlaying) {
                        setTimeout(() => {
                            if (AppState.isPlaying) this.speakNextWord();
                        }, delay);
                    }
                }
            },

            // New method to highlight the current word
            highlightCurrentWord(index) {
                const paragraph = AppState.getCurrentParagraph();
                if (!paragraph || index >= paragraph.length) return;

                const word = paragraph[index];
                if (!word) return;

                // Find the word-pair element for this index
                const pairDiv = ParagraphRenderer.display?.querySelector(`.word-pair[data-index="${index}"]`);
                if (!pairDiv) return;

                // Clear all highlights first
                ParagraphRenderer.clearHighlights();

                // Use display settings to determine which span to highlight
                const displayThai = document.getElementById('displayThai')?.checked;
                const displayEnglish = document.getElementById('displayEnglish')?.checked;
                const displayPersian = document.getElementById('displayPersian')?.checked;

                if (displayThai && word.th && word.th !== "\n") {
                    const thSpan = pairDiv.querySelector('span[lang="th-TH"]');
                    if (thSpan) ParagraphRenderer.highlightElement(thSpan, index);
                } else if (displayEnglish && word.en && word.en !== "\n") {
                    const enSpan = pairDiv.querySelector('span[lang="en-US"]');
                    if (enSpan) ParagraphRenderer.highlightElement(enSpan, index);
                } else if (displayPersian && word.fa && word.fa !== "\n") {
                    const faSpan = pairDiv.querySelector('span[lang="fa-IR"]');
                    if (faSpan) ParagraphRenderer.highlightElement(faSpan, index);
                }
            },

            async speakWord(text, lang, index, autoAdvance = false) {
                return new Promise(resolve => {
                    if (!text || text === "\n") {
                        resolve();
                        return;
                    }

                    // The highlighting is now handled by highlightCurrentWord
                    // so we don't need to highlight again here for auto-advance

                    TTSManager.speak(text, lang, () => {
                        if (autoAdvance && AppState.isPlaying) {
                            // Don't clear the highlight here - let the next word handle it
                            // or keep it highlighted if paused
                        }
                        resolve();
                    });
                });
            },

            playWord(text, lang, span, index) {
                if (!text || text === "\n") return;

                // When clicking a word, just play that word and set the position
                // but don't start auto-advancing
                AppState.currentWordIndex = index;

                // Highlight immediately when clicking
                ParagraphRenderer.highlightElement(span, index);
                TTSManager.cancel();
                this.speakWord(text, lang, index, false);
            },

            // Add method to continue playback from current position
            continueFromCurrent() {
                if (!AppState.isPlaying) {
                    this.playParagraph();
                }
            },

            isNewline(word) {
                return word.th === "\n" && word.en === "\n" && word.fa === "\n";
            },

            getPlaybackDelay() {
                const delaySec = parseFloat(document.getElementById('playbackDelay')?.value || Storage.load('playbackDelay', '1'));
                const delayMs = Math.min(Math.max(isNaN(delaySec) ? 1500 : delaySec * 1000, 500), 5000);
                return delayMs;
            },

        };

        // ========== QUIZ SYSTEM ==========
        const QuizSystem = {
            data: [],
            currentQuestion: 0,
            score: 0,
            attempts: 0,
            incorrectOnly: false,

            buildFromParagraph(paragraph) {
                this.data = paragraph.map(word => ({
                    ...word,
                    attempted: false,
                    correct: false
                }));
                this.currentQuestion = 0;
                this.score = 0;
                this.attempts = 0;
                this.incorrectOnly = false;
                this.render();
            },

            render() {
                const quizContainer = document.getElementById("quiz");
                if (!quizContainer) return;

                quizContainer.innerHTML = "";

                if (!this.data.length) {
                    quizContainer.textContent = "No quiz available for this paragraph.";
                    return;
                }

                // Get filtered questions based on incorrectOnly setting
                const filteredQuestions = this.getFilteredQuestions();

                if (filteredQuestions.length === 0) {
                    if (this.incorrectOnly) {
                        this.showNoIncorrectMessage(quizContainer);
                    } else {
                        this.showCompletionMessage(quizContainer);
                    }
                    return;
                }

                // Check if we've reached the end of filtered questions
                if (this.currentQuestion >= filteredQuestions.length) {
                    this.showCompletionMessage(quizContainer);
                    return;
                }

                const question = filteredQuestions[this.currentQuestion];
                const questionLang = document.querySelector('input[name="questionLang"]:checked')?.value;
                const answerLang = document.querySelector('input[name="answerLang"]:checked')?.value;

                if (!this.validateLanguages(questionLang, answerLang, quizContainer)) return;

                this.renderQuestion(question, questionLang, quizContainer);
                this.renderOptions(question, answerLang, quizContainer);
                FontManager.apply();
            },

            getFilteredQuestions() {
                if (!this.incorrectOnly) {
                    return this.data;
                }
                // Return only questions that have been attempted and are incorrect
                return this.data.filter(q => q.attempted && !q.correct);
            },

            showNoIncorrectMessage(container) {
                const messageDiv = document.createElement("div");
                messageDiv.className = "quiz-completion";
                messageDiv.innerHTML = `
            <h4>No Incorrect Answers! 🎉</h4>
            <p>You have answered all questions correctly.</p>
            <p>Final Score: ${this.score} out of ${this.attempts}</p>
            <p>Success Rate: ${this.attempts > 0 ? Math.round((this.score / this.attempts) * 100) : 0}%</p>
            <button id="showAllQuestions" style="margin-top: 1em; padding: 0.5em 1em;">Show All Questions</button>
        `;
                container.appendChild(messageDiv);

                // Add event listener for show all button
                document.getElementById('showAllQuestions')?.addEventListener('click', () => {
                    this.incorrectOnly = false;
                    this.currentQuestion = 0;
                    this.render();
                });
            },

            showCompletionMessage(container) {
                const completionDiv = document.createElement("div");
                completionDiv.className = "quiz-completion";
                completionDiv.innerHTML = `
            <h4>Quiz Complete! 🎉</h4>
            <p>Final Score: ${this.score} out of ${this.attempts}</p>
            <p>Success Rate: ${this.attempts > 0 ? Math.round((this.score / this.attempts) * 100) : 0}%</p>
            <button id="restartQuiz" style="margin-top: 1em; padding: 0.5em 1em;">Restart Quiz</button>
            ${this.incorrectOnly ? '<button id="showAllQuestions" style="margin-top: 0.5em; padding: 0.5em 1em; background: #666;">Show All Questions</button>' : ''}
        `;
                container.appendChild(completionDiv);

                // Add event listener for restart button
                document.getElementById('restartQuiz')?.addEventListener('click', () => {
                    this.currentQuestion = 0;
                    this.score = 0;
                    this.attempts = 0;
                    this.resetQuestionStates();
                    this.render();
                });

                // Add event listener for show all button if it exists
                const showAllBtn = document.getElementById('showAllQuestions');
                if (showAllBtn) {
                    showAllBtn.addEventListener('click', () => {
                        this.incorrectOnly = false;
                        this.currentQuestion = 0;
                        this.render();
                    });
                }
            },

            validateLanguages(questionLang, answerLang, container) {
                if (!questionLang || !answerLang) {
                    container.textContent = "Select both Question and Answer languages.";
                    return false;
                }
                if (questionLang === answerLang) {
                    container.textContent = "Answer language must be different from Question.";
                    return false;
                }
                return true;
            },

            renderQuestion(question, questionLang, container) {
                // Add safety check for undefined question
                if (!question || !question[questionLang]) {
                    console.error('Invalid question data:', question);
                    return;
                }

                const questionEl = document.createElement("div");
                questionEl.className = "quiz-question";
                questionEl.textContent = question[questionLang] || "";
                questionEl.lang = this.getLangCode(questionLang);
                questionEl.style.cursor = "pointer";
                questionEl.addEventListener("click", () => {
                    TTSManager.speak(question[questionLang], this.getLangCode(questionLang));
                });
                container.appendChild(questionEl);
            },

            renderOptions(question, answerLang, container) {
                const options = this.generateOptions(question, answerLang);
                const optionsContainer = document.createElement("div");
                optionsContainer.className = "quiz-options";

                options.forEach(option => {
                    const optionEl = this.createOptionElement(option, answerLang, question);
                    optionsContainer.appendChild(optionEl);
                });

                container.appendChild(optionsContainer);
            },

            generateOptions(question, answerLang) {
                const correctAnswer = question[answerLang];
                let options = this.data
                    .map(q => q[answerLang])
                    .filter((val, idx, arr) => arr.indexOf(val) === idx && val)
                    .filter(opt => opt !== correctAnswer)
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 3);

                options = [correctAnswer, ...options].sort(() => Math.random() - 0.5);
                return options;
            },

            createOptionElement(option, answerLang, question) {
                const optionEl = document.createElement("div");
                optionEl.lang = this.getLangCode(answerLang);
                optionEl.className = "quiz-option";
                optionEl.textContent = option;

                optionEl.addEventListener("click", () => {
                    TTSManager.speak(option, this.getLangCode(answerLang));
                    this.handleAnswer(optionEl, option, question[answerLang], question);
                });

                return optionEl;
            },

            handleAnswer(optionEl, selectedAnswer, correctAnswer, question) {
                if (selectedAnswer === correctAnswer) {
                    if (!question.correct) {
                        optionEl.classList.add("correct");
                        this.score++;
                        question.correct = true;
                        question.attempted = true;
                        this.attempts++;
                    }
                } else {
                    optionEl.classList.add("incorrect");
                    question.correct = false;
                    question.attempted = true;
                    this.attempts++;
                }

                document.getElementById("score").textContent = `Score: ${this.score}/${this.attempts}`;
            },

            getLangCode(lang) {
                const codes = { th: 'th-TH', en: 'en-US', fa: 'fa-IR' };
                return codes[lang] || 'th-TH';
            },

            nextQuestion() {
                const filteredQuestions = this.getFilteredQuestions();
                if (this.currentQuestion < filteredQuestions.length - 1) {
                    this.currentQuestion++;
                    this.render();
                } else if (this.currentQuestion === filteredQuestions.length - 1) {
                    // Move to the end to show completion message
                    this.currentQuestion = filteredQuestions.length;
                    this.render();
                }
                // If already at completion state, do nothing
            },

            previousQuestion() {
                if (this.currentQuestion > 0) {
                    this.currentQuestion--;
                    this.render();
                }
            },

            retry() {
                this.currentQuestion = 0;
                // Only reset question states if we're not in incorrectOnly mode
                if (!this.incorrectOnly) {
                    this.resetQuestionStates();
                    this.score = 0;
                    this.attempts = 0;
                }
                this.render();
            },

            resetQuestionStates() {
                this.data.forEach(question => {
                    question.attempted = false;
                    question.correct = false;
                });
            }
        };
        // ========== NAVIGATION CONTROLLER ==========
        const NavigationController = {
            bookSelect: null,
            chapterSelect: null,
            paragraphSelect: null,

            init(bookSelect, chapterSelect, paragraphSelect) {
                this.bookSelect = bookSelect;
                this.chapterSelect = chapterSelect;
                this.paragraphSelect = paragraphSelect;

                // Add event listeners
                if (bookSelect) {
                    bookSelect.addEventListener('change', (e) => this.handleBookChange(e.target.value));
                }
                if (chapterSelect) {
                    chapterSelect.addEventListener('change', (e) => this.handleChapterChange(+e.target.value));
                }
                if (paragraphSelect) {
                    paragraphSelect.addEventListener('change', (e) => this.handleParagraphChange(+e.target.value));
                }
            },

            async handleBookChange(bookFilename) {
                Storage.save('currentBook', bookFilename);
                await AppController.loadBook(bookFilename);
            },

            handleChapterChange(chapterIndex) {
                AppState.currentChapter = chapterIndex;
                AppController.populateParagraphs();
            },

            handleParagraphChange(paragraphIndex) {
                AppState.currentParagraph = paragraphIndex;
                AppController.loadParagraph();
            },

            nextParagraph() {
                const max = AppState.currentBook?.chapters?.[AppState.currentChapter]?.paragraphs?.length || 0;
                if (AppState.currentParagraph < max - 1) {
                    AppState.currentParagraph++;
                    if (this.paragraphSelect) {
                        this.paragraphSelect.value = AppState.currentParagraph;
                    }
                    AppController.loadParagraph();
                }
            },

            previousParagraph() {
                if (AppState.currentParagraph > 0) {
                    AppState.currentParagraph--;
                    if (this.paragraphSelect) {
                        this.paragraphSelect.value = AppState.currentParagraph;
                    }
                    AppController.loadParagraph();
                }
            }
        };

        // ========== MAIN APPLICATION CONTROLLER ==========
        const AppController = {

            async init() {
                AppState.initialize();
                ThemeManager.init();
                FontManager.init();
                this.setupEventListeners();
                await this.loadBooks();
                this.setupPlaybackScrollHandling();
            },

            setupEventListeners() {
                document.getElementById('settingsBtn').addEventListener('click', () => SettingsManager.show());
            },

            async loadBooks() {
                const bookList = await BookManager.loadBookList();
                this.populateBookSelect(bookList);

                if (bookList.length > 0) {
                    // Use the filename, not the book object
                    const currentBookFilename = Storage.load('currentBook', bookList[0].bookFilename);
                    await this.loadBook(currentBookFilename);
                }
            },

            async reloadBookList() {
                const bookList = await BookManager.loadBookList();
                this.populateBookSelect(bookList);

                // Restore the current book selection
                const currentBookFilename = Storage.load('currentBook');
                if (currentBookFilename && AppState.currentBook) {
                    // If we already have book data, just update the select and repopulate chapters/paragraphs
                    const bookSelect = document.getElementById('bookSelect');
                    if (bookSelect) {
                        bookSelect.value = currentBookFilename;
                    }
                    this.populateChapters();
                } else if (bookList.length > 0) {
                    // Otherwise load the first book or saved book
                    const bookToLoad = currentBookFilename || bookList[0].bookFilename;
                    await this.loadBook(bookToLoad);
                }
            },

            populateBookSelect(bookList) {
                const bookSelect = document.getElementById('bookSelect');
                if (!bookSelect) return;

                bookSelect.innerHTML = '';

                if (bookList.length === 0) {
                    bookSelect.innerHTML = '<option>No books available</option>';
                    bookSelect.disabled = true;
                    return;
                }

                bookList.forEach(book => {
                    const option = document.createElement('option');
                    option.value = book.bookFilename;
                    option.textContent = book.bookTitle;
                    bookSelect.appendChild(option);
                });

                const savedBook = Storage.load('currentBook', bookList[0].bookFilename);
                bookSelect.value = savedBook;
                bookSelect.disabled = false;
            },

            async loadBook(filename) {
                try {
                    const bookData = await BookManager.loadBook(filename);
                    AppState.currentBook = bookData; // Store the book data object
                    Storage.save('currentBook', filename); // Store the filename
                    this.populateChapters();
                } catch (error) {
                    console.error('Error loading book:', error);
                    const contentArea = document.getElementById('contentArea');
                    if (contentArea) {
                        contentArea.innerHTML =
                            `<div class="error-message">Error loading book: ${error.message}. Please check that the book file exists at /assets/books/${filename}</div>`;
                    }
                }
            },

            populateChapters() {
                const chapterSelect = document.getElementById('chapterSelect');
                if (!chapterSelect) return;

                chapterSelect.innerHTML = '';

                if (!AppState.currentBook?.chapters?.length) {
                    chapterSelect.innerHTML = '<option>No chapters available</option>';
                    chapterSelect.disabled = true;
                    return;
                }

                AppState.currentBook.chapters.forEach((chapter, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = chapter.chapterTitle || `Chapter ${index + 1}`;
                    chapterSelect.appendChild(option);
                });

                AppState.currentChapter = Math.min(AppState.currentChapter, AppState.currentBook.chapters.length - 1);
                chapterSelect.value = AppState.currentChapter;
                chapterSelect.disabled = false;
                this.populateParagraphs();
            },

            populateParagraphs() {
                const paragraphSelect = document.getElementById('paragraphSelect');
                if (!paragraphSelect) return;

                paragraphSelect.innerHTML = '';

                const currentChapter = AppState.currentBook?.chapters?.[AppState.currentChapter];
                if (!currentChapter?.paragraphs?.length) {
                    paragraphSelect.innerHTML = '<option>No paragraphs available</option>';
                    paragraphSelect.disabled = true;
                    return;
                }

                currentChapter.paragraphs.forEach((paragraph, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `Paragraph ${index + 1}`;
                    paragraphSelect.appendChild(option);
                });

                AppState.currentParagraph = Math.min(AppState.currentParagraph, currentChapter.paragraphs.length - 1);
                paragraphSelect.value = AppState.currentParagraph;
                paragraphSelect.disabled = false;
                this.loadParagraph();
            },

            loadParagraph() {
                AppState.saveNavigation();
                this.renderParagraph();

                // Reset playback position when loading a new paragraph
                AppState.currentWordIndex = 0;
                AppState.isPlaying = false;
                TTSManager.cancel();

                // Ensure book selection is visible after loading new content
                setTimeout(() => this.ensureBookSelectionVisible(), 200);
            },

            renderParagraph() {
                const paragraph = AppState.getCurrentParagraph();
                ParagraphRenderer.render(paragraph);
                QuizSystem.buildFromParagraph(paragraph);
            },

            ensureBookSelectionVisible() {
                const bookSelection = document.getElementById('bookSelectionControls');
                const contentArea = document.getElementById('contentArea');

                if (bookSelection && contentArea) {
                    // Use a small timeout to ensure DOM is updated
                    setTimeout(() => {
                        const bookSelectionRect = bookSelection.getBoundingClientRect();
                        const headerRect = document.querySelector('header').getBoundingClientRect();

                        // If book selection is behind the header, scroll it into view
                        if (bookSelectionRect.top < headerRect.bottom + 10) {
                            const scrollTop = contentArea.scrollTop;
                            const targetScroll = scrollTop - (headerRect.bottom - bookSelectionRect.top) - 20;
                            contentArea.scrollTo({
                                top: targetScroll,
                                behavior: 'smooth'
                            });
                        }
                    }, 100);
                }
            },

            setupPlaybackScrollHandling() {
                // Observe when words are highlighted during playback
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' &&
                            (mutation.target.classList.contains('highlight-light') ||
                                mutation.target.classList.contains('highlight-dark'))) {
                            this.ensureBookSelectionVisible();
                        }
                    });
                });

                const paragraphDisplay = document.getElementById('paragraphDisplay');
                if (paragraphDisplay) {
                    observer.observe(paragraphDisplay, {
                        attributes: true,
                        attributeFilter: ['class'],
                        subtree: true
                    });
                }
            },

            initSPA() {
                const contentArea = document.getElementById('contentArea');
                const controlsArea = document.getElementById('controlsArea');

                if (!contentArea || !controlsArea) return;

                contentArea.innerHTML = this.getMainHTML();
                controlsArea.innerHTML = this.getControlsHTML();

                this.bindUIElements();
                this.restoreSettings();

                // Ensure the content area is scrolled to top when initializing
                contentArea.scrollTop = 0;
            },

            getMainHTML() {
                return `
        <div class="selection-header">Select Languages and Books to Speak Out</div>
        
        <details class="book-options-details">
            <summary>Book & Language Options</summary>
            <div class="book-options-content">
                <div id="bookSelectionControls" class="book-selection-controls">
                    <label>Book: <select id="bookSelect"></select></label>
                    <label>Chapter: <select id="chapterSelect"></select></label>
                    <label>Paragraph: <select id="paragraphSelect"></select></label>
                </div>
                
                <div class="language-controls">
                    <details>
                        <summary>Language Options</summary>
                        <div class="language-controls-content">
                            <!-- Row 1: Language Titles -->
                            <div class="language-header-row">
                                <div class="control-type"></div>
                                <div class="language-checkboxes">
                                    <div class="language-checkbox-group">
                                        <div class="language-title">Thai</div>
                                    </div>
                                    <div class="language-checkbox-group">
                                        <div class="language-title">Persian</div>
                                    </div>
                                    <div class="language-checkbox-group">
                                        <div class="language-title">English</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Row 2: Display Checkboxes -->
                            <div class="language-controls-row">
                                <div class="control-type">Display</div>
                                <div class="language-checkboxes">
                                    <div class="language-checkbox-group">
                                        <label><input type="checkbox" id="displayThai" checked></label>
                                    </div>
                                    <div class="language-checkbox-group">
                                        <label><input type="checkbox" id="displayPersian"></label>
                                    </div>
                                    <div class="language-checkbox-group">
                                        <label><input type="checkbox" id="displayEnglish"></label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Row 3: Speak Checkboxes -->
                            <div class="language-controls-row">
                                <div class="control-type">Speak</div>
                                <div class="language-checkboxes">
                                    <div class="language-checkbox-group">
                                        <label><input type="checkbox" id="speakThai" checked></label>
                                    </div>
                                    <div class="language-checkbox-group">
                                        <label><input type="checkbox" id="speakPersian"></label>
                                    </div>
                                    <div class="language-checkbox-group">
                                        <label><input type="checkbox" id="speakEnglish"></label>
                                    </div>
                                </div>
                            </div>
                            <!-- Row 4: Reading Delay -->
                            <div class="language-controls-row">
                                <div class="control-type">Reading delay (secs)</div>
                                <div class="language-checkboxes">
                                    <div class="language-checkbox-group" style="flex: 1;">
                                        <input type="number" id="playbackDelay" value="0.5" min="0.5" max="5.0" step="1.0">
                                    </div>
                                    <div class="language-checkbox-group" style="flex: 0;"></div>
                                    <div class="language-checkbox-group" style="flex: 0;"></div>
                                </div>
                            </div>
                        </div>
                    </details>
                </div>
            </div>
        </details>
        
        <section id="paragraphSec">
            <div id="paragraphDisplay"></div>
            <div id="paragraphControls" class="controls">
                <div class="paragraph-controls-row">
                    <button id="playBtn">▶️</button>
                    <button id="pauseBtn">⏸️</button>
                    <button id="restartBtn">⏮️</button>
                    <span class="paragraph-label">Paragraph</span>
                    <button id="prevParagraph">⬅️</button>
                    <button id="nextParagraph">➡️</button>
                </div>
            </div>
        </section>
        
        <section id="quizSec">
            <h3>Practice Quiz</h3>
            <div id="quiz"></div>
            <div id="quizControls">
                <div class="quiz-row quiz-row-top">
                    <button id="prevQ">⬅️</button>
                    <button id="nextQ">➡️</button>
                    <button id="retryQuiz">🔄</button>
                    <label><input type="checkbox" id="incorrectOnly"> Incorrect Only</label>
                    <div id="score">Score: 0/0</div>
                </div>
                <div class="quiz-row quiz-row-bottom">
                    <div class="lang-select">
                        <span>Question: </span>
                        <label><input type="radio" name="questionLang" id="questionThai" value="th" checked> Thai</label>
                        <label><input type="radio" name="questionLang" id="questionEnglish" value="en"> English</label>
                        <label><input type="radio" name="questionLang" id="questionPersian" value="fa"> Persian</label>
                    </div>
                    <div class="lang-select">
                        <span>Answer: </span>
                        <label><input type="radio" name="answerLang" id="answerThai" value="th"> Thai</label>
                        <label><input type="radio" name="answerLang" id="answerEnglish" value="en" checked> English</label>
                        <label><input type="radio" name="answerLang" id="answerPersian" value="fa"> Persian</label>
                    </div>
                </div>
            </div>
        </section>`;
            },

            getControlsHTML() {
                return ``; // Empty controls area - all controls are in main content
            },

            bindUIElements() {
                // Initialize component references
                ParagraphRenderer.init(document.getElementById('paragraphDisplay'));
                NavigationController.init(
                    document.getElementById('bookSelect'),
                    document.getElementById('chapterSelect'),
                    document.getElementById('paragraphSelect')
                );

                // Event delegation for dynamic elements
                document.addEventListener('change', (e) => {
                    this.handleSettingChange(e);
                });

                // Playback controls
                document.getElementById('playBtn')?.addEventListener('click', () => {
                    PlaybackController.playParagraph();
                    // Ensure book selection stays visible when playback starts
                    setTimeout(() => this.ensureBookSelectionVisible(), 300);
                });
                document.getElementById('pauseBtn')?.addEventListener('click', () => PlaybackController.pauseParagraph());
                document.getElementById('restartBtn')?.addEventListener('click', () => PlaybackController.restartParagraph());
                document.getElementById('nextParagraph')?.addEventListener('click', () => NavigationController.nextParagraph());
                document.getElementById('prevParagraph')?.addEventListener('click', () => NavigationController.previousParagraph());

                // Quiz controls
                document.getElementById('prevQ')?.addEventListener('click', () => QuizSystem.previousQuestion());
                document.getElementById('nextQ')?.addEventListener('click', () => QuizSystem.nextQuestion());
                document.getElementById('retryQuiz')?.addEventListener('click', () => QuizSystem.retry());

                // Language settings
                this.bindLanguageSettings();
            },

            handleSettingChange(event) {
                const handlers = {
                    'bookSelect': () => NavigationController.handleBookChange(event.target.value),
                    'chapterSelect': () => NavigationController.handleChapterChange(+event.target.value),
                    'paragraphSelect': () => NavigationController.handleParagraphChange(+event.target.value),
                    'displayThai': () => this.saveAndRenderDisplay('displayThai', event.target.checked),
                    'displayEnglish': () => this.saveAndRenderDisplay('displayEnglish', event.target.checked),
                    'displayPersian': () => this.saveAndRenderDisplay('displayPersian', event.target.checked),
                    'speakThai': () => this.saveSpeakSetting('speakThai', event.target.checked),
                    'speakEnglish': () => this.saveSpeakSetting('speakEnglish', event.target.checked),
                    'speakPersian': () => this.saveSpeakSetting('speakPersian', event.target.checked),
                    'playbackDelay': () => this.handlePlaybackDelayChange(event.target),
                    'incorrectOnly': () => this.handleIncorrectOnlyChange(event.target.checked)
                };

                const handler = handlers[event.target.id];
                if (handler) handler();
            },

            handleIncorrectOnlyChange(checked) {
                QuizSystem.incorrectOnly = checked;
                QuizSystem.currentQuestion = 0; // Reset to first question when toggling filter
                QuizSystem.render();
            },

            saveAndRenderDisplay(setting, value) {
                Storage.save(setting, value ? '1' : '0');
                this.renderParagraph();
            },

            saveSpeakSetting(setting, value) {
                Storage.save(setting, value ? '1' : '0');
                // No need to re-render for speak settings, just save
            },

            handlePlaybackDelayChange(input) {
                let value = parseFloat(input.value);
                if (isNaN(value)) value = 0.5;
                value = Math.min(Math.max(value, 0.5), 5.0);
                // Ensure value is valid for the step (0.5, 1.5, 2.5, etc.)
                value = Math.round(value * 2) / 2;
                input.value = value;
                Storage.save('playbackDelay', input.value);
            },

            bindLanguageSettings() {
                const savedQuestionLang = Storage.load('questionLang', 'th');
                const savedAnswerLang = Storage.load('answerLang', 'en');

                const questionRadio = document.querySelector(`input[name="questionLang"][value="${savedQuestionLang}"]`);
                const answerRadio = document.querySelector(`input[name="answerLang"][value="${savedAnswerLang}"]`);

                if (questionRadio) questionRadio.checked = true;
                if (answerRadio) answerRadio.checked = true;

                document.querySelectorAll('input[name="questionLang"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        Storage.save('questionLang', e.target.value);
                        this.renderParagraph();
                    });
                });

                document.querySelectorAll('input[name="answerLang"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        Storage.save('answerLang', e.target.value);
                        this.renderParagraph();
                    });
                });
            },

            restoreSettings() {
                const displayThai = document.getElementById('displayThai');
                const displayEnglish = document.getElementById('displayEnglish');
                const displayPersian = document.getElementById('displayPersian');
                const speakThai = document.getElementById('speakThai');
                const speakEnglish = document.getElementById('speakEnglish');
                const speakPersian = document.getElementById('speakPersian');
                const playbackDelay = document.getElementById('playbackDelay');

                if (displayThai) displayThai.checked = Storage.loadBool('displayThai', true);
                if (displayEnglish) displayEnglish.checked = Storage.loadBool('displayEnglish', false);
                if (displayPersian) displayPersian.checked = Storage.loadBool('displayPersian', false);
                if (speakThai) speakThai.checked = Storage.loadBool('speakThai', true);
                if (speakEnglish) speakEnglish.checked = Storage.loadBool('speakEnglish', false);
                if (speakPersian) speakPersian.checked = Storage.loadBool('speakPersian', false);
                if (playbackDelay) playbackDelay.value = Storage.load('playbackDelay', '0.5'); // Changed from '1.5' to '0.5'
            }
        };

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', () => {
            AppController.initSPA();
            AppController.init();
        });
    </script>
</body>

</html>