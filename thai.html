<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai&family=Chakra+Petch&display=swap"
        rel="stylesheet" />
    <title>ฝึกฝน Thai</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <style>
        /* [All previous CSS remains exactly the same] */
        /* CSS Custom Properties for Theming */
        :root {
            --primary-color: #00247D;
            --primary-light: #66aaff;
            --background-light: #f9f9f9;
            --background-dark: #222;
            --text-light: #000;
            --text-dark: #eee;
            --border-light: #ccc;
            --border-dark: #555;
            --correct-color: #4caf50;
            --incorrect-color: #f44336;
            --highlight-light: yellow;
            --highlight-dark: orange;
            --header-height: 60px;
        }

        /* Base page styling - MOBILE FIRST */
        body {
            font-size: clamp(14px, 2.5vw, 18px);
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            transition: background 0.3s, color 0.3s;
            background: var(--background-light);
            color: var(--text-light);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        body[data-theme="dark"] {
            background: var(--background-dark);
            color: var(--text-dark);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--primary-color);
            color: white;
            padding: 0.5em 1em;
            height: var(--header-height);
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 0;
        }

        /* Scrollable content area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 1em;
            -webkit-overflow-scrolling: touch;
        }

        /* Fixed controls at bottom */
        .controls-area {
            background: var(--background-light);
            border-top: 1px solid var(--border-light);
            padding: 1em;
            flex-shrink: 0;
            position: sticky;
            bottom: 0;
            z-index: 90;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        body[data-theme="dark"] .controls-area {
            background: var(--background-dark);
            border-top-color: var(--border-dark);
        }

        /* Section styling */
        section {
            margin-bottom: 1.5em;
            padding-bottom: 1em;
            border-bottom: 1px solid var(--border-light);
        }

        body[data-theme="dark"] section {
            border-bottom-color: var(--border-dark);
        }

        /* Help block styling */
        details {
            padding: 0.5em 1em;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            margin: 0.5em 0;
            font-size: 0.9em;
            font-weight: normal;
            text-align: left;
            background: var(--background-light);
            color: var(--text-light);
        }

        details summary {
            cursor: pointer;
            color: var(--primary-color);
        }

        body[data-theme="dark"] details {
            background: #2a2a2a;
            border: 1px solid var(--border-dark);
            color: var(--text-dark);
        }

        body[data-theme="dark"] details summary {
            color: var(--primary-light);
        }

        /* Style nested content in details */
        details p {
            margin: 0.5em 0;
            line-height: 1.5;
            text-align: left;
        }

        details ol {
            margin: 0.5em 1.5em;
            padding-left: 1.2em;
        }

        details ol li {
            margin: 0.4em 0;
        }

        /* === Base Styles for Inputs, Selects, Buttons === */
        button,
        select,
        input[type="number"] {
            font-size: 1em;
            line-height: 1.5;
            padding: 0.5em;
            height: 2.5em;
            border-radius: 4px;
            border: 1px solid var(--border-light);
            background: #f0f0f0;
            color: var(--text-light);
            cursor: pointer;
            box-sizing: border-box;
            vertical-align: middle;
            transition: background 0.2s, color 0.2s, border-color 0.2s;
        }

        /* Number input text alignment */
        input[type="number"] {
            text-align: center;
        }

        /* Checkbox styling */
        input[type="checkbox"] {
            width: 1.2em;
            height: 1.2em;
            margin: 0 0.3em 0 0;
            accent-color: var(--primary-color);
            vertical-align: middle;
            cursor: pointer;
        }

        /* Hover states */
        button:hover,
        input[type="number"]:hover,
        select:hover {
            background: #e0e0e0;
        }

        /* Dark theme adjustments */
        body[data-theme="dark"] button,
        body[data-theme="dark"] input[type="number"],
        body[data-theme="dark"] select {
            background: #333;
            border: 1px solid var(--border-dark);
            color: var(--text-dark);
        }

        body[data-theme="dark"] button:hover,
        body[data-theme="dark"] input[type="number"]:hover,
        body[data-theme="dark"] select:hover {
            background: #444;
        }

        body[data-theme="dark"] input[type="checkbox"] {
            accent-color: var(--primary-light);
        }

        /* Theme Toggle Button */
        #themeToggle {
            background: none;
            border: none;
            width: auto;
            min-width: 0;
            padding: 0 0.5em;
            font-size: 1em;
            line-height: 1.5;
        }

        /* Controls container alignment */
        .controls,
        #bookSelectionControls,
        #settingsInline {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5em;
        }

        /* Label alignment */
        label {
            display: flex;
            align-items: center;
            gap: 0.3em;
            font-size: 0.9em;
            white-space: nowrap;
        }

        /* Thai Font Styling */
        .thai-font.tahoma {
            font-family: Tahoma, sans-serif;
        }

        .thai-font.noto {
            font-family: 'Noto Sans Thai', sans-serif;
        }

        .thai-font.chakra {
            font-family: 'Chakra Petch', sans-serif;
        }

        /* Highlighting */
        .highlight-light {
            background: var(--highlight-light);
            color: black;
        }

        .highlight-dark {
            background: var(--highlight-dark);
            color: black;
        }

        #paragraphDisplay {
            margin: 1em 0;
            white-space: pre-wrap;
            width: 100%;
            box-sizing: border-box;
            line-height: 1.6;
            min-height: 150px;
            max-height: 40vh;
            overflow-y: auto;
            padding: 1em;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            background: var(--background-light);
        }

        body[data-theme="dark"] #paragraphDisplay {
            background: #2a2a2a;
            border-color: var(--border-dark);
        }

        :lang(th-TH) {
            font-size: larger;
        }

        :lang(fa-IR) {
            direction: rtl;
        }

        .word-pair {
            display: inline-block;
            vertical-align: top;
            margin: 0 0.3em 0.5em 0;
            cursor: pointer;
            padding: 0.2em;
            border-radius: 3px;
            transition: background-color 0.2s;
        }

        .word-pair:hover {
            background-color: rgba(0, 36, 125, 0.1);
        }

        body[data-theme="dark"] .word-pair:hover {
            background-color: rgba(102, 170, 255, 0.1);
        }

        .word-pair span[lang="th-TH"] {
            display: block;
            word-break: keep-all;
            overflow-wrap: break-word;
            font-size: large;
        }

        .word-pair span[lang="en-US"] {
            border-top: 1px solid lightskyblue;
            display: block;
            word-break: normal;
            overflow-wrap: normal;
            white-space: normal;
            margin-top: 0.1em;
            color: rgb(5, 154, 247);
            font-size: 0.9em;
        }

        .word-pair span[lang="fa-IR"] {
            border-top: 1px solid lightskyblue;
            display: block;
            word-break: keep-all;
            overflow-wrap: break-word;
            direction: rtl;
            color: green;
            font-size: 0.9em;
        }

        /* Quiz styling */
        #quiz {
            margin-top: 1em;
        }

        .quiz-heading {
            font-weight: 600;
            margin-bottom: 0.5em;
        }

        .quiz-question {
            font-size: 1.25rem;
            margin: .1em 0;
            padding: 0.5em;
            background: rgba(0, 36, 125, 0.05);
            border-radius: 5px;
        }

        body[data-theme="dark"] .quiz-question {
            background: rgba(102, 170, 255, 0.1);
        }

        .quiz-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5em;
            margin-top: 0.5em;
        }

        .quiz-option {
            border: 1px solid var(--border-light);
            padding: 0.5em 0.8em;
            cursor: pointer;
            border-radius: 5px;
            user-select: none;
            flex: 1;
            min-width: 120px;
            text-align: center;
            transition: all 0.2s;
        }

        .quiz-option.correct {
            background: var(--correct-color);
            color: white;
            border-color: var(--correct-color);
        }

        .quiz-option.incorrect {
            background: var(--incorrect-color);
            color: white;
            border-color: var(--incorrect-color);
        }

        #quizControls {
            display: flex;
            flex-direction: column;
            gap: 0.8em;
            margin-top: 1em;
        }

        .quiz-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.6em;
        }

        .quiz-row-top {
            justify-content: flex-start;
        }

        .quiz-row-bottom {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.4em;
        }

        @media (min-width: 600px) {
            .quiz-row-bottom {
                flex-direction: row;
                align-items: center;
            }
        }

        .lang-select {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4em 0.8em;
        }

        /* Paragraph controls responsive layout */
        #paragraphControls {
            display: flex;
            flex-direction: column;
            gap: 0.5em;
        }

        .paragraph-controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5em;
            align-items: center;
            justify-content: center;
        }

        /* Mobile-specific adjustments */
        @media (max-width: 600px) {
            #paragraphControls {
                gap: 0.8em;
            }

            .paragraph-controls-row {
                justify-content: center;
            }

            button {
                min-height: 44px;
                min-width: 44px;
            }

            .word-pair {
                margin: 0 0.2em 0.3em 0;
            }

            .quiz-option {
                min-width: 100px;
                padding: 0.6em 0.5em;
            }

            .controls-area {
                padding: 0.8em;
            }

            .content-area {
                padding: 0.8em;
            }

            #paragraphDisplay {
                max-height: 35vh;
                padding: 0.8em;
            }
        }

        /* Desktop adjustments */
        @media (min-width: 768px) {
            .content-area {
                padding: 1.5em;
            }

            .controls-area {
                padding: 1.2em;
            }

            .word-pair {
                margin: 0 0.5em 1em 0;
            }

            #paragraphDisplay {
                max-height: 50vh;
            }
        }

        /* Error and status styling */
        .error-message {
            color: var(--incorrect-color);
            background: #ffe6e6;
            padding: 0.5em;
            border-radius: 4px;
            margin: 0.5em 0;
            border: 1px solid var(--incorrect-color);
        }

        .success-message {
            color: var(--correct-color);
            background: #e6ffe6;
            padding: 0.5em;
            border-radius: 4px;
            margin: 0.5em 0;
            border: 1px solid var(--correct-color);
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Selection controls styling */
        #bookSelectionControls {
            background: rgba(0, 36, 125, 0.05);
            padding: 1em;
            border-radius: 8px;
            margin-bottom: 1em;
        }

        body[data-theme="dark"] #bookSelectionControls {
            background: rgba(102, 170, 255, 0.1);
        }

        /* TTS Status Styles */
        .tts-status-container {
            margin: 1em 0;
            padding: 1em;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .tts-status-success {
            background: #e8f5e8;
            border-left-color: var(--correct-color);
            color: #2d5016;
        }

        .tts-status-error {
            background: #ffeaea;
            border-left-color: var(--incorrect-color);
            color: #8b0000;
        }

        .tts-status-warning {
            background: #fff4e6;
            border-left-color: orange;
            color: #663c00;
        }

        .tts-status-info {
            background: #e8f4fd;
            border-left-color: var(--primary-color);
            color: #004085;
        }

        body[data-theme="dark"] .tts-status-success {
            background: #1a331a;
            color: #90ee90;
        }

        body[data-theme="dark"] .tts-status-error {
            background: #331a1a;
            color: #ff6b6b;
        }

        body[data-theme="dark"] .tts-status-warning {
            background: #332900;
            color: #ffd700;
        }

        body[data-theme="dark"] .tts-status-info {
            background: #1a2833;
            color: #66aaff;
        }

        .tts-setup-steps {
            margin: 1em 0;
            padding: 1em;
            background: var(--background-light);
            border-radius: 8px;
            border: 1px solid var(--border-light);
        }

        body[data-theme="dark"] .tts-setup-steps {
            background: #2a2a2a;
            border-color: var(--border-dark);
        }

        .tts-step {
            margin: 0.5em 0;
            padding: 0.5em;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .tts-language-check {
            display: flex;
            flex-wrap: wrap;
            gap: 1em;
            margin: 1em 0;
        }

        .language-test {
            padding: 0.5em 1em;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .language-test:hover {
            background: var(--primary-light);
        }

        .test-result {
            margin-top: 0.5em;
            font-size: 0.9em;
            opacity: 0.8;
        }

        .success-check {
            color: var(--correct-color);
        }

        .error-cross {
            color: var(--incorrect-color);
        }

        /* Scrollbar styling */
        .content-area::-webkit-scrollbar,
        #paragraphDisplay::-webkit-scrollbar {
            width: 8px;
        }

        .content-area::-webkit-scrollbar-track,
        #paragraphDisplay::-webkit-scrollbar-track {
            background: var(--background-light);
        }

        .content-area::-webkit-scrollbar-thumb,
        #paragraphDisplay::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 4px;
        }

        body[data-theme="dark"] .content-area::-webkit-scrollbar-track,
        body[data-theme="dark"] #paragraphDisplay::-webkit-scrollbar-track {
            background: var(--background-dark);
        }

        body[data-theme="dark"] .content-area::-webkit-scrollbar-thumb,
        body[data-theme="dark"] #paragraphDisplay::-webkit-scrollbar-thumb {
            background: var(--border-dark);
        }
    </style>
</head>

<body data-theme="light">
    <header>
        <span lang="th">ฝึกฝน</span>
        <span id="settingsInline">
            <button id="themeToggle" title="Toggle Day/Night">🌞</button>
            <label>Thai Font:
                <select id="thaiFont">
                    <option value="">Default</option>
                    <option value="Tahoma">Tahoma</option>
                    <option value="Noto Sans Thai">Noto Sans Thai</option>
                    <option value="Chakra Petch">Chakra Petch</option>
                </select>
            </label>
            <button id="settingsBtn" title="Settings & Help">⚙️</button>
        </span>
    </header>

    <main>
        <div class="content-area" id="contentArea">
            <!-- Dynamic content will be inserted here -->
        </div>
        <div class="controls-area" id="controlsArea">
            <!-- Controls will be inserted here -->
        </div>
    </main>

    <script>
        // ==================== MODULARIZED VERSION ====================

        // ========== CORE UTILITIES ==========
        const Storage = {
            save: (key, value) => localStorage.setItem(key, value),
            load: (key, defaultValue = '') => localStorage.getItem(key) || defaultValue,
            loadInt: (key, defaultValue = 0) => parseInt(Storage.load(key, defaultValue), 10),
            loadBool: (key, defaultValue = false) => Storage.load(key, defaultValue ? '1' : '0') === '1'
        };

        // ========== ENHANCED TTS MANAGER ==========
        const TTSManager = {
            supportedVoices: [],
            testResults: {},

            initialize() {
                this.loadVoices();
                speechSynthesis.addEventListener('voiceschanged', () => {
                    this.loadVoices();
                });
            },

            loadVoices() {
                this.supportedVoices = speechSynthesis.getVoices();
            },

            isSupported() {
                return 'speechSynthesis' in window && typeof SpeechSynthesisUtterance !== 'undefined';
            },

            getLanguageVoices(lang) {
                return this.supportedVoices.filter(voice =>
                    voice.lang.startsWith(lang) || voice.lang.includes(lang)
                );
            },

            hasLanguageSupport(lang) {
                return this.getLanguageVoices(lang).length > 0;
            },

            testLanguage(lang, text) {
                return new Promise((resolve) => {
                    if (!this.isSupported()) {
                        resolve({ success: false, error: 'TTS not supported' });
                        return;
                    }

                    if (!this.hasLanguageSupport(lang)) {
                        resolve({ success: false, error: `No ${lang} voices available` });
                        return;
                    }

                    try {
                        const utterance = new SpeechSynthesisUtterance(text);
                        utterance.lang = lang;
                        utterance.volume = 0.7;

                        utterance.onend = () => {
                            resolve({ success: true, voices: this.getLanguageVoices(lang) });
                        };

                        utterance.onerror = (error) => {
                            resolve({ success: false, error: error.error });
                        };

                        speechSynthesis.speak(utterance);
                    } catch (error) {
                        resolve({ success: false, error: error.message });
                    }
                });
            },

            async comprehensiveTest() {
                const tests = [
                    { lang: 'en-US', text: 'Hello, this is English text-to-speech', name: 'English' },
                    { lang: 'th-TH', text: 'สวัสดี นี่คือการทดสอบเสียงพูดภาษาไทย', name: 'Thai' }
                ];

                this.testResults = {};
                let allPassed = true;

                for (const test of tests) {
                    const result = await this.testLanguage(test.lang, test.text);
                    this.testResults[test.lang] = {
                        ...result,
                        name: test.name,
                        text: test.text
                    };

                    if (!result.success) {
                        allPassed = false;
                    }

                    // Small delay between tests
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                return allPassed;
            },

            getSetupInstructions() {
                const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                const isChrome = /Chrome/.test(navigator.userAgent);
                const isSafari = /Safari/.test(navigator.userAgent);

                if (isMobile) {
                    return this.getMobileSetupInstructions(isChrome, isSafari);
                } else {
                    return this.getDesktopSetupInstructions(isChrome, isSafari);
                }
            },

            getMobileSetupInstructions(isChrome, isSafari) {
                let instructions = '';

                if (isChrome) {
                    instructions = `
                        <div class="tts-setup-steps">
                            <h4>Android Chrome Setup:</h4>
                            <div class="tts-step">
                                <strong>1. Install Language Packs:</strong>
                                <p>Go to Settings → Accessibility → Text-to-speech output → Google Text-to-speech engine → Install voice data</p>
                            </div>
                            <div class="tts-step">
                                <strong>2. Download Thai & English:</strong>
                                <p>Install both English and Thai language packs for full functionality</p>
                            </div>
                            <div class="tts-step">
                                <strong>3. Enable in Chrome:</strong>
                                <p>Chrome Settings → Accessibility → Enable "Simplified view for open pages"</p>
                            </div>
                        </div>
                    `;
                } else if (isSafari) {
                    instructions = `
                        <div class="tts-setup-steps">
                            <h4>iOS Safari Setup:</h4>
                            <div class="tts-step">
                                <strong>1. Enable Spoken Content:</strong>
                                <p>Settings → Accessibility → Spoken Content → Enable "Speak Selection"</p>
                            </div>
                            <div class="tts-step">
                                <strong>2. Download Voices:</strong>
                                <p>In Spoken Content → Voices → Download Thai and English voices</p>
                            </div>
                            <div class="tts-step">
                                <strong>3. Test in Safari:</strong>
                                <p>Select any text on a webpage and tap "Speak" to test</p>
                            </div>
                        </div>
                    `;
                }

                return instructions;
            },

            getDesktopSetupInstructions(isChrome, isSafari) {
                let instructions = '';

                if (isChrome) {
                    instructions = `
                        <div class="tts-setup-steps">
                            <h4>Chrome Desktop Setup:</h4>
                            <div class="tts-step">
                                <strong>1. Check System TTS:</strong>
                                <p>Windows: Settings → Ease of Access → Narrator<br>
                                   Mac: System Preferences → Accessibility → Speech</p>
                            </div>
                            <div class="tts-step">
                                <strong>2. Install Languages:</strong>
                                <p>Download Thai and English TTS voices through your operating system</p>
                            </div>
                            <div class="tts-step">
                                <strong>3. Chrome Permissions:</strong>
                                <p>Ensure Chrome has permission to use microphone/TTS features</p>
                            </div>
                        </div>
                    `;
                } else if (isSafari) {
                    instructions = `
                        <div class="tts-setup-steps">
                            <h4>Safari Desktop Setup:</h4>
                            <div class="tts-step">
                                <strong>1. Enable Speech in macOS:</strong>
                                <p>System Preferences → Accessibility → Speech → Enable "Speak selected text"</p>
                            </div>
                            <div class="tts-step">
                                <strong>2. Download Voices:</strong>
                                <p>System Preferences → Accessibility → Speech → System Voice → Customize → Download Thai</p>
                            </div>
                            <div class="tts-step">
                                <strong>3. Safari Settings:</strong>
                                <p>Safari → Preferences → Advanced → Accessibility → Never use font sizes smaller than 10px</p>
                            </div>
                        </div>
                    `;
                }

                return instructions;
            },

            getStatusMessage() {
                if (!this.isSupported()) {
                    return {
                        type: 'error',
                        title: 'Text-to-Speech Not Supported',
                        message: 'Your browser does not support the Web Speech API. Please use Chrome, Safari, or Edge for the best experience.'
                    };
                }

                const hasEnglish = this.hasLanguageSupport('en');
                const hasThai = this.hasLanguageSupport('th');

                if (!hasEnglish && !hasThai) {
                    return {
                        type: 'error',
                        title: 'No Language Voices Available',
                        message: 'No English or Thai TTS voices found. You need to install language packs.'
                    };
                }

                if (!hasThai) {
                    return {
                        type: 'warning',
                        title: 'Thai Language Missing',
                        message: 'English TTS works, but Thai voices are not available. Install Thai language pack for full functionality.'
                    };
                }

                if (!hasEnglish) {
                    return {
                        type: 'warning',
                        title: 'English Language Missing',
                        message: 'Thai TTS works, but English voices are not available. Install English language pack for complete features.'
                    };
                }

                return {
                    type: 'success',
                    title: 'TTS Ready for Language Learning',
                    message: 'Both English and Thai text-to-speech are available and ready for your language practice!'
                };
            },

            speak(text, lang, onEnd) {
                if (!text) return;
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;
                if (onEnd) utterance.onend = onEnd;
                speechSynthesis.speak(utterance);
            },

            cancel() {
                speechSynthesis.cancel();
            },

            pause() {
                speechSynthesis.pause();
            }
        };

        // Initialize TTS Manager when page loads
        TTSManager.initialize();

        // ========== APPLICATION STATE ==========
        const AppState = {
            books: [],
            currentBook: null,
            currentChapter: 0,
            currentParagraph: 0,
            isPlaying: false,
            currentWordIndex: 0,
            lastHighlightedIndex: null,

            initialize() {
                this.currentBook = Storage.load('currentBook', '');
                this.currentChapter = Storage.loadInt('currentChapter', 0);
                this.currentParagraph = Storage.loadInt('currentParagraph', 0);
            },

            saveNavigation() {
                Storage.save('currentChapter', this.currentChapter);
                Storage.save('currentParagraph', this.currentParagraph);
            },

            getCurrentParagraph() {
                return this.currentBook?.chapters?.[this.currentChapter]?.paragraphs?.[this.currentParagraph] || [];
            }
        };

        // ========== UI COMPONENTS ==========
        const ThemeManager = {
            init() {
                const themeToggle = document.getElementById('themeToggle');
                themeToggle.addEventListener('click', () => this.toggle());
                this.set(Storage.load('theme', 'light'));
            },

            set(theme) {
                document.body.dataset.theme = theme;
                document.getElementById('themeToggle').textContent = theme === 'light' ? '🌞' : '🌙';
                Storage.save('theme', theme);
            },

            toggle() {
                this.set(document.body.dataset.theme === 'light' ? 'dark' : 'light');
            }
        };

        const FontManager = {
            init() {
                const thaiFont = document.getElementById('thaiFont');
                thaiFont.value = Storage.load('thaiFont', '');
                thaiFont.addEventListener('change', (e) => {
                    Storage.save('thaiFont', e.target.value);
                    this.apply();
                });
                this.apply();
            },

            apply() {
                const font = Storage.load('thaiFont', '');
                document.querySelectorAll('[lang="th"], [lang="th-TH"]').forEach(el => {
                    el.classList.add('thai-font');
                    el.classList.remove('tahoma', 'noto', 'chakra');
                    if (font === 'Tahoma') el.classList.add('tahoma');
                    if (font === 'Noto Sans Thai') el.classList.add('noto');
                    if (font === 'Chakra Petch') el.classList.add('chakra');
                });
            }
        };

        // ========== SETTINGS MANAGER ==========
        // ========== SETTINGS MANAGER ==========
        const SettingsManager = {
            show() {
                const contentArea = document.getElementById('contentArea');
                const controlsArea = document.getElementById('controlsArea');
                contentArea.innerHTML = this.getSettingsHTML();
                controlsArea.innerHTML = '';
                this.bindSettingsEvents();

                // Show initial TTS status
                this.showInitialTTSStatus();
            },

            getSettingsHTML() {
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center;
                                background: #00247D; color: white; padding: 0.5em 1em; border-radius: 8px;">
                        <h2 style="margin: 0;">Settings & Help</h2>
                        <button id="closeX" style="background: #666; color: white; border: none; padding: 0.5em; border-radius: 4px; cursor: pointer;">❌</button>
                    </div>
                    
                    <div class="settings-content" style="padding: 1em;">
                        <div class="settings-section">
                            <h3>Text-to-Speech Setup</h3>
                            <p>This app uses Text-to-Speech (TTS) to help you learn pronunciation in both Thai and English. 
                               Please test your setup and follow the instructions if needed.</p>
                            
                            <button id="checkTTS" class="settings-button" style="padding: 0.8em 1.5em; background: #00247D; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 1em 0;">
                                🔊 Test TTS Setup & Language Support
                            </button>
                            
                            <div id="ttsStatus"></div>
                            <div id="ttsSetupInstructions"></div>
                            <div id="languageTests"></div>
                        </div>
                        
                        <div style="margin-top: 2em; padding-top: 1em; border-top: 1px solid var(--border-light);">
                            <button id="closeBtn" style="padding: 0.6em 1.2em; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">Close Settings</button>
                        </div>
                    </div>`;
            },

            bindSettingsEvents() {
                document.getElementById('closeX').addEventListener('click', this.close);
                document.getElementById('closeBtn').addEventListener('click', this.close);
                document.getElementById('checkTTS').addEventListener('click', () => this.performTTSCheck());
            },

            close() {
                // Clear any errors and reload the main app view
                const contentArea = document.getElementById('contentArea');
                const controlsArea = document.getElementById('controlsArea');

                // Reset to main app view
                contentArea.innerHTML = AppController.getMainHTML();
                controlsArea.innerHTML = AppController.getControlsHTML();

                // Re-initialize the app components
                AppController.bindUIElements();
                AppController.restoreSettings();

                // Re-populate the book list and restore current selection
                AppController.reloadBookList();
            },

            showInitialTTSStatus() {
                const status = TTSManager.getStatusMessage();
                this.showTTSStatus(status);

                // Show setup instructions for common issues
                if (status.type !== 'success') {
                    const instructions = TTSManager.getSetupInstructions();
                    document.getElementById('ttsSetupInstructions').innerHTML = instructions;
                }
            },

            async performTTSCheck() {
                const ttsStatus = document.getElementById('ttsStatus');
                const checkBtn = document.getElementById('checkTTS');
                const languageTests = document.getElementById('languageTests');

                checkBtn.innerHTML = '🔄 Testing TTS...';
                checkBtn.disabled = true;
                ttsStatus.innerHTML = '';
                languageTests.innerHTML = '';

                // Show initial system status
                const status = TTSManager.getStatusMessage();
                this.showTTSStatus(status);

                // Perform comprehensive test
                const testPassed = await TTSManager.comprehensiveTest();

                // Show detailed test results
                this.showLanguageTestResults();

                // Show setup instructions if needed
                if (!testPassed) {
                    const instructions = TTSManager.getSetupInstructions();
                    document.getElementById('ttsSetupInstructions').innerHTML = instructions;
                }

                checkBtn.innerHTML = '✅ TTS Test Complete';
                checkBtn.disabled = false;

                // Update status based on test results
                const finalStatus = TTSManager.getStatusMessage();
                this.showTTSStatus(finalStatus);
            },

            showTTSStatus(status) {
                const ttsStatus = document.getElementById('ttsStatus');
                const statusClass = `tts-status-${status.type === 'warning' ? 'info' : status.type}`;

                ttsStatus.innerHTML = `
                    <div class="tts-status-container ${statusClass}">
                        <h4 style="margin: 0 0 0.5em 0;">${status.title}</h4>
                        <p style="margin: 0;">${status.message}</p>
                    </div>
                `;
            },

            showLanguageTestResults() {
                const languageTests = document.getElementById('languageTests');
                const results = TTSManager.testResults;

                if (Object.keys(results).length === 0) return;

                let html = `<h4>Language Test Results:</h4><div class="tts-language-check">`;

                for (const [lang, result] of Object.entries(results)) {
                    const icon = result.success ? '✅' : '❌';
                    const resultClass = result.success ? 'success-check' : 'error-cross';
                    const voices = result.voices ? result.voices.map(v => v.name).join(', ') : 'No voices';

                    html += `
                        <div style="flex: 1; min-width: 200px; padding: 1em; background: rgba(0,0,0,0.05); border-radius: 8px;">
                            <div style="font-weight: bold;">${icon} ${result.name}</div>
                            <div class="test-result ${resultClass}">
                                ${result.success ?
                            `Working - ${voices}` :
                            `Failed: ${result.error}`
                        }
                            </div>
                            <button onclick="testSingleLanguage('${lang}', '${result.text}')" 
                                    class="language-test" 
                                    style="margin-top: 0.5em;">
                                Test ${result.name} Again
                            </button>
                        </div>
                    `;
                }

                html += `</div>`;
                languageTests.innerHTML = html;
            }
        };

        // Global function for testing individual languages
        window.testSingleLanguage = async function (lang, text) {
            const result = await TTSManager.testLanguage(lang, text);
            alert(`${lang === 'en-US' ? 'English' : 'Thai'} TTS Test: ${result.success ? 'SUCCESS' : 'FAILED'}\n${result.success ? 'Voice is working properly' : 'Error: ' + result.error}`);
        };

        // ========== BOOK MANAGEMENT ==========
        const BookManager = {
            async loadBookList() {
                try {
                    const res = await fetch('/assets/books/bookList.json');
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    return await res.json();
                } catch (error) {
                    console.error('Error loading book list:', error);
                    return [];
                }
            },

            async loadBook(filename) {
                try {
                    const res = await fetch(`/assets/books/${filename}`);
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    return await res.json();
                } catch (error) {
                    console.error('Error loading book:', error);
                    throw error;
                }
            }
        };

        // ========== PARAGRAPH RENDERING ==========
        const ParagraphRenderer = {
            display: null,

            init(displayElement) {
                this.display = displayElement;
            },

            render(paragraph) {
                if (!this.display) return;
                this.display.innerHTML = '';

                if (!paragraph || paragraph.length === 0) {
                    this.display.textContent = 'No paragraph content available.';
                    return;
                }

                paragraph.forEach((word, index) => {
                    this.renderWord(word, index);
                });

                FontManager.apply();
            },

            renderWord(word, index) {
                // Handle newlines
                if (this.isNewline(word)) {
                    this.display.appendChild(document.createElement('br'));
                    return;
                }

                // Use the original working approach
                function buildLanguages(thText, enText, faText, wordIndex) {
                    const pairDiv = document.createElement('div');
                    pairDiv.className = 'word-pair';
                    pairDiv.dataset.index = wordIndex;

                    if (document.getElementById('showThai')?.checked && thText) {
                        const thSpan = document.createElement('span');
                        thSpan.textContent = thText;
                        thSpan.lang = 'th-TH';
                        thSpan.dataset.index = wordIndex;
                        thSpan.onclick = () => PlaybackController.playWord(thText, 'th-TH', thSpan, wordIndex);
                        pairDiv.appendChild(thSpan);
                    }

                    if (document.getElementById('showEnglish')?.checked && enText) {
                        const enSpan = document.createElement('span');
                        enSpan.textContent = enText;
                        enSpan.lang = 'en-US';
                        enSpan.dataset.index = wordIndex;
                        enSpan.onclick = () => PlaybackController.playWord(enText, 'en-US', enSpan, wordIndex);
                        pairDiv.appendChild(enSpan);
                    }

                    if (document.getElementById('showPersian')?.checked && faText) {
                        const faSpan = document.createElement('span');
                        faSpan.textContent = faText;
                        faSpan.lang = 'fa-IR';
                        faSpan.dataset.index = wordIndex;
                        faSpan.onclick = () => PlaybackController.playWord(faText, 'fa-IR', faSpan, wordIndex);
                        pairDiv.appendChild(faSpan);
                    }

                    this.display.appendChild(pairDiv);
                }

                const thParts = (word.th || '').split('\n');
                const enParts = (word.en || '').split('\n');
                const faParts = (word.fa || '').split('\n');
                const maxParts = Math.max(thParts.length, enParts.length, faParts.length);

                for (let p = 0; p < maxParts; p++) {
                    const thPart = thParts[p] || '';
                    const enPart = enParts[p] || '';
                    const faPart = faParts[p] || '';

                    if (!thPart && !enPart && !faPart) continue;

                    buildLanguages.call(this, thPart, enPart, faPart, index);

                    if (p < maxParts - 1) {
                        this.display.appendChild(document.createElement('br'));
                    }
                }
            },

            isNewline(word) {
                return word.th === "\n" && word.en === "\n" && word.fa === "\n";
            },

            clearHighlights() {
                if (!this.display) return;
                this.display.querySelectorAll('span').forEach(span => {
                    span.classList.remove('highlight-light', 'highlight-dark');
                });
            },

            highlightElement(element, index) {
                this.clearHighlights();
                if (element) {
                    const themeClass = document.body.dataset.theme === 'dark' ? 'highlight-dark' : 'highlight-light';
                    element.classList.add(themeClass);
                    AppState.lastHighlightedIndex = index;

                    // Scroll to highlighted element
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        };

        // ========== PLAYBACK CONTROLLER ==========
        const PlaybackController = {
            async playParagraph() {
                if (AppState.isPlaying) return;

                const paragraph = AppState.getCurrentParagraph();
                if (!paragraph || paragraph.length === 0) return;

                AppState.isPlaying = true;
                AppState.currentWordIndex = 0;
                await this.speakNextWord();
            },

            pauseParagraph() {
                AppState.isPlaying = false;
                TTSManager.cancel();
            },

            restartParagraph() {
                this.pauseParagraph();
                ParagraphRenderer.clearHighlights();
                AppState.currentWordIndex = 0;
                this.playParagraph();
            },

            async speakNextWord() {
                const paragraph = AppState.getCurrentParagraph();
                if (!AppState.isPlaying || !paragraph || AppState.currentWordIndex >= paragraph.length) {
                    AppState.isPlaying = false;
                    return;
                }

                const word = paragraph[AppState.currentWordIndex];
                if (!word || this.isNewline(word)) {
                    AppState.currentWordIndex++;
                    await this.speakNextWord();
                    return;
                }

                if (AppState.isPlaying) ParagraphRenderer.clearHighlights();

                const delay = this.getPlaybackDelay();
                const showThai = document.getElementById('showThai')?.checked;
                const showEnglish = document.getElementById('showEnglish')?.checked;
                const showPersian = document.getElementById('showPersian')?.checked;

                if (showThai && word.th && word.th !== "\n") {
                    await this.speakWord(word.th, 'th-TH', AppState.currentWordIndex, true);
                }

                if (showEnglish && word.en && word.en !== "\n") {
                    await this.speakWord(word.en, 'en-US', AppState.currentWordIndex, true);
                }

                if (showPersian && word.fa && word.fa !== "\n") {
                    await this.speakWord(word.fa, 'fa-IR', AppState.currentWordIndex, true);
                }

                AppState.currentWordIndex++;
                setTimeout(() => { if (AppState.isPlaying) this.speakNextWord(); }, delay);
            },

            async speakWord(text, lang, index, autoAdvance = false) {
                return new Promise(resolve => {
                    if (!text || text === "\n") {
                        resolve();
                        return;
                    }

                    const pairDiv = ParagraphRenderer.display?.querySelector(`.word-pair[data-index="${index}"]`);
                    const span = pairDiv ? pairDiv.querySelector(`span[lang="${lang}"]`) : null;

                    if (span) {
                        ParagraphRenderer.highlightElement(span, index);
                    }

                    TTSManager.speak(text, lang, () => {
                        if (autoAdvance && AppState.isPlaying && span) {
                            span.classList.remove('highlight-light', 'highlight-dark');
                        }
                        resolve();
                    });
                });
            },

            playWord(text, lang, span, index) {
                if (!text || text === "\n") return;
                ParagraphRenderer.highlightElement(span, index);
                TTSManager.cancel();
                this.speakWord(text, lang, index, false);
            },

            isNewline(word) {
                return word.th === "\n" && word.en === "\n" && word.fa === "\n";
            },

            getPlaybackDelay() {
                const delaySec = parseFloat(document.getElementById('playbackDelay')?.value || Storage.load('playbackDelay', '1500'));
                return Math.min(Math.max(isNaN(delaySec) ? 1500 : delaySec, 500), 5000);
            }
        };

        // ========== QUIZ SYSTEM ==========
        const QuizSystem = {
            data: [],
            currentQuestion: 0,
            score: 0,
            attempts: 0,

            buildFromParagraph(paragraph) {
                this.data = paragraph.map(word => ({
                    ...word,
                    attempted: false,
                    correct: false
                }));
                this.currentQuestion = 0;
                this.score = 0;
                this.attempts = 0;
                this.render();
            },

            render() {
                const quizContainer = document.getElementById("quiz");
                if (!quizContainer) return;

                quizContainer.innerHTML = "";

                if (!this.data.length) {
                    quizContainer.textContent = "No quiz available for this paragraph.";
                    return;
                }

                const question = this.data[this.currentQuestion];
                const questionLang = document.querySelector('input[name="questionLang"]:checked')?.value;
                const answerLang = document.querySelector('input[name="answerLang"]:checked')?.value;

                if (!this.validateLanguages(questionLang, answerLang, quizContainer)) return;

                this.renderQuestion(question, questionLang, quizContainer);
                this.renderOptions(question, answerLang, quizContainer);
                FontManager.apply();
            },

            validateLanguages(questionLang, answerLang, container) {
                if (!questionLang || !answerLang) {
                    container.textContent = "Select both Question and Answer languages.";
                    return false;
                }
                if (questionLang === answerLang) {
                    container.textContent = "Answer language must be different from Question.";
                    return false;
                }
                return true;
            },

            renderQuestion(question, questionLang, container) {
                const questionEl = document.createElement("div");
                questionEl.className = "quiz-question";
                questionEl.textContent = question[questionLang] || "";
                questionEl.lang = this.getLangCode(questionLang);
                questionEl.style.cursor = "pointer";
                questionEl.addEventListener("click", () => {
                    TTSManager.speak(question[questionLang], this.getLangCode(questionLang));
                });
                container.appendChild(questionEl);
            },

            renderOptions(question, answerLang, container) {
                const options = this.generateOptions(question, answerLang);
                const optionsContainer = document.createElement("div");
                optionsContainer.className = "quiz-options";

                options.forEach(option => {
                    const optionEl = this.createOptionElement(option, answerLang, question);
                    optionsContainer.appendChild(optionEl);
                });

                container.appendChild(optionsContainer);
            },

            generateOptions(question, answerLang) {
                const correctAnswer = question[answerLang];
                let options = this.data
                    .map(q => q[answerLang])
                    .filter((val, idx, arr) => arr.indexOf(val) === idx && val)
                    .filter(opt => opt !== correctAnswer)
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 3);

                options = [correctAnswer, ...options].sort(() => Math.random() - 0.5);
                return options;
            },

            createOptionElement(option, answerLang, question) {
                const optionEl = document.createElement("div");
                optionEl.lang = this.getLangCode(answerLang);
                optionEl.className = "quiz-option";
                optionEl.textContent = option;

                optionEl.addEventListener("click", () => {
                    TTSManager.speak(option, this.getLangCode(answerLang));
                    this.handleAnswer(optionEl, option, question[answerLang], question);
                });

                return optionEl;
            },

            handleAnswer(optionEl, selectedAnswer, correctAnswer, question) {
                if (selectedAnswer === correctAnswer) {
                    if (!question.correct) {
                        optionEl.classList.add("correct");
                        this.score++;
                        question.correct = true;
                        question.attempted = true;
                        this.attempts++;
                    }
                } else {
                    optionEl.classList.add("incorrect");
                    question.correct = false;
                    question.attempted = true;
                    this.attempts++;
                }

                document.getElementById("score").textContent = `Score: ${this.score}/${this.attempts}`;
            },

            getLangCode(lang) {
                const codes = { th: 'th-TH', en: 'en-US', fa: 'fa-IR' };
                return codes[lang] || 'th-TH';
            },

            nextQuestion() {
                this.currentQuestion++;
                this.render();
            },

            previousQuestion() {
                this.currentQuestion = Math.max(0, this.currentQuestion - 1);
                this.resetQuestionStates();
                this.render();
            },

            retry() {
                this.resetQuestionStates();
                this.render();
            },

            resetQuestionStates() {
                this.data.forEach(question => {
                    question.attempted = false;
                    question.correct = false;
                });
            }
        };

        // ========== NAVIGATION CONTROLLER ==========
        const NavigationController = {
            bookSelect: null,
            chapterSelect: null,
            paragraphSelect: null,

            init(bookSelect, chapterSelect, paragraphSelect) {
                this.bookSelect = bookSelect;
                this.chapterSelect = chapterSelect;
                this.paragraphSelect = paragraphSelect;
            },

            async handleBookChange(bookFilename) {
                Storage.save('currentBook', bookFilename);
                await AppController.loadBook(bookFilename);
            },

            handleChapterChange(chapterIndex) {
                AppState.currentChapter = chapterIndex;
                AppController.populateParagraphs();
            },

            handleParagraphChange(paragraphIndex) {
                AppState.currentParagraph = paragraphIndex;
                AppController.loadParagraph();
            },

            nextParagraph() {
                const max = AppState.currentBook?.chapters?.[AppState.currentChapter]?.paragraphs?.length || 0;
                if (AppState.currentParagraph < max - 1) {
                    AppState.currentParagraph++;
                    this.paragraphSelect.value = AppState.currentParagraph;
                    AppController.loadParagraph();
                }
            },

            previousParagraph() {
                if (AppState.currentParagraph > 0) {
                    AppState.currentParagraph--;
                    this.paragraphSelect.value = AppState.currentParagraph;
                    AppController.loadParagraph();
                }
            }
        };

        // ========== MAIN APPLICATION CONTROLLER ==========
        const AppController = {
            async init() {
                AppState.initialize();
                ThemeManager.init();
                FontManager.init();
                this.setupEventListeners();
                await this.loadBooks();
            },

            setupEventListeners() {
                document.getElementById('settingsBtn').addEventListener('click', () => SettingsManager.show());
            },

            async loadBooks() {
                const bookList = await BookManager.loadBookList();
                this.populateBookSelect(bookList);

                if (bookList.length > 0) {
                    // Use the filename, not the book object
                    const currentBookFilename = Storage.load('currentBook', bookList[0].bookFilename);
                    await this.loadBook(currentBookFilename);
                }
            },

            async reloadBookList() {
                const bookList = await BookManager.loadBookList();
                this.populateBookSelect(bookList);

                // Restore the current book selection
                const currentBookFilename = Storage.load('currentBook');
                if (currentBookFilename && AppState.currentBook) {
                    // If we already have book data, just update the select and repopulate chapters/paragraphs
                    const bookSelect = document.getElementById('bookSelect');
                    if (bookSelect) {
                        bookSelect.value = currentBookFilename;
                    }
                    this.populateChapters();
                } else if (bookList.length > 0) {
                    // Otherwise load the first book or saved book
                    const bookToLoad = currentBookFilename || bookList[0].bookFilename;
                    await this.loadBook(bookToLoad);
                }
            },

            populateBookSelect(bookList) {
                const bookSelect = document.getElementById('bookSelect');
                if (!bookSelect) return;

                bookSelect.innerHTML = '';

                if (bookList.length === 0) {
                    bookSelect.innerHTML = '<option>No books available</option>';
                    bookSelect.disabled = true;
                    return;
                }

                bookList.forEach(book => {
                    const option = document.createElement('option');
                    option.value = book.bookFilename;
                    option.textContent = book.bookTitle;
                    bookSelect.appendChild(option);
                });

                const savedBook = Storage.load('currentBook', bookList[0].bookFilename);
                bookSelect.value = savedBook;
                bookSelect.disabled = false;
            },

            async loadBook(filename) {
                try {
                    const bookData = await BookManager.loadBook(filename);
                    AppState.currentBook = bookData; // Store the book data object
                    Storage.save('currentBook', filename); // Store the filename
                    this.populateChapters();
                } catch (error) {
                    console.error('Error loading book:', error);
                    const contentArea = document.getElementById('contentArea');
                    if (contentArea) {
                        contentArea.innerHTML =
                            `<div class="error-message">Error loading book: ${error.message}. Please check that the book file exists at /assets/books/${filename}</div>`;
                    }
                }
            },

            populateChapters() {
                const chapterSelect = document.getElementById('chapterSelect');
                if (!chapterSelect) return;

                chapterSelect.innerHTML = '';

                if (!AppState.currentBook?.chapters?.length) {
                    chapterSelect.innerHTML = '<option>No chapters available</option>';
                    chapterSelect.disabled = true;
                    return;
                }

                AppState.currentBook.chapters.forEach((chapter, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = chapter.chapterTitle || `Chapter ${index + 1}`;
                    chapterSelect.appendChild(option);
                });

                AppState.currentChapter = Math.min(AppState.currentChapter, AppState.currentBook.chapters.length - 1);
                chapterSelect.value = AppState.currentChapter;
                chapterSelect.disabled = false;
                this.populateParagraphs();
            },

            populateParagraphs() {
                const paragraphSelect = document.getElementById('paragraphSelect');
                if (!paragraphSelect) return;

                paragraphSelect.innerHTML = '';

                const currentChapter = AppState.currentBook?.chapters?.[AppState.currentChapter];
                if (!currentChapter?.paragraphs?.length) {
                    paragraphSelect.innerHTML = '<option>No paragraphs available</option>';
                    paragraphSelect.disabled = true;
                    return;
                }

                currentChapter.paragraphs.forEach((paragraph, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `Paragraph ${index + 1}`;
                    paragraphSelect.appendChild(option);
                });

                AppState.currentParagraph = Math.min(AppState.currentParagraph, currentChapter.paragraphs.length - 1);
                paragraphSelect.value = AppState.currentParagraph;
                paragraphSelect.disabled = false;
                this.loadParagraph();
            },

            loadParagraph() {
                AppState.saveNavigation();
                this.renderParagraph();
            },

            renderParagraph() {
                const paragraph = AppState.getCurrentParagraph();
                ParagraphRenderer.render(paragraph);
                QuizSystem.buildFromParagraph(paragraph);
            },

            reload() {
                this.initSPA();
                this.loadBooks();
            },

            initSPA() {
                const contentArea = document.getElementById('contentArea');
                const controlsArea = document.getElementById('controlsArea');

                if (!contentArea || !controlsArea) return;

                contentArea.innerHTML = this.getMainHTML();
                controlsArea.innerHTML = this.getControlsHTML();

                this.bindUIElements();
                this.restoreSettings();
            },

            getMainHTML() {
                return `
                    <section id="bookSelectionControls" class="controls">
                        <label>Book: <select id="bookSelect"></select></label>
                        <label>Chapter: <select id="chapterSelect"></select></label>
                        <label>Paragraph: <select id="paragraphSelect"></select></label>
                    </section>
                    
                    <section id="paragraphSec">
                        <h3>Paragraph Content</h3>
                        <div id="paragraphDisplay"></div>
                        <div id="paragraphControls" class="controls">
                            <div class="paragraph-controls-row">
                                <button id="playBtn">▶️</button>
                                <button id="pauseBtn">⏸️</button>
                                <button id="restartBtn">⏮️</button>
                                <button id="prevParagraph">⬅️</button>
                                <button id="nextParagraph">➡️</button>
                            </div>
                            <div class="paragraph-controls-row">
                                <label><input type="checkbox" id="showThai" checked> Thai</label>
                                <label><input type="checkbox" id="showEnglish"> English</label>
                                <label><input type="checkbox" id="showPersian"> Persian</label>
                                <label>Delay: <input type="number" id="playbackDelay" value="1500" min="500" max="5000" step="100"></label>
                            </div>
                        </div>
                    </section>
                    
                    <section id="quizSec">
                        <h3>Practice Quiz</h3>
                        <div id="quiz"></div>
                        <div id="quizControls">
                            <div class="quiz-row quiz-row-top">
                                <button id="prevQ">⬅️</button>
                                <button id="nextQ">➡️</button>
                                <button id="retryQuiz">🔄</button>
                                <label><input type="checkbox" id="incorrectOnly"> Incorrect Only</label>
                                <div id="score">Score: 0/0</div>
                            </div>
                            <div class="quiz-row quiz-row-bottom">
                                <div class="lang-select">
                                    <span>Question: </span>
                                    <label><input type="radio" name="questionLang" id="questionThai" value="th" checked> Thai</label>
                                    <label><input type="radio" name="questionLang" id="questionEnglish" value="en"> English</label>
                                    <label><input type="radio" name="questionLang" id="questionPersian" value="fa"> Persian</label>
                                </div>
                                <div class="lang-select">
                                    <span>Answer: </span>
                                    <label><input type="radio" name="answerLang" id="answerThai" value="th"> Thai</label>
                                    <label><input type="radio" name="answerLang" id="answerEnglish" value="en" checked> English</label>
                                    <label><input type="radio" name="answerLang" id="answerPersian" value="fa"> Persian</label>
                                </div>
                            </div>
                        </div>
                    </section>`;
            },

            getControlsHTML() {
                return ``; // Empty controls area - all controls are in main content
            },

            bindUIElements() {
                // Initialize component references
                ParagraphRenderer.init(document.getElementById('paragraphDisplay'));
                NavigationController.init(
                    document.getElementById('bookSelect'),
                    document.getElementById('chapterSelect'),
                    document.getElementById('paragraphSelect')
                );

                // Event delegation for dynamic elements
                document.addEventListener('change', (e) => {
                    this.handleSettingChange(e);
                });

                // Playback controls
                document.getElementById('playBtn')?.addEventListener('click', () => PlaybackController.playParagraph());
                document.getElementById('pauseBtn')?.addEventListener('click', () => PlaybackController.pauseParagraph());
                document.getElementById('restartBtn')?.addEventListener('click', () => PlaybackController.restartParagraph());
                document.getElementById('nextParagraph')?.addEventListener('click', () => NavigationController.nextParagraph());
                document.getElementById('prevParagraph')?.addEventListener('click', () => NavigationController.previousParagraph());

                // Quiz controls
                document.getElementById('prevQ')?.addEventListener('click', () => QuizSystem.previousQuestion());
                document.getElementById('nextQ')?.addEventListener('click', () => QuizSystem.nextQuestion());
                document.getElementById('retryQuiz')?.addEventListener('click', () => QuizSystem.retry());

                // Language settings
                this.bindLanguageSettings();
            },

            handleSettingChange(event) {
                const handlers = {
                    'bookSelect': () => NavigationController.handleBookChange(event.target.value),
                    'chapterSelect': () => NavigationController.handleChapterChange(+event.target.value),
                    'paragraphSelect': () => NavigationController.handleParagraphChange(+event.target.value),
                    'showThai': () => this.saveAndRender('showThai', event.target.checked),
                    'showEnglish': () => this.saveAndRender('showEnglish', event.target.checked),
                    'showPersian': () => this.saveAndRender('showPersian', event.target.checked),
                    'playbackDelay': () => this.handlePlaybackDelayChange(event.target)
                };

                const handler = handlers[event.target.id];
                if (handler) handler();
            },

            saveAndRender(setting, value) {
                Storage.save(setting, value ? '1' : '0');
                this.renderParagraph();
            },

            handlePlaybackDelayChange(input) {
                let value = parseFloat(input.value);
                if (isNaN(value)) value = 1500;
                value = Math.min(Math.max(value, 500), 5000);
                input.value = value;
                Storage.save('playbackDelay', input.value);
            },

            bindLanguageSettings() {
                const savedQuestionLang = Storage.load('questionLang', 'th');
                const savedAnswerLang = Storage.load('answerLang', 'en');

                const questionRadio = document.querySelector(`input[name="questionLang"][value="${savedQuestionLang}"]`);
                const answerRadio = document.querySelector(`input[name="answerLang"][value="${savedAnswerLang}"]`);

                if (questionRadio) questionRadio.checked = true;
                if (answerRadio) answerRadio.checked = true;

                document.querySelectorAll('input[name="questionLang"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        Storage.save('questionLang', e.target.value);
                        this.renderParagraph();
                    });
                });

                document.querySelectorAll('input[name="answerLang"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        Storage.save('answerLang', e.target.value);
                        this.renderParagraph();
                    });
                });
            },

            restoreSettings() {
                const showThai = document.getElementById('showThai');
                const showEnglish = document.getElementById('showEnglish');
                const showPersian = document.getElementById('showPersian');
                const playbackDelay = document.getElementById('playbackDelay');

                if (showThai) showThai.checked = Storage.loadBool('showThai', true);
                if (showEnglish) showEnglish.checked = Storage.loadBool('showEnglish', false);
                if (showPersian) showPersian.checked = Storage.loadBool('showPersian', false);
                if (playbackDelay) playbackDelay.value = Storage.load('playbackDelay', '1500');
            }
        };

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', () => {
            AppController.initSPA();
            AppController.init();
        });
    </script>
</body>

</html>